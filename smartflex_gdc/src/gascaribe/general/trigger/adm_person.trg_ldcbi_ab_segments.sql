CREATE OR REPLACE TRIGGER ADM_PERSON.TRG_LDCBI_AB_SEGMENTS
AFTER INSERT OR UPDATE OR DELETE ON AB_SEGMENTS

REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW

DECLARE

ID_SEGMENTS NUMBER(15);
IS_DELETE VARCHAR2(1);

BEGIN

IF DELETING THEN
  ID_SEGMENTS := :old.SEGMENTS_ID;
  IS_DELETE := 'Y';
ELSE
  ID_SEGMENTS := :new.SEGMENTS_ID;
  IS_DELETE := 'N';
END IF;

INSERT INTO LDCBI_PR_PRODUCT ( PRODUCT_ID, IS_DELETE )
SELECT P.PRODUCT_ID, IS_DELETE
FROM OPEN.PR_PRODUCT P
INNER JOIN OPEN.AB_ADDRESS A ON A.ADDRESS_ID = P.ADDRESS_ID
WHERE A.SEGMENT_ID = ID_SEGMENTS
;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EX.CONTROLLED_ERROR;
END;
/
