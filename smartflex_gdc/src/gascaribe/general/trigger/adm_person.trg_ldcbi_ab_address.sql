CREATE OR REPLACE TRIGGER ADM_PERSON.TRG_LDCBI_AB_ADDRESS
AFTER INSERT OR UPDATE OR DELETE ON AB_ADDRESS

REFERENCING OLD AS OLD NEW AS NEW
FOR EACH ROW

DECLARE

ID_ADDRESS NUMBER(15);
IS_DELETE VARCHAR2(1);

BEGIN

IF DELETING THEN
  ID_ADDRESS := :old.ADDRESS_ID;
  IS_DELETE := 'Y';
ELSE
  ID_ADDRESS := :new.ADDRESS_ID;
  IS_DELETE := 'N';
END IF;

INSERT INTO OPEN.LDCBI_AB_ADDRESS (
  ADDRESS_ID,
  IS_DELETE
)
VALUES (
  ID_ADDRESS,
  IS_DELETE
);

INSERT INTO LDCBI_PR_PRODUCT ( PRODUCT_ID, IS_DELETE )
SELECT P.PRODUCT_ID, IS_DELETE
FROM OPEN.PR_PRODUCT P
WHERE P.ADDRESS_ID = ID_ADDRESS
;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EX.CONTROLLED_ERROR;
END;
/
