column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99237684,99229759,99282762,99292950,98841363,98997150,99300568,99301609,99143959,99293743,99299282,98968284,99285373,99285442,99113570,99300147,99212560,99187676,99226434,99297533,99114547,99227163,99175122,99298924,99294152,99229291,99097131,99176965,99188150,99113754,99218762,98937169,99150295,99228903,99099659,99313257,99015241,99015250,99299974,99103598,99075402,99282619,99095645,99281452,99303448,99095795,99225232,99308520,98789356,98910310,99172996,99070335,99301646,99313460,99182779,99219664,99298964,98940678,99296293,99280016,99296700,99066536,99087774,99225422,99152230,99314209,99283524,98823517,99177940,99296085,99287986,99315061,99297644,99285049,99223919,99301401,99279021,99070913,99137810,99169031,99006777,99314304,99314305,99314306,99314308,99314310,99171634,99214348,99220896,99061720,99315939,99297706,99315802,99309631,99143228,99150624,99308100,99289505,99296161,99186668,99279539,99139244,99288777,99225323,99315560,99315992,99312229,99312271,99312387,99214862,99301331,99311834,99170556,98989080,99221891,99282373,99282772,99282867,99150288,99031325,99102382,99314311,99314320,99293740,99149977,99225325,99225381,99032449,99032548,99299918,99303705,99311391,99184854,98818974,98983867,99091492,99278655,99296129,98910065,99279549,99223846,99302018,99211919,99211949,99175331,98981149,99038585,99300074,99301871,99141993,99185070,98936802,99142962,99143342,99142812,99302092,99090355,99312364,99312993,99301533,99299890,99008892,99315700,99300016,99300042,99300044,99154538,99311484,99311527,99300621,99302609,99303073,99307269,99300371,99099207,99075539,99117585,
							99087716,99104788,99104687,98971919,99035666,98782570,99104228,99112955,99104769,99113625,99115234,99102053,98850480,98972421,99118932,98777569,99074420,99098710,99033320,99021924,99129447,99129834,99129839,99130611,99115434,99128081,99128085,99119011,99119117,98937389,99104236,99129816,99102038,99096823,99098240,99098523,98978302,99099786,98924108,99021566,99118810,99065656,99089786,99089958,99090622,98978376,98812671,99094723,98978200,98978342,99075877,98986741,99115952,99116820,99088033,99129836,99078116,98897358,98924141,99119000,99075935,98978178,99096121,99096237,99117183,99097248,98793965,99102077,99073623,98977972,99078014,99097423,99104697,99075383,98977956,98978016,98997539,98970999,99129556,99114932,99095412,99070636,99073922,98951973,98910745,99129312,99075154,99078064,99078069,99091280,99094876,99141220,99114553,99128092,98993506,99128250,99096740,99097612,99075972,99075894,99091623,99113110,99101652,99112870,99097735,99098875,99088767,99137636,99066664,99143643,99138679,99096997,99129288,98937474,99124287,99089987,99092829,99147185,99147313,99076609,99148289,99148871,99148883,99128571,99130509,99119030,99116142,99118518,99118782,99087017,99087406,99103981,99129418,99090528,99090823,99149033,99149076,98913917,99148193,99124271,99097894,99008483,99119062,98784030,99077364,98988511,99129218,99086935,99086978,99141865,99143307,98919233,98820764,99091766,98827583,99129943,99129994,99128756,99148553,99087053,99087938,99137213,99148863,99040496,99124523,99126795,99143244,99144056,99147365,99099794,98792348,99112549,99130255,99130396,99129043,99150577,99037304,
							99149185,99142285,99149422,99088286,99127173,99073626,99127542,99127632,99127730,99128069,99129291,99100313,99099992,99130519,99130722,99031423,99143765,99147423,99147772,99149895,98936515,98910640,99130711,98980299,99113620,99142909,99112132,99112500,99112519,99138420,99143171,99087898,99102004,99154863,99116113,98782773,99141398,99141518,99138325,99128225,99104757,98820698,99153398,99155229,99155239,99090342,99143118,99116807,99103246,99115802,99154662,99155804,99155894,99155947,99143289,99144831,99144835,99144845,99128279,99148042,99104313,99181552,99189651,99182787,99181576,99217648,99213442,99218436,99066235,99118628,99180066,99127651,98997252,99104691,99129440,99190906,99191090,98842248,99118985,99130571,98972487,99207574,99078027,99078075,99212255,99129462,99213329,99213366,99118929,99188900,99192179,99179478,99190365,99218347,99075688,99191855,98812731,98845306,98845314,99118742,99118955,98997594,99190878,98845323,99126508,99126671,99078128,98972502,99116530,99037047,99190240,99190406,98810320,99158203,98845219,99212442,99119065,99036765,99040209,99179417,99213642,99206444,98978052,98978073,99116798,99158458,98850500,99159086,99194456,99159405,99049622,99187675,99116816,99158767,99159035,99179988,99176687,99207948,99118436,99194452,99212534,99183227,99206040,99212871,98897861,99125796,99150669,99179468,99212948,99213575,99214592,99089042,99210557,99179894,98978148,99206232,99187650,99173386,98852729,99018519,98920374,99129465,99129475,99129230,98944799,99016220,99016750,99207991,99210025,99127795,99214696,99158563,99093436,99173375,99065694,99175845,99175852,
							99182650,99097514,98987096,99179649,99180006,99179579,99179892,99138391,99144039,98918516,99173136,99183380,99180118,99179544,99179132,99210080,99210965,99210973,99179337,99186537,99214782,99213611,99215241,99213215,99214085,99041636,99212306,99212379,99187109,99156159,99035433,98966101,98964186,99191355,99179493,99179549,99174351,98788756,99206487,99185384,99213490,99186665,99180820,99206496,99174878,99094791,99094807,99181772,99181789,99183210,99035958,99180823,99192769,99206517,99179421,99213047,99213781,99172926,99186624,99212291,99176888,99210091,99210101,99210540,99182815,99174298,99174421,99199465,99063221,99174527,99174975,99179711,99186963,99213191,99187990,99180507,99186613,99214115,98792030,99175799,99175833,99174502,99174571,99174511,99186914,99169021,99190446,99061993,99207916,99207917,99207919,99178790,99218696,99212642,99151493,99174625,98984037,99191222,99171994,99175096,98942552,99206743,99175392,98783311,99214512,99180889,99174960,99169113,99207928,99087707,99219445,99185113,99185470,99087742,99187765,99176194,99190336,98940962,99191229,98806585,99175794,99176745,99179013,99175130,99186495,99213796,99176875,99062280,99143464,99191840,99175526,99188398,99219633,99220611,99087882,98819167,98918755,99206007,99178792,99211332,98800909,99179900,99088088,99176255,99172165,99172546,99173247,99208076,99220398,98982759,99206203,99209353,99210611,99214545,98992909,98993710,99017306,99219225,99218600,99175237,99150045,99150073,99220113,99174276,99213341,99174128,99180027,99188149,99188277,99174891,98819155,99180714,98936544,99191653,99221130,99214633,99172013,
							99212265,99180819,99193277,99179594,98939566,99185132,98981639,99181143,99190809,99219608,99219630,99191845,99219448,99219552,99172702,99179304,99218344,99154619,99175268,99181010,99180441,98986725,99175775,99209695,99180331,99220171,99220445,99220778,99220904,99219858,99214530,99184322,99249312,99234182,99252223,99232085,99230333,99245324,99230274,99130088,99150021,99229166,99235754,99235769,99127337,99127832,99129316,99244636,99158587,99252741,99261179,99262376,99233706,99234523,99234583,98845248,98845329,99229589,99229824,99251303,99234518,99235713,98819442,98972458,98987274,99191617,99236527,99021670,99245437,99245490,98972553,98896777,99226070,99249173,99115864,99229695,99129924,99130403,99130551,99130556,99159055,99100032,99230585,99230658,99230992,99129913,98988946,99223461,98972559,99232562,99138695,99252757)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/