column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE
    sbFactura CLOB;
    sbFactura2 CLOB;
BEGIN
    dbms_output.put_line('Inicia OSF-3279');

      sbFactura := '<LDC_FACTURA>
<LDC_DATOS_CLIENTE><FACTURA>2030002614</FACTURA><FECH_FACT>18/SEP/2017</FECH_FACT><MES_FACT>SEP-2017</MES_FACT><PERIODO_FACT>SEPTIEMBRE 2017</PERIODO_FACT><PAGO_HASTA>29/09/2017</PAGO_HASTA><DIAS_CONSUMO>32</DIAS_CONSUMO><CONTRATO>1113882</CONTRATO><CUPON>137831414</CUPON><NOMBRE>CERTAIN NAVARRO MAURICIO</NOMBRE><DIRECCION_COBRO>KR 51B CL 80 - 96 APTO 12C</DIRECCION_COBRO><LOCALIDAD>BARRANQUILLA - ATL</LOCALIDAD><CATEGORIA>RESIDENCIAL</CATEGORIA><ESTRATO>ESTRATO 5</ESTRATO><CICLO>201</CICLO><RUTA>2013441250240000</RUTA><MESES_DEUDA>1</MESES_DEUDA><NUM_CONTROL>2929682570</NUM_CONTROL><PERIODO_CONSUMO>11/AGO - 11/SEP</PERIODO_CONSUMO><SALDO_FAVOR>0</SALDO_FAVOR><FECHA_SUSPENSION></FECHA_SUSPENSION><VALOR_RECL>0</VALOR_RECL><TOTAL_FACTURA>113,182</TOTAL_FACTURA><PAGO_SIN_RECARGO>29/09/2017</PAGO_SIN_RECARGO><CUPO_BRILLA>3240000</CUPO_BRILLA>
</LDC_DATOS_CLIENTE>
<LDC_CONSUMOS_HIST>
<CONSUMO_MES>3</CONSUMO_MES>
<FECHA_CONS_MES>MAR-17</FECHA_CONS_MES>
</LDC_CONSUMOS_HIST>
<LDC_CONSUMOS_HIST>
<CONSUMO_MES>0</CONSUMO_MES>
<FECHA_CONS_MES>ABR-17</FECHA_CONS_MES>
</LDC_CONSUMOS_HIST>
<LDC_CONSUMOS_HIST>
<CONSUMO_MES>1</CONSUMO_MES>
<FECHA_CONS_MES>MAY-17</FECHA_CONS_MES>
</LDC_CONSUMOS_HIST>
<LDC_CONSUMOS_HIST>
<CONSUMO_MES>9</CONSUMO_MES>
<FECHA_CONS_MES>JUN-17</FECHA_CONS_MES>
</LDC_CONSUMOS_HIST>
<LDC_CONSUMOS_HIST>
<CONSUMO_MES>8</CONSUMO_MES>
<FECHA_CONS_MES>JUL-17</FECHA_CONS_MES>
</LDC_CONSUMOS_HIST>
<LDC_CONSUMOS_HIST>
<CONSUMO_MES>9</CONSUMO_MES>
<FECHA_CONS_MES>AGO-17</FECHA_CONS_MES>
</LDC_CONSUMOS_HIST>
<LDC_DATOS_LECTURA>
<NUM_MEDIDOR>Y-233793</NUM_MEDIDOR><LECTURA_ANTERIOR>4263</LECTURA_ANTERIOR><LECTURA_ACTUAL>4272</LECTURA_ACTUAL><OBS_LECTURA></OBS_LECTURA>
</LDC_DATOS_LECTURA>
<LDC_DATOS_CONSUMO>
<CONS_CORREG>9</CONS_CORREG><FACTOR_CORRECCION> 0.9929</FACTOR_CORRECCION><CONSUMO_MES_1>9</CONSUMO_MES_1><FECHA_CONS_MES_1>AGO-17</FECHA_CONS_MES_1><CONSUMO_MES_2>8</CONSUMO_MES_2><FECHA_CONS_MES_2>JUL-17</FECHA_CONS_MES_2><CONSUMO_MES_3>9</CONSUMO_MES_3><FECHA_CONS_MES_3>JUN-17</FECHA_CONS_MES_3><CONSUMO_MES_4>1</CONSUMO_MES_4><FECHA_CONS_MES_4>MAY-17</FECHA_CONS_MES_4><CONSUMO_MES_5>0</CONSUMO_MES_5><FECHA_CONS_MES_5>ABR-17</FECHA_CONS_MES_5><CONSUMO_MES_6>3</CONSUMO_MES_6><FECHA_CONS_MES_6>MAR-17</FECHA_CONS_MES_6><CONSUMO_PROMEDIO>5</CONSUMO_PROMEDIO><TEMPERATURA>77.2782</TEMPERATURA><PRESION>.33</PRESION><EQUIVAL_KWH>9 M3 Equivalen a 93.33kwh</EQUIVAL_KWH><CALCCONS>LEC.MEDIDOR</CALCCONS>
</LDC_DATOS_CONSUMO>
<LDC_DATOS_REVISION>
<TIPO_NOTI>4</TIPO_NOTI><MENS_NOTI>Solicite la Revision Periodica con un Organismo de Inspeccion Acreditado y/o distribuidor y siga disfrutando del servicio de Gas.</MENS_NOTI><FECH_MAXIMA>31 Agosto     2017</FECH_MAXIMA><FECH_SUSP>INMEDIATO</FECH_SUSP>
</LDC_DATOS_REVISION>
<LDC_TOTALES>
<TOTAL_1></TOTAL_1>
</LDC_TOTALES>
<LDC_CARGOS>
<ETIQUETA>1</ETIQUETA><DESC_CONCEP>SERV.GAS (Serv.Susc.1113882)</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL></CAPITAL><INTERES></INTERES><TOTAL></TOTAL><SALDO_DIF></SALDO_DIF><CUOTAS></CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>2</ETIQUETA><DESC_CONCEP>CARGO FIJO MENSUAL</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL>3,692</CAPITAL><INTERES></INTERES><TOTAL></TOTAL><SALDO_DIF></SALDO_DIF><CUOTAS></CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>3</ETIQUETA><DESC_CONCEP>CONTRIBUCION</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL>3,496</CAPITAL><INTERES></INTERES><TOTAL></TOTAL><SALDO_DIF></SALDO_DIF><CUOTAS></CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>4</ETIQUETA><DESC_CONCEP>CONSUMO DE GAS NATURAL</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL>13,788</CAPITAL><INTERES></INTERES><TOTAL></TOTAL><SALDO_DIF></SALDO_DIF><CUOTAS></CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>5</ETIQUETA><DESC_CONCEP>FINANCIACION GRAVADA BIENES Y SERVICIOS</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL>14,717</CAPITAL><INTERES>0</INTERES><TOTAL></TOTAL><SALDO_DIF>0</SALDO_DIF><CUOTAS>0</CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>6</ETIQUETA><DESC_CONCEP>REVISION PERIODICA RES 059</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL>77,456</CAPITAL><INTERES>0</INTERES><TOTAL></TOTAL><SALDO_DIF>0</SALDO_DIF><CUOTAS>0</CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>7</ETIQUETA><DESC_CONCEP>INTERES DE MORA(Tasa 2.328%)</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL></CAPITAL><INTERES>33</INTERES><TOTAL></TOTAL><SALDO_DIF></SALDO_DIF><CUOTAS></CUOTAS>
</LDC_CARGOS>
<LDC_CARGOS>
<ETIQUETA>8</ETIQUETA><DESC_CONCEP>Total Servicio:</DESC_CONCEP><SALDO_ANT></SALDO_ANT><CAPITAL>113,149</CAPITAL><INTERES>33</INTERES><TOTAL>113,182</TOTAL><SALDO_DIF>0</SALDO_DIF><CUOTAS></CUOTAS>
</LDC_CARGOS>
<LDC_RANGOS>
<LIM_INFERIOR>0</LIM_INFERIOR><LIM_SUPERIOR>90000</LIM_SUPERIOR><VALOR_UNIDAD>1532</VALOR_UNIDAD><CONSUMO>9</CONSUMO><VAL_CONSUMO>13,788.00</VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS>
<LIM_INFERIOR>90001</LIM_INFERIOR><LIM_SUPERIOR>180000</LIM_SUPERIOR><VALOR_UNIDAD>0</VALOR_UNIDAD><CONSUMO>0</CONSUMO><VAL_CONSUMO>0.00</VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS>
<LIM_INFERIOR>180001</LIM_INFERIOR><LIM_SUPERIOR>280000</LIM_SUPERIOR><VALOR_UNIDAD>0</VALOR_UNIDAD><CONSUMO>0</CONSUMO><VAL_CONSUMO>0.00</VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS>
<LIM_INFERIOR>280001</LIM_INFERIOR><LIM_SUPERIOR>1000000</LIM_SUPERIOR><VALOR_UNIDAD>0</VALOR_UNIDAD><CONSUMO>0</CONSUMO><VAL_CONSUMO>0.00</VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS>
<LIM_INFERIOR>1000001</LIM_INFERIOR><LIM_SUPERIOR>5000000</LIM_SUPERIOR><VALOR_UNIDAD>0</VALOR_UNIDAD><CONSUMO>0</CONSUMO><VAL_CONSUMO>0.00</VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS>
<LIM_INFERIOR>5000001</LIM_INFERIOR><LIM_SUPERIOR>MAS</LIM_SUPERIOR><VALOR_UNIDAD>0</VALOR_UNIDAD><CONSUMO>0</CONSUMO><VAL_CONSUMO>0.00</VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS>
<LIM_INFERIOR></LIM_INFERIOR><LIM_SUPERIOR></LIM_SUPERIOR><VALOR_UNIDAD></VALOR_UNIDAD><CONSUMO></CONSUMO><VAL_CONSUMO></VAL_CONSUMO>
</LDC_RANGOS>
<LDC_RANGOS_2>
<LIM_INFERIOR1> </LIM_INFERIOR1>
<LIM_SUPERIOR1> </LIM_SUPERIOR1>
<VALOR_UNIDAD1> </VALOR_UNIDAD1>
 
<VAL_CONSUMO1> </VAL_CONSUMO1>
<LIM_INFERIOR2> </LIM_INFERIOR2>
<LIM_SUPERIOR2> </LIM_SUPERIOR2>
<VALOR_UNIDAD2> </VALOR_UNIDAD2>
 
<VAL_CONSUMO2> </VAL_CONSUMO2>
<LIM_INFERIOR3> </LIM_INFERIOR3>
<LIM_SUPERIOR3> </LIM_SUPERIOR3>
<VALOR_UNIDAD3> </VALOR_UNIDAD3>
 
<VAL_CONSUMO3> </VAL_CONSUMO3>
<LIM_INFERIOR4> </LIM_INFERIOR4>
<LIM_SUPERIOR4> </LIM_SUPERIOR4>
<VALOR_UNIDAD4> </VALOR_UNIDAD4>
 
<VAL_CONSUMO4> </VAL_CONSUMO4>
<LIM_INFERIOR5> </LIM_INFERIOR5>
<LIM_SUPERIOR5> </LIM_SUPERIOR5>
<VALOR_UNIDAD5> </VALOR_UNIDAD5>
 
<VAL_CONSUMO5> </VAL_CONSUMO5>
<LIM_INFERIOR6> </LIM_INFERIOR6>
<LIM_SUPERIOR6> </LIM_SUPERIOR6>
<VALOR_UNIDAD6> </VALOR_UNIDAD6>
 
<VAL_CONSUMO6> </VAL_CONSUMO6>
<LIM_INFERIOR7> </LIM_INFERIOR7>
<LIM_SUPERIOR7> </LIM_SUPERIOR7>
<VALOR_UNIDAD7> </VALOR_UNIDAD7>
<CONSUMO> </CONSUMO>
<VAL_CONSUMO7> </VAL_CONSUMO7>
</LDC_RANGOS_2>
<LDC_COMPCOST>
<COMPCOST>Gm = $787 Tm = $386 Dm = $198.19 Cv = $0 Cc = $0 Cm = $3692.12</COMPCOST><VALORESREF>DES(h)=0 IPLI=100% IO=100% IRST=NO APLICA</VALORESREF><VALCALC>DES(h)=0 COMPENSACION($)=0</VALCALC>
</LDC_COMPCOST>
<LDC_CUPON>
<COD_BAR>(415)7707232377896(8020)0137831414(3900)0000113182(96)20270929</COD_BAR>
</LDC_CUPON>
<EXTRA_BARCODE_>
<CODE>41577072323778968200137831414È39000000113182È9620270929</CODE>
<IMAGE></IMAGE>
</EXTRA_BARCODE_>
</LDC_FACTURA>';

   
    MERGE INTO OPEN.ED_DOCUMENT A USING
    (SELECT
      2030002614 as DOCUCODI,
      66 as DOCUTIDO,
      76712 as DOCUPEFA,
      TO_DATE('18/09/2017 08:55:12 pm', 'DD/MM/YYYY HH:MI:SS AM') as DOCUFERE,  
      sbFactura DOCUDOCU
      FROM DUAL) B
    ON (A.DOCUCODI = B.DOCUCODI and A.DOCUTIDO = B.DOCUTIDO)
    WHEN NOT MATCHED THEN 
    INSERT (
      DOCUCODI, DOCUTIDO, DOCUPEFA, DOCUFERE, DOCUDOCU)
    VALUES (
      B.DOCUCODI, B.DOCUTIDO, B.DOCUPEFA, B.DOCUFERE, B.DOCUDOCU)
    WHEN MATCHED THEN
    UPDATE SET 
      A.DOCUPEFA = B.DOCUPEFA,
      A.DOCUFERE = B.DOCUFERE,
      A.DOCUDOCU = B.DOCUDOCU;
      

    COMMIT;
    dbms_output.put_line('Fin OSF-3279');
END;
/

select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/