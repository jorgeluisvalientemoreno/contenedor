column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99043836,98842055,98842153,99044589,98978189,99038317,99011496,99030307,99049363,99031016,98827333,98829165,99045959,99046610,99030781,99066613,99035617,99037209,99068279,99068449,99049627,99030677,99031870,99046365,99031964,99032208,99031546,99038224,99044942,98783015,99031763,99045176,99060532,99060866,99036742,99061780,99062352,99068590,98918979,98917263,99044757,99036145,99036230,99029227,98997245,99032115,99067977,99065755,99069552,99069846,99047277,99036741,99039285,99046488,99061968,98994318,99063152,99063187,99017623,99049640,99049645,99068360,99069516,99069578,99069931,99070059,99067395,99070571,99038581,99040834,98939511,99040648,99062782,99063046,99036264,99036134,99070722,99066964,99065882,99066922,99066248,99036396,99036430,98949052,99040044,98782596,99037817,99033067,99035682,99036674,99036874,99037128,99064531,99069815,99066262,99037153,99048890,99046176,99062311,99035554,99061367,99070527,99066789,99035660,99061853,99065754,98789903,98790046,98988675,99067201,99067500,99044836,99037286,99039834,99036775,98827789,99047407,99062556,99062659,99062759,99067198,99070948,99030760,99035395,99061740,99071857,99070962,99071985,99062580,99072564,99065790,98981249,99070021,99071884,99062769,99065856,99065857,99067543,99030778,99031375,99059766,99032755,99041313,99068066,99071064,99070006,99066385,99068715,99031651,99047124,99047482,99046345,99046376,99049636,99049660,98910925,99066253,99068058,99065864,99065865,99066295,99060121,99031723,99048101,99039690,99037234,99066267,99068147,99066301,99067801,99066110,99044533,99047546,99047579,99065770,99040214,99362247,
							99362250,99362933,99363295,99363301,99329656,99330111,99363795,99363800,99363832,99363885,99363892,99363954,99206030,99337863,99338351,99353087,98972529,99118687,98965249,99312237,99225806,99300624,99350914,99325053,99347829,99319329,99319330,99319331,99319332,99319342,99359489,98997229,99296709,99104786,98981137,99143652,99234436,98924048,98845365,98845371,99119018,99119086,99300086,99159685,99321892,99300092,98845261,99299365,99049446,99347944,99299360,99299729,99118948,98924136,98970770,99158967,99325561,98954372,98791985,98794194,99180170,99232830,99318854,99319608,99303436,99129819,99239074,99292942,98800935,99363667,99312333,99118092,99236365,99104706,99119125,99119129,99239808,98972044,98972083,99233381,99319756,99242998,99325743,99113657,99156881,99299995,98924174,98924179,99092295,99247632,99119070,98978203,99129318,99129323,99282744,99350239,99311582,99128529,99128799,99331096,98850493,99299716,99228961,99229311,99229599,99229606,98978142,99232871,99129306,99312250,99179558,99179844,99300644,99312233,99013965,99239203,99320256,99239086,99239099,99018822,99337137,99021849,99323248,99351667,99319983,99158266,99302176,98997326,98997374,99021446,99312220,98978337,98924083,98792956,99229862,99076428,99312382,99339598,99319150,99343562,99343568,99227401,99229266,99324582,99320370,99320373,98978349,99129845,99325437,99214994,99289836,99147582,99223729,99224525,98978152,99233165,99233283,99296751,99075787,99282729,99228174,99320840,99094939,98953990,99094883,99175065,99190458,99237741,98841877,99312326,99312367,99320293,99299024,98978030,99013490,99229733,99321829,
							99352605,99328106,99347896,99229812,98777652,99319092,99169156,99222341,99222404,99331537,99321790,99112840,99222898,99225836,99226480,99226778,99156920,99232565,99331613,99354176,99234553,99238178,98842270,99325955,99183838,99187240,99221651,98838677,99223866,99225183,99353003,99325550,99234874,99238830,99238907,98840768,99049391,99343336,99147343,99338021,99338367,98981118,98981173,99179484,99184301,99279993,99216802,99230310,99315694,99321851,99343345,99357884,99358808,99230647,99230763,99230968,99325971,99226308,99355807,98839042,99221349,99222188,99225766,99226459,99289815,99362332,99332925,99325510,99323894,99359215,99333808,99321159,99152183,99343415,99347858,99210062,99323915,99347848,99351095,99226138,99225146,99361712,99356381,99356626,99356723,99356848,99087127,99187096,99175862,99357632,99330925,99180851,99342351,99351900,99339883,99090679,99094888,99293502,99321323,99333832,99348348,99352762,98783366,99339277,99142700,99348220,99352686,99358054,99358062,99218606,99343301,99219518,98826965,99328521,98918556,98792643,99332793,99363309,99363368,99364264,99323352,99320777,99283104,99225999,99329713,99350213,99138057,99359479,99349029,99357035,99211093,99170322,98808962,99036769,99207999,99214188,98918959,99329419,99098959,99210015,98938365,99359792,99341064,98823226,99331866,99212063,99141736,99186720,99173076,99214682,99325222,99315833,99172146,99186989,99149454,99209924,99350088,99320849,99325114,99325236,99341220,99329608,99324834,99340708,99338751,99302097,99210159,99330458,99225849,99328263,98807790,99208097,99213157,99350900,99363371,99347930,99211963,
							99349800,99143894,99150506,99349900,99172737,99328817,99350145,99176402,99305426,99330007,99170887,99089188,99090856,99351543,99338335,99343290,99343382,99175481,98981537,99338010,99350230,99331622,99331316,99332984,99349939,99090118,99315664,99359039,99339767,99175858,99347925,98914018,99363161,99338282,99353064,99331675,99331825,99358296,99358762,99329429,99351072,99330082,99375111,99030748,99379740,99320315,99381691,99381575,99381582,99381586,99383086,99382787,99065565,99171812,99171821,99066481,99229101,99299989,99379793,99379812,99379817,99379859,99379861,99379865,99379877,99379922,99009152,99129236,99289846,99221039,99350767,99373536,99378754,99378824,99332818,98978157,98987056,99013620,99154249,99075791,99379050,99228576,99323441,99349794,99371403,98978187,99008479,99021842,99374374,99357630,99147532,98939292,99236511,99379942,99379956,99379961,99379990,99379998,99380016,99375713,99374253,98790097,99036487,99288195,99350648,99104930,99129495,99341128,98790135,99206043,99347939,99347818,98971976,99173606,99285030,99321838,99232443,99232448,99232467,99384042,99300631,99350139,99190765,99375430,99047220,99287977,99321162,99347865,99347892,99347898,99363147,99363357,98849649,99296124,99224234,99357607,99357620,98845286,99129484,99130584,99014624,99014685,99339685,99342453,99296739,99297416,99229416,99229798,99232737,99314008,99129469,99156551,99372338,99320663,99368731,99190389,99213706,98954039,99324466,99104702,99126673,99119074,99228710,99347905,99347966,99158792,99312311,99312316,99342341,99342368,99129330,99300071,99380031,99380039,99380054,99380062,99380098,
							98801399,98826940,99098854,99194466,99223129,99224442,99230754,99230897,99128075,99128115,99352427,99126742,99158503,99347855,99355741,99379191,99374316,99375721,99331574,99299863,99375716,99150237,99213733,99322595,99347923,99231016,99232222,99190371,98924038,99333614,99312376,99347952,99104765,99175632,99288253,99296801,99330116,99382664,99243867,99015213,99015222,99375105,99328917,98998042,99218474,99220966,99375690,99118971,99118976,99158519,99343306,99363378,99112947,98945906,99030371,99102006,99325247,99379742,98944850,99158933,99300557,99352649,99357029,99086622,98789404,99179951,99363360,99149189,98986639,99232940,99144225,99115883,99282337,99296747,99300428,99347834,99371293,99187995,99382314,99382405,99375699,99383026,99347913,98827040,99333209,99116810,99358887,99379926,99380080,99159079,99300068,99375682)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/