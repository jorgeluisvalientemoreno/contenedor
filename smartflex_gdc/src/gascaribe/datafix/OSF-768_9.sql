column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99568092,99568097,99539694,99623777,99428035,99428054,99502483,99502491,99502505,99502536,99502548,99502554,99502561,99502570,99502590,99623768,99380270,99399595,99399613,99399624,99477928,99568076,99428037,99594542,99594544,99594545,99594555,99380273,99477769,99568098,99518638,99518639,99518654,99518657,99502465,99502499,99502522,99502535,99502575,99399604,99399627,99502489,99502502,99502519,99502531,99502533,99502576,99502592,99623695,99623697,99623720,99594549,99519658,99699027,99477773,99477895,99375931,99477453,99477814,99477932,99477180,99477486,99478258,99478259,99399631,99478151,99478257,99478234,99478095,99399601,99502473,99502508,99502571,99428029,99428058,99477161,99477344,99477871,99478036,99477343,99478204,99502458,99502459,99502462,99502480,99502484,99502506,99502518,99502543,99502468,99502474,99502476,99477864,99518633,99518645,99518646,99518652,99518669,99518680,99477997,99478068,99485935,99502546,99518661,99518663,99509706,99502498,99468450,99502486,99502517,99502537,99502539,99502540,99502547,99502559,99498824,99502589,99486604,99471294,99502579,99507837,99502467,99502478,99502500,99502507,99502544,99502562,99502563,99502588,99518670,99477441,99477461,99477739,99477802,99477805,99478265,99518636,99518642,99518643,99518644,99518667,99518674,99518676,99518668,99518672,99518635,99518648,99518650,99518673,99518682,99477823,99502527,99623696,99518659,99623678,99623701,99623717,99623752,99623753,99399626,99502532,99502541,99502553,99502560,99502577,99502582,99502591,99502593,99518634,99518647,99518649,99518662,99518678,99453373,99453375,99453376,99502550,
							99502557,99502566,99502567,99428031,99502450,99502454,99502460,99502466,99502525,99502572,99375916,99477971,99478254,99594539,99594552,99594554,99623730,99428041,99502493,99502538,99375943,99375968,99477803,99623676,99623680,99623682,99623691,99623700,99623709,99623710,99380233,99623690,99623712,99623714,99623721,99477471,99380257,99594537,99375925,99375929,99375946,99375950,99375965,99375969,99375972,99380234,99519554,99502452,99623757,99623745,99623747,99623780,99623781,99623787,99568095,99519707,99519551,99519577,99519578,99519629,99519671,99519684,99519757,99519822,99519823,99519606,99519815,99519649,99428030,99428051,99428053,99594540,99594550,99380265,99380278,99568075,99453357,99375917,99375923,99568069,99568071,99380287,99399597,99399602,99399607,99399628,99399636,99568085,99568091,99375949,99380238,99380286,99478065,99594541,99519787,99519789,99581818,99594543,99453361,99453379,99502564,99375936,99375940,99375941,99375952,99375956,99375957,99375960,99453364,99453368,99453378,99568096,99428036,99428040,99428046,99428047,99518637,99518656,99594556,99477624,99502504,99623681,99623683,99623694,99623715,99623724,99623727,99623731,99623733,99623734,99623736,99623737,99623756,99623759,99623763,99623766,99623775,99623778,99623783,99623784,99623785,99623791,99502509,99502516,99428045,99453365,99477978,99623705,99623749,99623758,99623688,99623685,99477365,99477865,99502471,99502490,99518641,99518658,99518660,99518671,99594535,99594553,99518677,99518679,99619524,99623679,99623703,99623704,99623718,99623738,99623741,99623764,99623765,99623767,99623769,99519541,99519549,
							99589853,99613163,99601632,99601631,99623507,99623698,99623677,99623687,99623689,99623693,99623702,99623706,99623708,99623744,99623789,99623684,99623692,99623716,99623788,99428034,99428059,99568084,99453366,99453381,99453383,99502463,99502469,99502481,99502485,99502497,99502512,99502524,99502526,99502542,99502552,99380237,99380243,99380258,99380266,99380271,99623729,99623761,99623779,99623786,99568080,99568088,99568089,99375964,99623739,99623782,99477125,99502578,99502583,99502584,99502585,99477589,99477770,99502515,99518640,99623686,99623699,99623713,99428032,99380272,99502501,99502503,99502482,99502496,99502513,99502521,99568083,99623711,99519638,99519814,99519816,99380235,99380256,99380260,99380267,99380269,99380279,99623735,99623746,99623748,99623750,99518653,99518666,99518675,99568082,99502514,99502534,99502551,99623760,99623771,99453370,99502470,99502472,99502477,99502487,99502488,99623772,99623773,99477162,99477927,99453360,99623707,99623770,99623776,99623790,99399625,99568074,99568077,99594546,99594551,99519538,99519539,99519766,99519783,99519819,99632686,99399616,99399621,99399629,99380276,99380277,99380283,99380284,99380288,99399584,99399600,99399634,99399637,99399635,99394288,99380249,99380255,99380259,99399598,99399590,99399603,99399611,99399623,99399588,99399596,99399612,99375973,99408056,99399593,99399633,99399586,99399615,99399620,99399622,99399632,99399638,99399583,99399589,99399592,99399599,99399609,99399618,98833505,98853810,98853811,98853837,98853856,98833547,98833556,98833557,98833566,98853808,98853838,98853855,98830474,98795212,98795218,98853819,
							98853836,98833619,98833611,98833628,98833629,98833640,98833600,98833606,98833613,98833650,98853807,98833579,98833638,98854971,98855100,98855102,98813412,98813413,98833622,98833627,98833637,98833651,98795204,98833599,98833624,98813399,98833509,98833514,98833570,98795195,98833533,98833534,98833578,98833586,98833610,98833498,98833527,98833528,98833546,98833563,98833585,98833592,98833594,98833598,98833612,98833631,98833633,98853833,98853847,98853848,98853853,98853859,98833513,98833553,98833572,98833584,98833603,98833608,98833512,98833552,98833577,98833614,98833641,98813383,98813385,98813386,98853803,98853822,98853832,98855110,98855126,98833615,98833642,98833662,98833666,98833668,98854922,98854951,98854957,98853805,98853817,98853823,98853846,98855046,98855103,98853849,98853852,98853860,98853864,98795199,98853851,98853863,98864960,98855119,98855124,98855040,98855058,98854973,98854982,98855017,98855018,98855021,98855025,98858413,98853830,98833551,98824008,98833501,98833503,98833506,98833542,98833636,98833667,98853804,98853806,98853809,98853812,98853813,98853814,98853815,98853818,98853820,98853821,98853825,98853827,98853828,98853834,98853839,98853840,98853841,98853842,98853843,98853844,98853854,98853857,98853858,98853862,98853865,98855048,98855051,98855054,98855055,98855059,98855060,98855062,98855064,98855073,98855074,98855077,98855078,98855092,98855093,98855106,98855107,98855108,98855112,98855117,98855118,98855120,98855125,98855128,98855135,98855136,98855137,98855122,98855188,98854949,98854960,98854967,98855022,98855063,98855101,98855187,98855192,98855194,98855195,98855109,
							98855113,98855114,98855130,98855131,98855076,98855057,98855129,98855142,98855056,98855127,98854972,98855066,98855069,98853835,98854969,98854921,98855123,98855072,98854956,98855032,98855020,98855111,98855134,98855067,98853816,98853829,98853845,98853850,98853861,98854974,98855049,98855061,98855104,98855105,98855140,98853824,98853826,98853831,98854959,98855053,98855186,98870291,99013329,99005013,99015029,99006322,98955140,98955141,98955142,99005004,99005017,99005021,98955133,98833499,98978742,98978749,99015620,98925316,98972752,98972748,98955156,98778316,98955158,98972717,98972732,99005870,98978740,98978766,99014732,99004996,99023031,99023034,99023039,99023044,99023045,99023047,99023052,99023053,99023058,99023059,99023038,99023049,98999111,98989007,99023060,99023032,99023037,99023048,99023062,99004997,99004999,99005005)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/