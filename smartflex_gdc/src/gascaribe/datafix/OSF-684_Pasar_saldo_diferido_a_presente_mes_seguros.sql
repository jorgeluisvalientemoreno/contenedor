column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

Declare

 Cursor CuDiferidos Is
    select * 
      from open.diferido d 
     where difenuse in (6535841,
                        6537227,
                        6539392,
                        6539959,
                        6543550,
                        6543604,
                        6546685,
                        6546976,
                        6556992,
                        6558639,
                        6562299,
                        6562412,
                        6575760,
                        6578256,
                        6579312,
                        6581012,
                        6581127,
                        6583658,
                        6599079,
                        17051685,
                        17053446,
                        17057023,
                        17058809,
                        17093888,
                        17112466,
                        17117508,
                        17117583,
                        17118273,
                        17130148,
                        17135810,
                        17135849,
                        17155747,
                        17173225,
                        17213546,
                        50208015,
                        50209230,
                        50211849,
                        50213524,
                        50214063,
                        50216426,
                        50222068,
                        50224342,
                        50224516,
                        50227462,
                        50230836,
                        50231717,
                        50237771,
                        50242000,
                        50256078,
                        50258528,
                        50286468,
                        50303295,
                        50309486,
                        50309640,
                        50312512,
                        50362443,
                        50364728,
                        50375680,
                        50393584,
                        50394022,
                        50395695,
                        50397181,
                        50398136,
                        50398338,
                        50400863,
                        50409037,
                        50409971,
                        50416086,
                        50423257,
                        50423282,
                        50439968,
                        50441493,
                        50441542,
                        50441640,
                        50442498,
                        50442999,
                        50443100,
                        50445116,
                        50445600,
                        50451392,
                        50455048,
                        50457145,
                        50461600,
                        50463835,
                        50479630,
                        50482616,
                        50486592,
                        50486662,
                        50488240,
                        50493088,
                        50495043,
                        50496844,
                        50497284,
                        50498582,
                        50499229,
                        50502200,
                        50505384,
                        50510205,
                        50515599,
                        50535787,
                        50565755,
                        50566450,
                        50569856,
                        50570510,
                        50576243,
                        50577751,
                        50578164,
                        50591741,
                        50628612,
                        50636807,
                        50655411,
                        50665269,
                        50674195,
                        50674497,
                        50677137,
                        50679507,
                        50680406,
                        50697022,
                        50706686,
                        50727650,
                        50731912,
                        50736438,
                        50740441,
                        50740510,
                        50742233,
                        50742317,
                        50746040,
                        50747804,
                        50753777,
                        50753966,
                        50755321,
                        50881856,
                        50895861,
                        50915322,
                        50916290,
                        50916367,
                        50927060,
                        50943936,
                        50944275,
                        50955449,
                        50955913,
                        50964401,
                        51000573,
                        51006107,
                        51015929,
                        51031498,
                        51036659,
                        51037392,
                        51056475,
                        51057151,
                        51057184,
                        51058139,
                        51083227,
                        51093363,
                        51093753,
                        51094891,
                        51094938,
                        51095139,
                        51099814,
                        51106669,
                        51171061,
                        51216362,
                        51233018,
                        51250988,
                        51251013,
                        51251210,
                        51260566,
                        51270023,
                        51272361,
                        51288479,
                        51289022,
                        51292369,
                        51302074,
                        51310903,
                        51332273,
                        51332429,
                        51341459,
                        51363027,
                        51366440,
                        51376590,
                        51376683,
                        51386658,
                        51387935,
                        51402192,
                        51402300,
                        51409785,
                        51417946,
                        51430844,
                        51438530,
                        51442193,
                        51454265,
                        51464451,
                        51464534,
                        51469056,
                        51471707,
                        51471736,
                        51471757,
                        51519521,
                        51519671,
                        51519820,
                        51526598,
                        51553775,
                        51571869,
                        51571910,
                        51572044,
                        51580047,
                        51580324,
                        51580443,
                        51602077,
                        51605055,
                        51605088,
                        51609650,
                        51609820,
                        51613200,
                        51613419,
                        51620767,
                        51620799,
                        51634904,
                        51634906,
                        51636745,
                        51637269,
                        51655411,
                        51664852,
                        51669558,
                        51669717,
                        51669787,
                        51669788,
                        51669889,
                        51669890,
                        51671601,
                        51671614,
                        51679676,
                        51699892,
                        51700118,
                        51702980,
                        51713294,
                        51713465,
                        51713466,
                        51715664,
                        51715692,
                        51728666,
                        51728860,
                        51730579,
                        51737338,
                        51737498,
                        51737849,
                        51752955,
                        51754149,
                        51760977,
                        51775034,
                        51775361,
                        51775624,
                        51775950,
                        51781153,
                        51781456,
                        51781706,
                        51781707,
                        51783598,
                        51794278,
                        51794338,
                        51794492,
                        51794611,
                        51794613,
                        51794614,
                        51794801,
                        51799157,
                        51799227,
                        51813548,
                        51813557,
                        51814163,
                        51814256,
                        51814514,
                        51814668,
                        51814669,
                        51814932,
                        51815244,
                        51815638,
                        51815639,
                        51816128,
                        51829825,
                        51830972,
                        51831056,
                        51836011,
                        51836191,
                        51850716,
                        51850717,
                        51851018,
                        51851019,
                        51851294,
                        51863735,
                        51864006,
                        51875261,
                        51878828,
                        51878890,
                        51879723,
                        51879844,
                        51879926,
                        51880144,
                        51880478,
                        51880566,
                        51880648,
                        51880649,
                        51880897,
                        51881132,
                        51881295,
                        51881296,
                        51886105,
                        51886263,
                        51895452,
                        51895981,
                        51896205,
                        51896206,
                        51896207,
                        51896208,
                        51896244,
                        51897890,
                        51906937,
                        51907024,
                        51912960,
                        51912961,
                        51913022,
                        51913106,
                        51913683,
                        51914232,
                        51914554,
                        51919866,
                        51929153,
                        51929155,
                        51929236,
                        51930054,
                        51942806,
                        51942957,
                        51946979,
                        51947724,
                        51948408,
                        51952051,
                        51952052,
                        51958332,
                        51961651,
                        51961671,
                        51962915,
                        51965813,
                        51965832,
                        51966048,
                        51966498,
                        51966541,
                        51966678,
                        51966746,
                        51966747,
                        51974001,
                        51974878,
                        51974926,
                        51976353,
                        51977014,
                        51979072,
                        51979099,
                        51979438,
                        51979541,
                        51979551,
                        51983844,
                        51984709,
                        51985460,
                        51988206,
                        51993746,
                        51993756,
                        51993876,
                        51993897,
                        51994066,
                        51994391,
                        51994448,
                        51994544,
                        51999626,
                        51999627,
                        51999723,
                        51999724,
                        52000552,
                        52001479,
                        52001528,
                        52001529,
                        52001626,
                        52001736,
                        52001835,
                        52002207,
                        52002669,
                        52002821,
                        52002891,
                        52003695,
                        52004008,
                        52073180,
                        52073208,
                        52073209,
                        52348470,
                        52348538,
                        52348562)
          and difesape != 0;

 -- Validar si se esta facturando el producto
 Cursor CuValCargos(nuProducto diferido.difenuse%type) Is   
    SELECT count(1)
      FROM cargos
     WHERE cargnuse = nuProducto
       AND cargcuco = -1; 

 nuErrorCode     number;
 sbErrorMessage  varchar2(2000);
 isbDescripcion  notas.notaobse%type := 'Cancela Diferido por Caso OSF-684';
 
 Nudifecodi      diferido.difecodi%type;
 Nudifenuse      diferido.difenuse%type;
 nuctrlcar       number;

Begin
  
  For reg in Cudiferidos Loop

    -- Valida que el producto no tenga cargos con cuenta de cobro a la -1
    If cuValcargos%isopen then
      close cuValcargos;
    end if;
    --
    open cuValcargos(reg.difenuse);
    fetch CuValCargos into nuctrlcar;
    close CuValCargos;
    --
    If nuctrlcar <= 0 then    
        -- Inicializamos variables por si hay error
        Nudifecodi := reg.difecodi;
        Nudifenuse := reg.difenuse;
        
        -- Trae deuda a presente mes
        CC_BODefToCurTransfer.GlobalInitialize;

        CC_BODefToCurTransfer.AddDeferToCollect(reg.difecodi);

        CC_BODefToCurTransfer.TransferDebt
        (
            'FINAN',
            nuErrorCode,
            sbErrorMessage,
            false,
            ld_boconstans.cnuCero_Value,
            sysdate
        );
        
        commit;
        --
    Else
       
      Dbms_Output.put_line('Producto ' || reg.difenuse || '     se esta facturando, tiene cargos a la -1');
        
    End if;      
          
  End Loop;

  Dbms_Output.put_line('Proceso de pasar deuda diferida a presente mes realizado satisfactoriamente.');
   
  Exception
     When others Then
       Rollback;
       Dbms_Output.put_line('Error en proceso Producto ' || Nudifenuse || '  Diferido ' || Nudifecodi || '  ' || sqlerrm);
        
End;
/

select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/