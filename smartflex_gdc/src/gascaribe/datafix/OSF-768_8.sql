column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99347934,98799367,99185321,99188498,99231249,99381200,99373935,99349980,99363240,99156567,99357587,99347842,99355866,98987691,99373495,99349775,98897917,99118735,99158176,99381085,99378977,99378885,99382638,99380112,99088999,99325639,99350579,99381139,99321963,99282747,99298348,99331518,99331861,99332181,99179343,99188352,99216118,99300046,99347947,99363246,99355179,98923676,99021777,99312225,99369359,98964836,99007999,99379150,99208652,99237629,99299882,99336595,98832419,99186657,99186716,99359284,99228980,99229092,99229629,99222606,99299385,99209293,99211514,99179368,99179919,99180054,99298816,99301931,99383239,99383765,99049356,99347974,99358767,99077796,99015854,99156201,99360053,99369755,98805778,99232139,99232261,99233088,99179622,99343205,99369520,99363263,99379197,99172549,98981106,99382443,99102000,99172523,99279542,99299164,99331554,99358599,99234548,99186707,99213538,99299280,99299442,99299449,99315016,99370686,99352409,99373145,99372461,99016658,99226347,99342466,99238348,99298677,99379900,99212687,99383774,98801391,99374130,99075766,99325663,99371685,99331854,99378966,99378995,99372735,99034028,99340236,99362296,99371761,99370089,99113927,99383983,99384054,99384752,99228532,98820495,98820594,99384749,99372300,99229922,99091310,99350401,99352252,99336970,99031400,99208577,99208599,99283005,99374113,99213318,99379066,99369748,99213370,99342519,99224450,98964845,99385151,99315288,99351462,99073769,99114077,99114178,99168770,98839442,99351686,99371143,99374355,99374394,98980491,99227020,99227375,99227425,99227478,99227646,99356882,99332378,99336006,99325466,
							99371628,99383880,99379970,99066592,98801319,99382357,99381992,99331751,99318938,99379362,99379460,99380090,99383912,99384027,99225986,99226162,99335914,99372403,99379512,99379573,99225522,99348650,99385708,99225782,99226046,99384186,99385972,99342321,99382580,99282553,99320294,99517966,99423219,99414069,99523415,99520146,99414397,99414444,99414774,99426440,99416470,99414102,99414304,99435967,99428017,99424157,99415588,99424454,99414839,99427815,99414291,99414107,99451754,99414753,99414738,99414779,99448340,99422712,99554142,99563328,99539701,99557146,99557148,99557153,99567404,99562970,99423660,99551768,99551281,99551947,99561292,99540622,99551605,99557404,99540530,99555182,99557164,99551861,99541417,99551310,99533531,99541432,99556947,99558436,99561471,99567136,99539247,99539188,99549172,99555449,99557180,99549176,99414213,99499607,99485512,99467160,99489409,99499024,99424705,99470003,99468283,99496835,99498149,99509775,99414505,99500464,99474609,99487430,99511802,99519888,99424489,99556596,99415216,99415099,99551778,99414867,99549572,99606600,99615559,99576656,99607672,99613443,99586752,99615043,99590043,99414118,99618550,99585592,99583761,99583820,99593959,99619883,99602250,99602837,99602638,99607663,99583712,99459581,99555197,99415424,99588557,99633228,99389580,99394287,99397427,99398662,99396413,99409591,99407506,98825554,98840735,98821006,98826569,98820549,98820550,98820559,98865483,98857201,98803606,98831755,98825868,98826504,98825544,98861191,98869157,98864651,98843712,98999267,99007666,98917171,98995036,98981906,98989395,98990782,98992702,98988916,98996480,
							98996736,99006391,99005048,98987943,98781823,98949504,98953282,98935019,98922746,98953518,98968083,98934880,98966018,98971949,99150096,99144077,99143979,99116975,99156503,99102014,99096534,99148728,99139205,98922739,98916224,99091422,99142114,99102041,99102436,99150574,99097643,99168806,99149297,99095523,99090400,99088292,99151513,99143089,99102180,99155487,99314992,99148158,99181494,99282865,99282888,99187801,99315854,99103717,99293729,99282810,99282585,99282370,99302603,99314982,99315489,98808870,99317443,99318396,99288178,99316032,99287962,99283080,99314892,99314901,99183163,99318304,99092576,99316126,99302885,99317292,99104282,99117189,99088424,99102044,99089057,99100092,99075611,99117501,99124904,99076771,99137770,98818563,99143084,99129853,99155290,99180448,98854001,99209910,99208490,99174648,99209864,99175088,99113013,99187462,99192301,99219479,99175647,99213853,99174558,99213533,99087749,99187279,98803075,99175692,99178815,99217202,99221658,99249174,99244709,99223317,99262064,99231149,99104684,99188144,98812439,99241767,99222335,99246137,99246246,99154769,98792538,99263260,99242251,99242602,99088344,99237427,99092556,99229186,99248330,99088806,99227760,99244585,99252516,98800856,98787718,98798317,98818155,98788613,98792243,98783847,98792743,98792872,98788383,98801496,98801759,98800838,98789931,98790209,98776400,98789318,98792616,98807839,98799678,98778231,98884495,98917583,98916414,98872926,98873959,98882149,98916561,98919373,98911498,98882104,98882056,98918957,98914662,98885679,98893527,98894505,98915194,98917189,98891736,99032666,99044269,99049202,99040716,
							99071804,99042018,99033039,99071421,99046038,99062394,99356748,99331435,99342583,99322396,99285260,99278867,99351088,99314175,99321186,99316054,99282938,99324187,99332642,99321213,99343260,99278891,99325972,99329859,99097250,99319540,99319893,99320230,99278837,99319880,99088332,99319940,99278836,99287973,99283652,99319528,99321028,99181263,99181933,99089469,99091745,99360117,99315863,99314928,99343369,99314135,99088763,99316238,99315815,99315919,99330573,99278887,99349633,99331801,99337744,99342336,99318825,99319901,99280604,99090738,99320561,99114018,99324420,99089951,99104661,99331481,99317963,99329969,99340145,99352253,99112998,99282995,99320282,99382497,99332057,99332158,99147255,99208565,99319800,99089110,99282860,99319537,99314098,99320775,99287929,98808772,99502529,99502558,99502565,99428048,99477916,99518651,99518664,99518665,99518681,99375961,99375962,99623722,99428042,99428044,99623725,99623740,99623742,99623743,99428039,99428056,99502453,99399591,99399587,99568073,99477243,99478098,99568079,99568086,99453359,99477297,99477804,99477395,99477792,99594547,99568078,99375944,99375963,99477726,99380280,99594538,99594536,99519731,99519780,99519817,99477485,99478037,99478214,99478260,99478263,99502464,99502511,99502523,99502528,99502568,99502569,99502573,99502574,99502587,99502510,99623719,99502586,99623723,99623732,99623751,99477687,99477697,99502530,99502545,99502580,99502581,99594548,99399606,99399610,99399630,99375928,99453367,99453371,99623726,99623728,99623754,99623755,99623762,99623774,99568087,99399585,99519545,99519559,99519784,99519824,99519586,99527808,
							99453372,99453385,99453358,99453362,99453363,99453369,99453380,99453384,99453386,99428033,99428055,99399619,99428050,99428052,99399594,99428057,99453374,99453377,99453382,99375935,99375966,99428038,99428043,99428049,99568070,99519561,99375958,99477194,99502479,99502495,99502520,99478264,99502555,99502556,99399608,99502461,99502475,99502492,99502494,99502549,99380232,99380236,99380240,99380246,99380247,99380252,99380264,99380275,99399582,99399605,99399614,99399617,99519548,99519569,99519698,99519781,99519821,99518655,99477588,99502455,99502451,99477917,99568081,99519691,99566684,99568072,99568093,99568094,99568099,99519791,99550731,99519575,99519576,99519716,99519542,99519550,99519748,99519779,99519820,99519560,99519792,99562620,99519782,99519547,99519553,99519818,99519597,99519790,99528598,99539294,99547837,99568090)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/