column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (98995900,98819489,98988046,99011230,99013492,98982300,98993996,99011439,98992592,98992611,98979938,98981788,98990298,98940819,98942566,98827769,99011391,99019465,99019654,98981587,99012058,98983580,99012564,98987371,98992793,98992864,98988032,98997113,98997219,98997223,98997234,98997337,98997443,99007018,99016557,98982336,98997175,98944813,98988524,98983290,99007330,99007579,99013435,99019119,99021268,98918271,99015921,98981496,98827587,99007846,99012157,99012259,99012281,99012766,98980149,98987394,98997582,98997787,98992577,99361796,98980124,98986701,99022312,99021750,98997348,98998954,98983667,99007942,98989006,98979942,99013320,98993232,98993236,98982343,98983634,98983749,98983678,99007015,98783613,99022463,99018088,99018967,98998681,98783626,98799796,99008698,98989608,98980888,99012374,98993453,98993339,99007991,98909416,99005203,98993234,98997046,98983675,99008568,99012593,99012601,99012647,99014508,99017176,98981096,99012581,99017466,98997156,98997971,99012220,99015171,99020661,99021832,99022290,98994044,98994197,98989013,99007244,99017562,98998253,99022651,99007367,98993024,99009145,99012793,98949163,98946373,98946628,98948797,98952914,98897750,98923471,98946721,98845244,98845357,98826996,98827011,98938171,98940975,98777555,98924118,98937713,98944253,98948991,98949308,98933851,98933852,98933853,98933855,98933868,98823394,98945168,98945182,98953230,98944064,98924074,98938112,98923544,98923481,98842238,98971829,98934169,98792540,98924098,98923504,98945136,98945508,98947917,98943166,98943418,98945476,98937539,98935544,98935863,98936016,98842427,98944725,98944726,
							98944727,98944730,98925144,98923630,98810805,98938299,98934305,98923588,98817298,98925249,98944741,98954684,98935982,98966874,98772303,98772362,98953406,98943678,98952489,98953686,98944889,98951305,98964762,98964964,98948603,98934075,98826542,98925137,98937299,98966419,98922518,98953646,98924869,98950563,98943456,98952952,98967178,98945566,98968661,98950511,98925235,98822456,98819964,98937131,98937132,98968736,98943447,98954047,98963433,98945363,98966153,98965744,98968619,98966909,98970355,98946993,98934767,98934957,98937363,98945444,98937987,98944479,98968052,98968742,98936962,98970320,98970506,98968708,98970686,98946831,98943203,98964851,98965607,98969700,98971025,98966263,98799928,98949804,98937576,98942036,98970974,98971573,98971647,98964673,98967821,98949685,98948302,98942151,98971915,98970769,98970759,98970948,98971871,98967479,98965355,99116786,99143414,99143582,99149969,99157965,99158071,99158590,99159130,98972034,99021866,98978144,99099246,99049388,99119324,98972165,98972285,99098233,99115663,99118477,99141882,99143753,99118615,98792477,99150036,99150069,99077991,99156035,99075418,99113936,98832908,98997463,98997473,99021882,99158328,98850077,99158961,99159675,99118703,98925312,99086923,99156223,98971057,98845259,99118706,99101819,98978311,99115370,99073944,98793938,98845160,98978009,99127815,99143799,99144424,99149172,98791944,98850532,99131059,99093138,99119040,99143591,99099625,99116840,98777468,99071067,98997772,99077030,99148620,99076691,98777637,98818928,99104280,99118764,99011477,99078037,99102008,98783403,98783405,98783406,98783417,99007275,99129806,
							99138927,99104777,99119050,98924000,99150197,99150222,99147934,99147935,98978339,98978361,98978372,99049423,99075290,99158000,98977978,98977984,98978378,98998189,99049548,99049511,99049604,99156222,99169085,99118915,99159047,99074514,99075271,99039663,98977937,99075736,99075762,99078132,99144331,99147946,98978170,99131024,99094927,99116750,99116762,99127511,99142407,99155049,99103570,99039083,99159450,99076550,99155304,99155759,99155853,98997494,99169833,99156519,99144103,99158377,99077128,99078056,99088267,99089452,98997015,99090337,99076610,99150301,99074877,99155027,98841601,99156901,99075826,99150054,99011924,99113166,99113170,99158287,99098878,99149390,99070396,99101935,99139982,99130561,99114569,99156802,99113235,99158313,99035348,99073500,99090752,99011567,99090662,98988299,99091790,99145376,98965041,99088621,99150340,99128040,99142015,99113751,99169805,99096933,99145579,99147175,99075103,98789489,98789905,99102190,99126474,99126517,99129939,99148053,99148437,99150452,99150573,99159443,98826589,98913951,99112891,99092053,99142352,99156191,99097537,99073380,99008932,99034342,99095137,99075553,99117214,98772952,99126841,99127030,99030465,99139622,99147460,99147462,99074053,99156257,99116773,99069531,99159893,99170424,99091505,98820993,99006599,99104760,99113413,99075150,98792336,99127291,99147488,99147553,99147591,99154174,99156429,99158878,99098437,99144335,99116860,99169260,99169513,99140205,99092054,99087255,99087912,99127431,99105183,99142847,99147983,99151255,99150403,99015253,99118178,99030035,98826173,99143618,99159578,99169226,99089749,99087902,99060207,
							99127845,99088904,99142891,99073370,99118568,99170178,99146603,99143662,99170361,99171752,99090265,99090347,99009227,99077940,99086495,99086556,99086563,99129341,99129350,99129472,99032391,99151579,99089516,99156798,99156811,98911172,99086571,99097926,99009101,99128346,99129809,99092349,99143054,99143072,99101959,99129300,99152955,99098558,99114488,99118840,99141511,99148765,99149842,99149891,99091002,99097726,99171484,99171674,99171696,99171709,99171713,99169247,99168628,99169209,99170210,99119047,99299745,99299751,99299843,99299939,99300539,99308703,99312274,99313669,99129774,99130370,99220067,99061931,99156854,99156934,99220568,98793069,99226701,99277728,99277505,99279151,98794200,99190919,98924103,98924158,99227506,99233656,99015513,99158346,99229521,98997563,99231085,99236565,99303331,99219705,99228386,99237819,98792984,99218964,99278879,99158916,98911150,99129940,99190254,99287577,99179032,99219883,99301491,99288571,99021950,99232725,99233462,99158160,99159096,99095642,99227261,99302761,99114891,99126305,99127003,99190821,99049534,99119132,99227327,99227521,99298704,99234470,99239033,98997213,99118872,99126696,99156905,99103590,99114048,99114118,99232717,99234421,99287242,99230163,99235070,98972511,98972517,99088810,99119027,99119033,99119053,99157881,99234608,99238483,99228993,99229111,99076164,99129929,99130678,99150825,99179881,98850539,99277617,99277758,99128719,99244527,98972485,99115770,99127960,99225668,99228621,98978323,99128117,99300651,98819485,98820684,99277370,98812532,99179101,99278290,99118982,99119015,99234530,99226170,99277495,99075166,99206759,
							99234515,98845202,99299318,99186491,99186687,99283133,99158340,98971951,99118636,99118652,99158953,99118856,99247391,99113002,99116826,99192127,99231343,99278812,99279372,99293807,99289176,99309092,99293311,99294088,99279789,98978316,99302083,99185105,99230299,99114798,99190838,99277805,99277818,99128645,99180128,99307717,99075754,99150347,99307477,98784040,99065583,99206016,99277436,99225905,99228783,98940948,99293707,99277832,99277623,99118519,99158121,99218250,99234757,99209432,99209726,99128210,98978304,99277711,99278826,99158464,99190241,99113644,99129198,98997119,99094718,99279373,99279374,99288123,99288126,99288127,99234031,99304486,99114163,99115818,99230068,99115960,98772285,99232263,99305065,99157861,99100043,99187257,99219510,99228273,99102510,99297485,99313007,99313132,99126682,99158750,99225156,99175098)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/