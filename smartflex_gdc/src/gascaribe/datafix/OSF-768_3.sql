column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99514432,99518318,99413655,99620874,99584586,99584665,99426488,99510805,99601634,99475754,99380045,99510672,99510807,99413722,99374720,99521590,99512849,99397800,99386252,99417558,99551972,99467747,99467766,99468525,99520693,99555819,99406700,99390734,99416661,99551491,99584876,99443528,99551730,99551781,99552036,99584330,99461214,99379824,99379828,99391435,99379096,99634250,99518478,99513367,99632006,99514307,99518493,99379631,99452170,99488908,99463353,99620390,99469556,99449775,99513226,99426443,99374289,99519984,99508253,99379787,99379790,99591746,99373551,99512738,99611999,99450935,99450565,99451084,99408172,99413735,99527629,99535864,99389892,99405979,99521244,99533422,99510873,99510906,99510926,99510964,99381428,99391062,99634334,99584674,99551618,99382703,99413408,99634073,99614426,99416938,99601651,99631143,99631638,99558935,99440953,99475281,99396146,99633959,99461072,99578306,99576350,99632685,99551205,99406635,99533692,99549615,99381612,99391668,99607924,99531403,99391922,99405783,99389808,99391068,99391268,99395594,99395887,99406626,99408230,99409719,99389403,99390303,99403053,99375732,99406187,99407048,99407571,99408270,99395754,99389443,99389956,99374301,99407714,99407727,99404064,99403932,99389488,99391529,99390429,99396583,99391996,99403308,99408181,99392075,99390480,99378891,99398804,99397778,99404078,99380008,99409439,99409461,99409470,99389659,99396086,99392078,99380006,99398575,99398932,99388765,99390162,99379058,99390199,99396999,99404317,99380076,99380088,99389679,99375696,99391624,99390910,99391274,99389017,99407273,99386604,99389463,99407913,
							99398872,99379868,99405914,99391294,99396728,99398790,99398904,99393529,99409073,99388325,99392759,99394364,99392323,99408783,99395770,99409341,99390885,99386715,99388826,99392137,99398946,99387342,99404724,99409351,99389000,99396534,99398038,99395407,99406398,99395706,99395963,99406364,99395926,99396267,99395806,99406750,99409205,99408577,99389581,99387297,99389753,99395633,99406574,99391446,99409638,99409823,99389614,99395899,99405016,99389760,99390407,99387195,99403709,99398772,99403947,99399065,99390219,99389904,99395536,99391003,99407660,99386981,98845000,98845100,98858993,98859023,98859071,98859083,98858742,98857671,98842502,98845153,98828522,98829164,98832849,98783888,98853275,98853292,98853295,98854358,98852772,98852839,98807464,98865404,98865482,98853273,98854036,98850514,98866991,98853172,98859496,98812734,98844396,98844063,98825322,98838876,98842062,98853020,98853052,98853107,98823392,98852822,98858060,98863485,98850510,98827631,98852830,98852911,98854518,98853027,98856710,98830944,98867144,98855045,98853247,98844970,98820142,98827048,98832225,98853479,98852939,98852942,98858210,98859716,98859800,98859830,98859856,98843325,98843626,98840858,98853210,98853206,98820813,98840640,98840863,98864919,98787858,98854515,98853178,98853190,98819931,98824147,98860253,98844983,98852946,98843448,98852876,98853252,98858094,98843491,98821057,98820170,98812596,98827710,98820093,98842948,98820823,98843771,98843591,98854892,98854897,98854902,98854933,98854952,98854962,98805677,98826899,98840892,98850519,98858254,98850527,98852853,98852856,98823584,98852966,98852973,98852977,
							98831950,98844597,98853229,98870634,98852812,98840362,98842279,98827323,98825606,98842197,98844653,98838310,98850867,98832941,98823581,98843588,98843233,98859899,98852765,98852787,98852806,98856818,98828078,98838005,98863211,98863440,98825805,98859416,98865002,98843261,98845119,98870555,98829122,98823650,98823653,98820531,98827508,98844139,98838026,98843886,98850234,98852774,98854975,98854991,98854994,98857178,98858384,98858419,98826462,98853217,98837152,98837297,98844320,98844338,98863885,98843608,98858748,98844763,98840701,98864184,98824007,98827271,98823454,98844493,98844559,98855144,98858506,98858586,98859971,98859978,98842850,98854859,98854864,98854913,98854941,98866379,98866382,98853061,98864088,98842434,98843371,98827541,98805375,98855152,98865707,98826533,98843978,98844481,98844627,98855661,98856165,98856210,98856232,98856245,98857103,98859313,98864330,98856183,98781653,98859300,98812388,98823241,98832174,98850477,98855676,98844819,98842532,98854500,98858840,98864948,98821262,98823039,98854548,98826303,98859389,98850555,98857358,98864446,98838418,98856162,98859034,98819002,98864993,98865837,98865848,98865849,98865850,98865856,98853066,98853270,98854383,98827718,98852793,98852995,98853071,98865039,98854643,98868997,98869115,98869203,98837596,98856201,98856209,98856215,98856236,98856253,98856256,98857571,98857593,98859321,98865019,98865031,98865864,98857122,98826801,98858727,98860146,98865237,98856075,98854850,98857722,98869856,98825447,98852719,98856316,98798858,98852810,98852951,98853044,98853057,98853194,98863264,98864113,98865099,98866000,98856241,98866607,
							98841735,98871148,98858467,98855094,98869025,98829491,98838704,98820317,98849547,98852767,98852776,98852802,98852816,98852842,98856567,98854448,98854597,98854985,98855200,98858712,98832283,98858141,98859358,98866684,98855000,98854533,98855157,98841573,98844426,98869059,98829945,98829437,98852896,98852920,98852949,98853006,98853010,98853015,98856729,98856156,98857816,98859376,98859381,98863355,98857403,98866133,98859377,98859393,98858401,98830205,98843090,98843227,98857268,98857444,98871157,98859250,98826760,98830165,98783770,98849815,98853035,98853048,98853069,98853092,98853099,98853112,98853126,98853139,98823160,98843381,98856847,98859425,98838108,98863229,98866864,98858977,98858978,98858979,98858980,98853088,98854923,98857469,98869637,98838478,98838585,98823483,98845029,98828500,98828502,98828504,98828505,98828506,98853141,98853168,98853200,98853203,98853233,98853240,98853261,98844948,98981898,98998804,99008561,99012527,99015548,98972387,98972391,98978366,98992456,98898102,98989162,98997486,98972540,98972433,98972478,98987284,98845279,98970904,98989724,98924836,99005165,98977927,98998981,98979497,98997171,98997180,98997183,98978364,98972009,98977994,98997423,99021518,99021573,98823258,99021827,99021863,98997600,98924019,98972076,99017028,98995259,98998128,98972257,98997789,98998170,99006344,99005242,99008005,99008038,98982603,98978154,98978194,98978205,98988971,99005802,99008914,98972533,98845301,99018414,98972545,98944782,98997237,98978069,98993237,98993648,98981515,98998647,98987147,98993152,98997385,98909690,98978183,99006544,98954328,98827162,98832874,98812001,
							98954359,98997456,98993003,98978353,99005869,99021364,98998030,99020085,98979597,98980763,98940983,98983125,98997575,98828198,98978023,98978166,98978083,98993740,99014634,98977943,99018209,99018393,99018164,98922755,98979589,98998974,98992327,98978162,98840990,98965499,99006470,98992913,98992667,98992670,98993933,98983639,98982708,99013294,99021467,99021776,99021786,98996994,99011418,99013560,98986882,99006563,99006614,98967094,99014337,98979734,98840285,99016602,98981165,99022792,98840425,98987453,98981083,98980591,99005735,98979280,98979396,98782868,98857381,98857393,98986804,99006773,99006815,98980905,98987598,98987740,98987763,99006810,99022643,99022992,98981059,98987315,98982642,98993162,98993484,99006417,98918653,98940875,99013829,99009047,98986978,98987028,98987131,98996493,98910521,98983680,98981332,98919082)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/