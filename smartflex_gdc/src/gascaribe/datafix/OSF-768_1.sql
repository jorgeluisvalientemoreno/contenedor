column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99514376,99611955,99379982,99380085,99384855,99379055,99379454,99518015,99606040,99418227,99444764,99413364,99514148,99537006,99567238,99416751,99378879,99585254,99495028,99549999,99601641,99379178,99379902,99379912,99476191,99426132,99417187,99514310,99514344,99514356,99608053,99397923,99443442,99518241,99378874,99374074,99476121,99416959,99510824,99511157,99371064,99618411,99618492,99441487,99423268,99567139,99618851,99567059,99512831,99510857,99511616,99512175,99491731,99556237,99558219,99522262,99389012,99588507,99475637,99584551,99585109,99490032,99413640,99475868,99589896,99422236,99521457,99522025,99467458,99551630,99521084,99413091,99413187,99499288,99613717,99523339,99583458,99446574,99460568,99385086,99520925,99485000,99409897,99601957,99607010,99585078,99531617,99443502,99487455,99468903,99471011,99444362,99588699,99438727,99406295,99416681,99551942,99384576,99490766,99551775,99576987,99379699,99381182,99379701,99380103,99380109,99561510,99372066,99518442,99437011,99460593,99514123,99414795,99451018,99421599,99379189,99573818,99521744,99517278,99518259,99424787,99413040,99512791,99388639,99413065,99413071,99538357,99523914,99527051,99527768,99450816,99451956,99512805,99398060,99555461,99417326,99534623,99512811,99388182,99392985,99414829,99581842,99611809,99584328,99492888,99552141,99552381,99581562,99574508,99435190,99384683,99527807,99613408,99613980,99534512,99615248,99422293,99585256,99396139,99586306,99408878,99462887,99463612,99420277,99434348,99422376,99422618,99423485,99446410,99448894,99448951,99448352,99379767,99423081,99423187,99425016,
							99459656,99459683,99461379,99461389,99374039,99379068,99379947,99441965,99446629,99434414,99448749,99423450,99412985,99416222,99388831,99428009,99425498,99459728,99434320,99422016,99422024,99422176,99423505,99415263,99449068,99417163,99424132,99419971,99435184,99435257,99448718,99441800,99448809,99379996,99426571,99460645,99461477,99421882,99370889,99414640,99435165,99442511,99449265,99435220,99449594,99426042,99413390,99415752,99416642,99414787,99422834,99461549,99462356,99463077,99417124,99442049,99380067,99426406,99435328,99413938,99379237,99414417,99447100,99425433,99416783,99416911,99438315,99426933,99460739,99462411,99435921,99424924,99443249,99441686,99411992,99422471,99417375,99448326,99382421,99459890,99461612,99461656,99436458,99423646,99423946,99416210,99435296,99413197,99426487,99426543,99451231,99451243,99413562,99443098,99443595,99443668,99417739,99417757,99422661,99436918,99415418,99417222,99413428,99447523,99449748,99451506,99435956,99436989,99440907,99422552,99443751,99443832,99438891,99417997,99449059,99449378,99449774,99450317,99460892,99460914,99406725,99463200,99415178,99435612,99441821,99448694,99449112,99416851,99413824,99426829,99416673,99417012,99417049,99451523,99443091,99390733,99451690,99442518,99413463,99450490,99460060,99463241,99463246,99413702,99416391,99413572,99413761,99427706,99424460,99450457,99435912,99461857,99462602,99442505,99450540,99415389,99416580,99416664,99446596,99435100,99441086,99415141,99452182,99417534,99461050,99461878,99415192,99443608,99444101,99418989,99436583,99418485,99446534,99418915,99434567,99446462,
							99435496,99437748,99406157,99413084,99462667,99463383,99451142,99436329,99384093,99444326,99420862,99451885,99447062,99421381,99419457,99426582,99435641,99446941,99406057,99459402,99461185,99461964,99461965,99444564,99445265,99452155,99418946,99419068,99446736,99447071,99450549,99450608,99452147,99421613,99422561,99461212,99462011,99462812,99463634,99438538,99407744,99419941,99420068,99421868,99444783,99450726,99421886,99438163,99442535,99452236,99447950,99422290,99442836,99444456,99452067,99452101,99452244,99423021,99460334,99461509,99461828,99463689,99421988,99422381,99445121,99424188,99447724,99446437,99448739,99438288,99527041,99556679,99558630,99558686,99562588,99537182,99564375,99567930,99535683,99535730,99535854,99536006,99567172,99523701,99562818,99562866,99462739,99537702,99522806,99558710,99527902,99559166,99559312,99559327,99529806,99559066,99559304,99559322,99559325,99379734,99549652,99551672,99551709,99535210,99513024,99450865,99450914,99513390,99556939,99555456,99562911,99562963,99426184,99398028,99533412,99540518,99523542,99514457,99514460,99380027,99552027,99425212,99476156,99476171,99519872,99535666,99539766,99379652,99529699,99536395,99537034,99555655,99379933,99530440,99533541,99533604,99533798,99493879,99398004,99556654,99537809,99551671,99551685,99380000,99551697,99379954,99512571,99540558,99540676,99531211,99540207,99555249,99555292,99548417,99557311,99559156,99398045,99534342,99561680,99561739,99561750,99552291,99510133,99528515,99527673,99549409,99511270,99566683,99534327,99538413,99541101,99535494,99523552,99550990,99551313,99551376,
							99551629,99531306,99561456,99534915,99416527,99531531,99551657,99550730,99563394,99566833,99528004,99565629,99534925,99532850,99534354,99535231,99523379,99547933,99527818,99552205,99527709,99528254,99528376,99528349,99530926,99523649,99527936,99541390,99548009,99548518,99556540,99534650,99552100,99554572,99547548,99555477,99530088,99555446,99561281,99522840,99468805,99528279,99535359,99551600,99533953,99529797,99531087,99555259,99537033,99530226,99548740,99552214,99441271,99548012,99549155,99549253,99549562,99551381,99551410,99551421,99551690,99552045,99390153,99552547,99523562,99535911,99539156,99539214,99552169,99539166,99563403,99551444,99555216,99558048,99553122,99381241,99535153,99536887,99565578,99556145,99563914,99555463,99555525,99556664,99535082,99528025,99536091,99547836,99559292,99540150,99534954,99535143,99529225,99540182,99551573,99556306,99404221,99435272,99561562,99562141,99389509,99389601,99435156,99462151,99530036,99530237,99528332,99528333,99520238,99548358,99529708,99550461,99548937,99559541,99566430,99547799,99565763,99520568,99539133,99536506,99566685,99549207,99530050,99535875,99558327,99552397,99552091,99565742,99567389,99566606,99520573,99533637,99539195,99531134,99560607,99562245,99489595,99549362,99549376,99539693,99523447,99563460,99549702,99550770,99557897,99558313,99549482,99549660,99556406,99556409,99556447,99556452,99558445,99536731,99562025,99521563,99549460,99549565,99522966,99541253,99537753,99521846,99558583,99560687,99522792,99562145,99567369,99567443,99567545,99523600,99564439,99540429,99375445,99404107,99518305,99518311,
							99591693,99460563,99514422,99476364,99373440,99518271,99374067,99379882,99534591,99537242,99475939,99566747,99591215,99375638,99476010,99518330,99518346,99415033,99567519,99567530,99548395,99518363,99511103,99522844,99524109,99591517,99591556,99618798,99413885,99408250,99442329,99459025,99475671,99386334,99551962,99551977,99414383,99446536,99493574,99549042,99551755,99556472,99583807,99390691,99530502,99395391,99577134,99557555,99584928,99551815,99576808,99605883,99485448,99500696,99476213,99476221,99379205,99485688,99488322,99488466,99490283,99466262,99488093,99476256,99476107,99500647,99465758,99466585,99466586,99466587,99466588,99466589,99476151,99476196,99465097,99468449,99379493,99488215,99490963,99466208,99468110,99495418,99476064,99476218,99498860,99502014,99475891,99469700,99512373,99485859,99444808,99475925,99488422,99476204,99494496,99494806)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/