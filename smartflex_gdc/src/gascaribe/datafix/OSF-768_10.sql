column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99005006,99005024,98795203,98833516,98833532,98833541,98833545,98833559,98833571,98833575,98833576,98833596,98833597,98833609,98833652,98833658,98955131,98833510,98833649,98925317,98833500,98833525,98833530,98833543,98833558,98833560,98946583,98944065,98955138,98955161,98966875,98955126,98955132,98773699,98953713,98955136,98955155,98955160,98955127,98955128,98955171,99160150,99004998,99005003,99078410,99105238,99023066,99131427,99078363,99078400,99078408,99120220,99120251,99131425,99120192,99120197,99120258,99131440,99131441,99131474,99120193,99120196,99120200,99120226,99120234,99120235,98978767,99078365,99078378,99078390,99078404,99078409,99105211,99105215,99105219,98833602,98833508,98833521,98833536,98833625,98833645,98955130,98955134,98955135,99023042,99023043,98972713,98972745,98795201,98795206,99131459,99004987,99004991,99160115,99005001,99005002,98795219,98795222,98813387,99105256,99078370,99078383,99078398,98813395,98978739,98833581,98978743,99078386,99101714,99131452,99131481,99160127,99160144,99120201,99160139,99131444,99131446,99168847,99160105,99160106,99160132,99160136,99160140,99160117,99160137,99160141,99160134,99168748,99131422,99168752,99297189,99297197,99300215,99300217,99300235,99300238,99300245,99251809,99251996,99252002,99131423,99251287,99160104,99160112,99286199,99286232,99251330,99251331,99251382,99251398,99251440,99251222,99251243,98972737,98972751,98972741,98972742,99023054,99251359,99251851,99251947,99251950,99251990,99252052,99252055,99252092,99131429,99131437,99286188,99286214,99286269,99286300,99160149,99251932,99251944,99251992,99252114,
							99160110,99050329,99251774,99251780,99078367,99160113,99160128,99160133,99160143,99251360,99251519,99251655,99251784,99251911,99251937,99251989,99252001,99286255,99286289,99251527,99251739,99251899,99251909,99251997,99252075,99252093,98972723,99160109,99053703,99251077,99251857,99131428,99251993,99252016,98795220,99251100,98972735,98972746,98972747,98972750,99251930,99251942,99252011,99252020,99252049,99279535,99286253,99286278,99286288,99131430,99131436,99131462,99131469,99286314,99251411,99251420,99300761,99160118,99160119,99300767,98813403,99286227,99251053,99053832,99252180,99252189,99252088,99251035,99251080,99251110,99251076,99252102,99054309,99105222,99297171,98955145,98955157,99120194,99297196,99160130,99160135,99160146,99160147,99160102,99160103,99300784,99051074,99300206,99078391,99078392,99078396,99078401,99120215,99120230,99120242,99120249,99120255,99194426,99297176,99300210,99300216,99300231,99300237,99300248,99300249,99300251,99194413,99194407,99120229,99131442,99131449,99286211,99286218,99286282,99300764,99131421,99297177,99300011,99297193,99312718,99312727,99312728,99312729,99312731,99312734,99312742,99312743,99312744,99286301,99286303,99313008,99300777,99286193,99286198,99286202,99286243,99286246,99286262,99286272,99286275,99286304,99312717,99312726,99312733,99312753,99286240,99286249,99286268,99308521,99297440,99300779,99300790,99312716,99312736,99286222,99286245,99312714,99312724,99312749,99312748,99300246,99312755,99300770,99300774,99300220,99300222,99300244,99285258,99312712,99312746,99302610,99300214,99300227,99300241,98833643,98833648,98833661,
							98833665,98955148,99005018,99078372,99078389,98972718,99105252,99105235,99105236,99105243,99105245,98925319,98925320,99023033,99052119,99050112,99050505,98978754,98978770,99004983,99004984,99004986,99131435,99131438,99131451,99131454,99131468,99131477,99131479,99131480,98978737,98978748,98833504,98833507,98833519,98833520,98833535,98833540,98833554,98833555,98833564,98833573,98833616,98833630,98833654,98833670,99120252,99078358,99131443,99131457,99131463,99078351,98813388,98813389,98813392,98795202,98795209,99078375,99078382,99078397,99023064,99075005,99120239,99131447,99131455,99131473,99105240,99120224,99120247,99120248,99006338,99112520,99131431,98795223,99105213,99105214,99105225,99105228,99105251,99120210,99120246,99120259,99105220,99105223,99005008,99051159,99053016,99184323,99105242,99120198,99120238,99120250,99194423,99194425,98955173,99120221,99120223,99120232,98972731,98972736,99005009,99005012,99194405,99194411,99194420,98778296,98972715,99023051,99023061,99023063,99023068,98833664,98955125,98955137,99105216,99105246,99131434,99078376,98833529,98833621,98833623,98833626,98833644,98833647,98833655,98833656,99023057,98833502,98833522,98833531,98833562,99209911,99078353,99078371,99078399,99160114,99160125,99194422,99105254,99078381,99078403,98833515,98833524,98833537,98833548,98833561,98833582,98833588,98833589,98833593,98833601,98833646,99194410,98813411,99194408,99194412,98955169,98955170,99105239,99131426,99131460,99131471,99194416,99194421,99194427,98813394,98813396,99194418,99160131,99131445,99131485,99208191,99023055,99023065,99023067,99023046,99211237,
							99194409,99006343,99186679,98882920,99194424,99188490,99251344,99131433,99131465,99131466,98978764,99251034,99251078,98925321,98833526,98833550,98833569,98833574,98833595,98833635,99252742,99004990,99004993,99251339,99251345,99251441,99160120,99160123,99251733,99251878,99251910,98978765,98978773,99251079,99251274,99251293,99251340,99251412,99251499,99251544,99251680,99251879,99251897,99251945,99252050,99250996,99251740,99251741,99252004,99252047,99160124,99252173,98972738,98898560,98898569,99131483,99131486,99160151,98972721,98972739,98925318,99005016,99005019,99005025,98813384,99120236,99120202,99120213,99120218,99251071,99251175,98833511,99251443,99251453,99251504,99251599,99251935,99251656,99251813,99251866,99251875,99251900,99251916,99251936,99251940,99251975,99251985,99252051,99252178,99120195,99120199,99120217,98778287,98778314,99078360,99078373,99078374,99078387,99078393,99105209,99105253,99053142,98833659,98833663,98833669,99078354,99078362,99078369,99078384,99078405,99078406,98972754,99004988,99078380,99078385,98795198,98813398,98813400,98813406,98813408,99120227,99078356,99120216,99105221,99105226,99105229,99105247,99194414,99194419,99050717,99251325,99251341,99251635,99251704,99251855,99251872,99252003,99252017,99252032,99252043,99120214,99120228,99120253,99194406,99105224,99105237,99160148,99221704,99120225,99131456,99131470,99131453,99131458,99222909,99229037,99251601,99251776,99251787,99251859,99252048,99251810,99251812,99251864,99251870,99251948,99252104,99252006,99252143,99252172,99252327,99251381,99251460,99251591,99251013,99255389,98800034,98778292,
							98795207,98795208,98778285,98778304,98778307,98778308,98778291,98795214,98795215,98795221,98795205,98795216,98795224,98795197,98795200,98795213,98778294,98781475,98813397,98813402,98813407,98783699,98788818,98795210,98795211,98792449,98795196,98778298,98778311,98813410,98813382,98813391,98813390,98813405,98917209,98833620,98898552,98898558,98898568,98778302,98778305,98833518,98833523,98833539,98833587,98833590,98833607,98833617,98898565,98833549,98833568,98833604,98833605,98833618,98813401,98813409,98898567,98898572,98778301,98778306,98898566,98778300,98778310,98898553,98898556,98872703,98833517,98833538,98833565,98833583,98898554,98898555,98898557,98898571,98898563,98898564,98898559,98898561,98898570,98898562,98874317,99049975,98955151,98955139,98972749,98978760,98978763,98978771,98978741,98978744,98955146,98955166)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/