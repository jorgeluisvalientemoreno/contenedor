column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

declare

  nuCommentType   number;
  isbOrderComme   varchar2(4000);
  nuErrorCode     number;
  sbErrorMesse    varchar2(4000);

  -- Poblacion a la que aplica el Datafix
  CURSOR cuPoblacion
  IS
    with tbl_poblacion as (
      SELECT 257975319 AS ORDEN, TO_DATE('07/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 258257367 AS ORDEN, TO_DATE('23/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 258259851 AS ORDEN, TO_DATE('07/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 258408585 AS ORDEN, TO_DATE('26/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259056200 AS ORDEN, TO_DATE('28/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259109391 AS ORDEN, TO_DATE('27/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259124314 AS ORDEN, TO_DATE('29/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259305123 AS ORDEN, TO_DATE('29/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259577539 AS ORDEN, TO_DATE('05/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259591517 AS ORDEN, TO_DATE('04/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259709331 AS ORDEN, TO_DATE('07/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259743399 AS ORDEN, TO_DATE('03/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259746219 AS ORDEN, TO_DATE('03/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259900420 AS ORDEN, TO_DATE('04/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 259901948 AS ORDEN, TO_DATE('04/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260043945 AS ORDEN, TO_DATE('11/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260153373 AS ORDEN, TO_DATE('10/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260164291 AS ORDEN, TO_DATE('27/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260167860 AS ORDEN, TO_DATE('07/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260168069 AS ORDEN, TO_DATE('06/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260349966 AS ORDEN, TO_DATE('14/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260351881 AS ORDEN, TO_DATE('10/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260353465 AS ORDEN, TO_DATE('07/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260492212 AS ORDEN, TO_DATE('10/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260504485 AS ORDEN, TO_DATE('10/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260649486 AS ORDEN, TO_DATE('11/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260788257 AS ORDEN, TO_DATE('20/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260809017 AS ORDEN, TO_DATE('11/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260894487 AS ORDEN, TO_DATE('20/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260909755 AS ORDEN, TO_DATE('11/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 260914967 AS ORDEN, TO_DATE('20/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261078710 AS ORDEN, TO_DATE('14/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261098300 AS ORDEN, TO_DATE('18/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261100418 AS ORDEN, TO_DATE('12/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261161634 AS ORDEN, TO_DATE('14/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261203341 AS ORDEN, TO_DATE('24/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261203763 AS ORDEN, TO_DATE('24/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261204429 AS ORDEN, TO_DATE('18/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261256340 AS ORDEN, TO_DATE('18/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261272879 AS ORDEN, TO_DATE('25/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261276130 AS ORDEN, TO_DATE('25/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261276782 AS ORDEN, TO_DATE('25/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261394050 AS ORDEN, TO_DATE('18/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261405355 AS ORDEN, TO_DATE('26/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261409200 AS ORDEN, TO_DATE('19/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261431988 AS ORDEN, TO_DATE('19/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261531097 AS ORDEN, TO_DATE('19/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261623116 AS ORDEN, TO_DATE('20/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261674251 AS ORDEN, TO_DATE('28/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 261881437 AS ORDEN, TO_DATE('21/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 262040462 AS ORDEN, TO_DATE('21/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 262205302 AS ORDEN, TO_DATE('24/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 262238688 AS ORDEN, TO_DATE('25/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 262384344 AS ORDEN, TO_DATE('26/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 262747122 AS ORDEN, TO_DATE('28/10/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 263014964 AS ORDEN, TO_DATE('03/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 263261421 AS ORDEN, TO_DATE('02/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 263613366 AS ORDEN, TO_DATE('17/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264206297 AS ORDEN, TO_DATE('22/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264207555 AS ORDEN, TO_DATE('22/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264208259 AS ORDEN, TO_DATE('22/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264500253 AS ORDEN, TO_DATE('25/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264518423 AS ORDEN, TO_DATE('25/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264631422 AS ORDEN, TO_DATE('28/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264918263 AS ORDEN, TO_DATE('07/09/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 264921402 AS ORDEN, TO_DATE('29/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265222967 AS ORDEN, TO_DATE('01/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265301616 AS ORDEN, TO_DATE('01/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265361497 AS ORDEN, TO_DATE('25/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265363156 AS ORDEN, TO_DATE('24/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265636013 AS ORDEN, TO_DATE('30/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265635944 AS ORDEN, TO_DATE('30/11/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265829729 AS ORDEN, TO_DATE('01/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 265940808 AS ORDEN, TO_DATE('02/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 266033557 AS ORDEN, TO_DATE('05/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 266239536 AS ORDEN, TO_DATE('06/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 266253537 AS ORDEN, TO_DATE('06/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      SELECT 266554215 AS ORDEN, TO_DATE('09/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL UNION ALL
      -- OT Agregada por solicitud Usuario
      SELECT 269548431 AS ORDEN, TO_DATE('20/12/2022', 'DD/MM/YYYY') as NEW_FECH_FIN FROM DUAL
    )
    select  tbl_poblacion.*, oo.EXECUTION_FINAL_DATE, oo.EXEC_INITIAL_DATE
    from    open.or_order oo
            join tbl_poblacion on oo.order_id = tbl_poblacion.orden;
BEGIN
  dbms_output.put_line('---- Inicio OSF-OSF-970 ----');
  FOR reg in cuPoblacion
  LOOP
    BEGIN
      IF(reg.ORDEN IN (269548431,264918263)) THEN
        UPDATE  OPEN.OR_ORDER oo
        SET     oo.EXECUTION_FINAL_DATE = reg.NEW_FECH_FIN,
                oo.EXEC_INITIAL_DATE    = reg.NEW_FECH_FIN
        WHERE   oo.ORDER_ID = reg.ORDEN;
        COMMIT;
        dbms_output.put_line('Se actualiza la orden ['||reg.ORDEN||'] EXECUTION_FINAL_DATE actual ['||reg.EXECUTION_FINAL_DATE||'] - Nueva Fecha [' ||reg.NEW_FECH_FIN||'] y la EXEC_INITIAL_DATE');
      ELSE
        UPDATE  OPEN.OR_ORDER oo
        SET     oo.EXECUTION_FINAL_DATE = reg.NEW_FECH_FIN
        WHERE   oo.ORDER_ID = reg.ORDEN;
        COMMIT;
        dbms_output.put_line('Se actualiza la orden ['||reg.ORDEN||'] EXECUTION_FINAL_DATE actual ['||reg.EXECUTION_FINAL_DATE||'] - Nueva Fecha [' ||reg.NEW_FECH_FIN||']');
      END IF;
    EXCEPTION
      WHEN OTHERS THEN
        rollback;
        dbms_output.put_line('Error actualizando las fechas de la orden ['||reg.ORDEN||'] EXECUTION_FINAL_DATE actual ['||reg.EXECUTION_FINAL_DATE||'] - Nueva Fecha [' ||reg.NEW_FECH_FIN||']');
    END;
  END LOOP;
  COMMIT;
  dbms_output.put_line('---- Fin OSF-OSF-970 ----');
EXCEPTION
  WHEN OTHERS THEN
    rollback;
    dbms_output.put_line('---- Error OSF-OSF-970 ----');
    DBMS_OUTPUT.PUT_LINE('OSF-970 Error General no controlado --> '||sqlerrm);
END;
/

select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/