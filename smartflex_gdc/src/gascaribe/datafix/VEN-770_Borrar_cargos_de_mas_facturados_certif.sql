DECLARE
  nuNote          NUMBER (10);
  onuCodError     NUMBER;
  osbMensError    VARCHAR2(4000);

  CURSOR cuCargos IS
  SELECT cargcuco, cargnuse, cargconc, cargsign, sum(cargvalo) cargvalo, sum(cargvabl) cargvabl, sesususc
  FROM OPEN.CARGOS c, open.servsusc s
  WHERE c.CARGDOSO IN (
    'PP-174190171','PP-174538386','PP-174893704','PP-174904643','PP-175228757','PP-175314496','PP-176202504','PP-176206141','PP-176206149','PP-176339488','PP-176404913','PP-176471186','PP-176516823','PP-176697204',
    'PP-176783988','PP-177151552','PP-177730476','PP-177730556','PP-178000631','PP-178141442','PP-178213914','PP-178237836','PP-178599734','PP-178836754','PP-179080527','PP-179342664','PP-179564810','PP-179760009',
    'PP-179772348','PP-180029786','PP-180031043','PP-180095740','PP-180096702','PP-180118597','PP-180122496','PP-180258121','PP-180529329','PP-180817036','PP-180902919','PP-180945411','PP-180969726','PP-181236904',
    'PP-181826330','PP-181882394','PP-182099615','PP-182136595','PP-182219074','PP-182636491','PP-183000986','PP-183006410','PP-183007532','PP-183159939','PP-183165271','PP-183308985','PP-183548550','PP-183799546',
    'PP-183799745','PP-183800007','PP-184078434','PP-184150866','PP-184224743','PP-184224811','PP-184452142','PP-184499586','PP-184774135','PP-185033861','PP-185175524','PP-185280342','PP-185314842','PP-185318391',
    'PP-185393680','PP-185409327','PP-185593617','PP-185596665','PP-185656378','PP-185813530','PP-185890574','PP-185904580','PP-186107257','PP-186117774','PP-186143093','PP-186304647','PP-186304794','PP-186411354',
    'PP-186577400','PP-186601129','PP-186692900','PP-186715913','PP-186720384','PP-186740198','PP-186805443','PP-186811545','PP-186941307','PP-187061657','PP-187231620','PP-187413688','PP-187578605','PP-187609761',
    'PP-187626444','PP-187713348','PP-187890112','PP-187917867','PP-188194601','PP-188198596','PP-188403021','PP-188501765','PP-188699402','PP-188723076','PP-188757464','PP-188979361','PP-189022402','PP-189051233',
    'PP-189262105','PP-189349426','PP-189354989','PP-189441237','PP-189495322','PP-189554700','PP-189563328','PP-189593158','PP-189780414','PP-189889905','PP-189985765','PP-190033313','PP-190147145','PP-190200929',
    'PP-190210888','PP-190246557','PP-190263018','PP-190499453','PP-190501765','PP-190541875','PP-190546173','PP-190645038','PP-190656698','PP-190686635','PP-190693973','PP-190694186','PP-190752887','PP-190929760',
    'PP-190948140','PP-191030783','PP-191037305','PP-191084645','PP-191116700','PP-191226013','PP-191454110','PP-191628089','PP-191645343','PP-191755660','PP-191756013','PP-192024730','PP-192028549','PP-192079862',
    'PP-192184974','PP-192283560','PP-192483462','PP-192546153','PP-192616388','PP-192616580','PP-192695604','PP-192790886','PP-192970403','PP-192980100','PP-193018860','PP-193125608','PP-193185071','PP-193206355',
    'PP-193638382','PP-193798094','PP-193875743','PP-194065261','PP-194066594','PP-194363503','PP-194363561','PP-194368425','PP-194380218','PP-194533704','PP-194831746','PP-195028197','PP-195160412','PP-195390433',
    'PP-195980358','PP-196014667','PP-196489546','PP-196505852','PP-196604951','PP-196891333','PP-197049356','PP-197165944','PP-197444261','PP-197721438','PP-197875986','PP-197876012','PP-198628085','PP-198643013',
    'PP-198645312','PP-199110672'
  )
  AND c.cargnuse = sesunuse
  AND c.CARGFECR >= to_date('01-07-2023', 'dd-mm-yyyy')
  AND c.CARGFECR < to_date('05-08-2023', 'dd-mm-yyyy')
  AND c.CARGUSUA IN (5607)
  AND CARGUNID = 1
  AND c.CARGCUCO != -1
  group  by cargcuco, cargnuse, cargconc, cargsign, sesususc
  ORDER BY c.CARGCUCO DESC;

BEGIN
  pkErrors.SetApplication('CUSTOMER');

  -- Para cada registo
  FOR reg IN cuCargos LOOP
    --  Crea la nota CREDITO
    pkBillingNoteMgr.CreateBillingNote (reg.cargnuse,
                                        reg.cargcuco,
                                        GE_BOConstants.fnuGetDocTypeCreNote,
                                        SYSDATE,
                                        'NOTA PARA ANULAR CARGO DE VENTA CONSTRUCTORA JULIO-2023 - VEN-766',
                                        pkBillConst.csbTOKEN_NOTA_CREDITO,
                                        nuNote);

    -- se actualizan el cargcodo para que haga referencia a la nota
    FA_BOBillingNotes.Detailregister
    (
      nuNote,
      reg.cargnuse,
      reg.sesususc,
      reg.cargcuco,
      reg.cargconc,
      1,
      reg.cargvalo,
      reg.cargvabl,
      'NC-' || nuNote,
      'CR',
      'Y',
      NULL,
      'N',
      FALSE
    );
    dbms_output.put_line('Cargcuco: ' || reg.cargcuco || '-'  ||'cargcodo: ' || nuNote ||' - cargconc: '||reg.cargconc ||' - cargcaca:'||1);

    -- generamos saldo a favor si aplica
    pkAccountMgr.GenPositiveBal(reg.cargcuco, reg.cargconc);
    dbms_output.put_line('SA - Cargcuco: ' || reg.cargcuco || '-'  ||'cargcodo: ' || nuNote ||' - cargconc: '||reg.cargconc ||' - cargcaca:'||1);
  END LOOP;
  --
  COMMIT;
  --
  DBMS_OUTPUT.PUT_LINE('Proceso termina ok - cargos facturados');
EXCEPTION
  WHEN others THEN
  ROLLBACK;
  ERRORS.SETERROR();
  RAISE EX.CONTROLLED_ERROR;
END;
/