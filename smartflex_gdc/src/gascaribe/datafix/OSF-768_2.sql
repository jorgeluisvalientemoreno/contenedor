column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99485895,99485896,99492840,99493061,99469027,99466960,99494109,99471371,99518488,99467932,99466691,99467523,99379977,99380021,99408641,99414802,99495566,99475965,99485911,99485934,99475911,99469787,99466137,99496209,99496447,99518024,99518424,99448288,99484879,99475276,99475569,99473051,99485981,99473304,99468050,99495907,99397827,99471289,99499825,99469476,99493410,99470037,99470347,99500397,99496683,99509705,99474582,99390920,99468307,99476126,99465059,99497071,99499673,99499726,99498833,99498874,99473650,99472552,99500225,99508301,99511550,99469896,99508185,99511399,99510087,99469783,99469249,99441416,99486138,99469212,99493428,99493512,99475311,99467441,99473215,99508660,99509028,99511171,99511180,99467453,99468158,99473822,99498943,99475644,99510941,99502069,99487646,99471293,99470573,99499048,99499870,99499966,99434578,99492957,99414711,99509419,99486414,99511188,99477853,99478081,99512007,99512846,99518300,99518419,99518450,99473986,99486779,99486829,99499128,99499157,99486409,99381211,99472943,99511512,99475037,99507954,99485249,99473859,99512878,99518440,99508005,99510612,99510909,99493418,99470539,99469141,99474574,99471547,99474626,99495930,99512952,99512957,99518289,99475075,99511230,99512651,99514139,99514418,99518275,99518341,99518483,99518502,99518508,99514189,99518322,99474380,99408646,99475685,99484614,99486361,99497099,99414853,99512785,99514455,99470859,99512855,99518343,99518374,99485921,99509738,99511289,99512944,99512997,99408235,99511437,99446490,99517271,99487025,99473562,99417645,99434932,99434947,99470489,99511722,99518471,99444953,99513140,
							99421723,99473317,99518292,99518377,99517283,99517286,99514271,99510892,99512979,99518337,99473966,99461749,99487297,99473552,99474001,99511170,99511246,99518399,99518462,99488095,99490948,99511804,99487051,99511254,99512845,99487807,99475510,99487099,99463198,99494722,99485218,99485292,99489740,99514317,99518296,99513616,99510595,99510862,99463348,99489242,99475747,99494296,99476200,99513033,99513137,99508825,99514162,99475117,99495998,99478050,99473786,99514347,99514373,99514427,99449574,99379076,99412979,99621450,99507922,99451861,99451057,99552406,99450856,99379125,99537508,99426519,99514341,99611859,99537566,99371408,99591313,99537684,99521406,99388920,99536612,99619301,99614696,99555262,99611653,99388970,99390807,99413494,99522041,99493412,99388842,99493475,99576895,99434549,99383148,99534590,99602312,99578893,99575903,99562008,99562078,99575836,99410493,99576876,99605745,99391338,99391556,99551700,99369441,99475989,99465393,99512601,99618907,99379986,99518356,99425082,99398064,99462065,99501480,99442008,99512937,99536797,99398141,99425420,99475866,99619203,99476165,99379837,99391105,99460256,99450849,99552257,99489952,99500760,99379684,99513575,99517349,99618730,99537217,99611657,99511298,99517261,99537214,99576109,99591643,99512223,99510727,99475768,99475848,99587523,99566576,99422941,99522982,99607944,99582188,99585362,99612316,99584529,99394783,99520579,99557530,99381305,99462014,99551519,99604157,99605414,99576455,99413075,99461466,99577910,99380117,99389641,99390376,99417150,99379029,99420745,99421672,99518327,99585896,99397049,99379914,99379917,99396680,
							99392081,99511208,99511265,99576866,99621008,99550410,99517343,99518267,99518284,99374483,99517237,99621188,99621300,99510911,99510895,99389770,99615276,99461800,99461150,99608346,99441077,99441342,99493359,99555457,99620481,99557837,99473293,99392559,99561643,99441477,99551607,99613256,99496246,99617340,99392031,99441922,99442033,99436149,99524851,99551487,99604036,99607511,99608380,99581817,99588382,99612763,99612794,99606358,99611748,99613280,99613353,99615106,99616095,99616204,99591790,99615959,99517275,99585331,99591855,99590235,99601141,99601156,99601163,99573812,99573823,99590823,99612808,99612815,99612405,99613021,99613364,99613397,99613401,99613700,99613723,99613752,99613757,99606140,99606188,99583742,99621537,99611422,99621977,99611540,99611571,99623551,99623555,99581502,99574518,99591634,99591968,99590059,99613806,99594430,99611399,99502132,99575788,99512863,99567506,99514299,99601628,99577060,99577218,99577342,99575967,99603758,99607016,99608728,99452249,99611983,99614083,99614087,99587607,99594012,99574506,99623034,99609646,99426459,99511810,99511860,99589950,99591814,99591876,99577681,99379481,99583722,99591406,99605345,99573758,99460032,99607249,99587657,99611795,99611842,99606504,99452032,99582870,99613973,99600773,99615622,99615673,99612860,99620533,99608127,99575597,99577226,99425582,99425678,99510986,99451129,99577091,99591200,99588866,99603924,99603932,99604023,99605478,99607929,99589685,99581616,99594303,99620873,99618403,99618369,99617988,99619523,99612414,99578386,99592591,99445598,99487118,99575002,99584578,99585323,99388876,99602906,99602916,
							99584589,99577168,99577191,99593728,99608049,99552221,99612009,99589860,99613138,99581401,99613512,99612673,99583189,99619144,99590408,99620295,99535081,99619021,99620443,99619210,99619886,99618263,99618521,99619426,99617950,99620580,99583182,99621011,99584819,99584868,99589089,99585458,99604203,99604259,99594094,99584067,99584148,99611455,99611800,99611960,99612246,99468615,99611826,99614813,99461537,99588012,99602176,99602107,99619938,99620697,99612643,99622065,99617860,99578357,99578497,99614613,99419814,99574145,99521781,99550538,99584417,99608179,99578537,99612950,99612975,99612989,99612048,99381367,99614841,99584747,99615701,99417102,99601887,99602085,99606453,99621781,99621827,99621833,99601648,99618484,99612773,99617017,99584686,99586245,99602331,99583806,99580065,99608249,99578959,99591729,99601122,99613026,99614050,99614994,99615014,99615444,99615507,99615742,99573751,99613194,99583168,99617431,99611597,99613238,99614033,99614065,99585378,99589532,99589707,99486975,99602473,99605978,99601187,99606904,99608344,99584621,99583622,99585169,99592786,99588383,99612682,99613628,99578254,99614312,99588858,99615403,99615811,99585488,99603576,99582209,99583922,99613941,99601891,99602020,99619309,99622715,99618439,99618595,99621700,99621713,99621571,99574502,99577170,99593275,99590024,99584546,99584557,99441674,99441739,99585581,99584528,99584846,99584251,99608368,99586149,99583503,99583667,99614672,99602007,99579278,99615390,99603847,99607968,99621864,99607705,99608136,99588895,99585168,99590374,99585099,99591789,99600799,99602897,99603176,99610008,99607239,99616409,
							99615682,99577097,99577517,99612463,99616731,99618390,99574919,99608155,99611522,99590546,99593417,99589189,99602690,99606273,99606329,99589137,99603217,99607169,99607265,99608586,99575020,99602158,99583595,99574996,99615215,99615632,99621681,99611306,99620581,99549270,99611884,99612364,99575193,99593856,99594382,99576527,99604168,99589036,99575994,99590498,99576010,99611176,99576764,99608329,99584562,99605104,99619005,99619296,99606877,99618362,99619481,99576670,99618198,99575977,99463314,99524938,99589686,99549471,99578302,99585979,99604395,99604735,99621466,99612768,99577699,99581548,99616853,99620940,99577438,99619000,99620846,99612725,99589131,99419547,99375739,99379027,99418019,99590762,99476055,99591570,99591660,99438686,99591763,99514281,99514628,99379765,99374642,99514362,99380093,99566407,99555775,99581495)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/