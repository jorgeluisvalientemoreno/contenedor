column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;


DECLARE
    -- Datos de Entrada
    NUORDERID_1     OR_ORDER.ORDER_ID%TYPE;
    
    -- Datos de salida
    NUPACKAGEID     MO_PACKAGES.PACKAGE_ID%TYPE;
    NUID            FM_POSSIBLE_NTL.POSSIBLE_NTL_ID%TYPE;
    NUORDERID       OR_ORDER.ORDER_ID%TYPE;
    NUORDERID_ACT   OR_ORDER_ACTIVITY.ORDER_ACTIVITY_ID%TYPE;
    
    Cursor cuOrdenesRegistradas
    IS
    select  /*+ LEADING(oo oa) */
            oo.ORDER_ID,
            oo.ORDER_STATUS_ID as Estado_orden_lab,
            oo.task_type_id as TT_OT_laboratorio,
            -- datos de la orden padre
            oo1.ORDER_ID as ot_pad,
            oo1.ORDER_STATUS_ID as Estado_orden_pad,
            oo1.task_type_id as TT_OT_pad,
            oa.PRODUCT_ID, --> Producto con posible pérdida no técnica
            se.sesususc as contrato,
            oa.SUBSCRIBER_ID as SUBSCRIBER_ID,
            ad.GEOGRAP_LOCATION_ID,--> Ubicación geográfica
            oa.ADDRESS_ID, --> Dirección de posible pérdida no técnica
            se.SESUSERV as PRODUCT_TYPE_ID, --> Tipo de producto de posible pérdida no técnica
            'Proyecto Creado por el Caso OSF-775' as COMMENT_, --> Comentario
            5 as DISCOVERY_TYPE_ID, --> Tipo de descubrimiento
            0 as VALUE_, --> Valor de posible pérdida
            NULL as INFORMER_SUBS_ID, --> Subscriptor Informante
            'R' as STATUS, --> R - Proyecto
            oa.ACTIVITY_ID as ITEMS_ID,
            NULL as PERSON_ID,
            -- datos para la creacion de la orden 
            oo.OPERATING_SECTOR_ID as OPERATING_SECTOR_ID
    from    open.or_order oo
            inner join open.or_order_activity oa on oo.ORDER_ID = oa.ORDER_ID
            inner join open.servsusc se on se.sesunuse = oa.PRODUCT_ID
            inner join open.ab_address ad on oa.address_id = ad.address_id
            inner join open.or_related_order r1 on (oo.ORDER_ID = r1.RELATED_ORDER_ID)
            inner join open.or_order oo1 on (r1.ORDER_ID = oo1.ORDER_ID)
    where   oo1.task_type_id  = 12669
    and     r1.rela_order_type_id IN ( 
                                    2   --> Regeneración
                                    ,13 --> Orden Relacionada
                                  )
    and     oo.order_id in ( 
                            257317678, 253984645, 240375773, 241132715, 232617934, 256982152, 236093713, 252333294, 258270989, 238374405, 252480762, 234264289,
                            238371834, 220407484, 194374329, 198131418, 196503839, 215327091, 254056024, 251568482, 259040470, 196117147, 252823765, 193969417,
                            196124031, 246578480, 263792041, 237118641, 232370975, 215971195, 224888546, 206151901, 208658899, 238914966, 238203366, 219742910,
                            214549059, 196678503, 195127463, 240375971, 240482310, 218152316, 241595272, 234303745, 189033751, 218155778, 232160282, 244086675,
                            195556519, 256252035, 238473476, 261427196, 253985467, 230224997, 250424724, 237314785, 205412604, 255096391, 234968075, 209103180,
                            251354429, 195682727, 238351425, 236295509, 195556561, 237445747, 228924994, 213790588, 259257118, 249476465, 236898778, 259578926,
                            196042202, 249548711, 253806903, 198267671, 262324749, 240368953, 195556394, 194587927, 257710423, 234264082, 219745436, 238990369,
                            220408293, 198909474, 245774457, 223954299, 199574423, 193770880, 224658203, 193622904, 206381342, 234459897, 263039127, 235225508,
                            210193463, 238909148, 238908163, 237424276, 238058613, 210527317, 226984221, 251425293, 209211876, 225458164, 232082203, 258513243,
                            259749655, 259748883, 238378494, 222120645, 232558288, 240373901, 238174875, 240375173, 257317619, 238862623, 232555715, 196671749,
                            238373408, 196669894, 240475385, 249834760, 252480424, 215627884, 237582795, 255295307, 234254229, 245327570, 254293706, 257321806,
                            238059937, 238666185, 228091130, 193282765, 230473455, 237582531, 257127085, 223810099, 232617737, 215625833, 262607774, 248203894,
                            263946495, 217439265, 194031394, 189409604, 214553144, 214570347, 191311953, 191318954, 235229623, 263039548, 235229513, 261428338,
                            239938193, 235442591, 212779681, 193768336, 220639723, 198709219, 219737320, 231088405, 246941977, 221539628, 233872551, 235352744,
                            256020854, 191318961, 263947327, 214734681, 235448129, 219579782, 191843708, 213054455, 238005405, 232541082, 190426793, 189941866,
                            219583267, 216062380, 188742639, 262611116, 257182842, 232554651, 258626463, 237035879, 238375438, 222085655, 256998453, 223810422,
                            222120201, 216960572, 229726098, 233629510, 220898806, 215328554, 220894447, 253979065, 230474079, 209950667, 219917806, 214264838,
                            215627278, 253978981, 222082765, 238340077, 230809161, 214265868, 238373306, 210528131, 237582585, 198598159, 215099783, 238373546,
                            237582652, 229211846, 238368774, 263965027, 242025118, 209191796, 231649676, 225457578, 188051233, 218162358, 219912210, 250376554,
                            187367832, 208668803, 240277542, 218940486, 251733257, 186668331, 231547862, 178277235, 255690397, 186955181, 251568434, 209470419,
                            253111736, 228601700, 186673960, 263262717, 187609614, 218289918, 217950593, 237650703, 239687609, 218359290, 205702639, 255214498,
                            250175716, 240269557, 251567855, 253260628, 240742022, 237317031, 231771169, 234965078, 218147900, 186667568, 237655239, 200697689,
                            198131871, 252464869, 254632320, 240284578, 178276335, 251587546, 243250059, 240044665, 246446590, 263965508, 205802697, 199395560,
                            242635785, 252333420, 206611422, 234094496, 185501218, 218289290, 212455703, 236349920, 185604007, 236005694, 218169951, 249833742,
                            228924779, 184587216, 239175181, 258332436, 236462028, 234570754, 198132093, 230149492, 235611495, 240363726, 234095356, 232391473,
                            264209894, 199996322, 212437372, 251733233, 199847610, 196992420, 265631848, 249710960, 264522303, 256159568, 254257181, 248126828,
                            252685256, 247354983, 242637728, 254486711, 239941840, 240587608, 247791469, 246326843, 239180882, 243137036, 262618964, 247898029,
                            265447544, 241410009, 249694015, 240581865, 241231342, 262608894, 254914854, 245483283, 248203953, 246078863, 246308858, 242492252,
                            261882728, 248231861, 244829809, 266259156, 246836309, 242026635, 243303283, 254140610, 240044492, 265041445, 256979299, 248203832,
                            242014780, 262037992, 240268044, 251568144, 254632157, 245225596, 260166029, 249695020, 242923444, 243857916, 261882632, 254055992,
                            262041700, 246072670, 246164973, 246332881, 241083634, 256538775, 256539350, 254486151, 246678691, 241918992, 252119251, 263262960,
                            247646283, 246678932, 248126786, 246577939, 260649523, 254330468, 254483419, 254947519, 254331873, 242339715, 247490720, 249702068,
                            248760728, 249809586, 247645460, 242105852, 263264144, 254914930, 249696682, 251370343, 215625701, 244382382, 245087339, 243250031,
                            249694178, 242738203, 259253769, 247645339, 259888694, 259254018, 246578358, 262205009, 236901294, 263263106, 242729026, 246078749,
                            263263573, 249784699, 245950589, 246198153, 255096422, 241366453, 255588521, 252615657, 254483968, 262204860, 242320746, 254915023,
                            254141144, 242342159, 246842250, 245887856, 248232792, 262375136, 247899172, 254485194, 259036023, 266564839, 261429245, 242342098,
                            253472844, 247897869, 266254523, 247113098, 246842297, 247489180, 245475056, 240590649, 248760783, 257815229, 262375517, 262377483,
                            248351589, 240268265, 248350995, 254213581, 254485423, 254485689, 254213617, 254486797, 254140750, 254485847, 254213625, 254213651,
                            255084267, 254213502, 254914637, 254486374, 254213548, 254213513, 254213486, 262376441, 254213598, 240268696, 240585516, 244450701,
                            243434109, 262613348, 247471580, 255643482, 246166484, 255373237, 253709058, 246165173, 241308465, 246165570, 247485928, 247440917,
                            247490439, 246677475, 262871897, 241123300, 259749950, 247487248, 245327658, 253111704, 242504045, 243694194, 244450767, 254294864,
                            249609489, 243694122, 244451405, 251976559, 243135651, 249607637, 260355382, 243697196, 239687100, 262608613, 245895320, 249602891,
                            247567914, 268862169, 247567464, 240584637, 255748568, 240588537, 254294531, 244445795, 263463987, 241789833, 256021143, 251424207,
                            263793815, 240264203, 249836117, 263257631, 245327395, 249694090, 244451520, 240485215, 246072580, 249613163, 266557130, 240263159,
                            244450242, 256159582, 241083620, 263612176, 249878637, 244014600, 262965478, 248352022, 239941671, 248760677, 260166085, 248760142,
                            252796127, 239938764, 261432922, 259081543, 246678767, 242923454, 260648801, 244821635, 250175992, 260647446, 242923525, 264600834,
                            246446164, 240581168, 247604454, 244619473, 249796517, 251475665, 259046823, 245087290, 241002202, 265364853, 241001960, 260078769,
                            260648556, 246680475, 241004129, 247365383, 263263349, 241141677, 261708475, 264869011, 252686025, 216851432, 259041310, 251371881,
                            256854599, 245202276, 255750305, 263040019, 261882918, 241138558, 245327472, 245327339, 241681885, 240268565, 244243022, 263628487,
                            246601329, 249165992, 244451906, 244451726, 244451318, 247431674, 244449824, 249711238, 241918747, 240263970, 209254604, 244445286,
                            249597995, 261421416, 261207331, 252480456, 242508291, 250913743, 246072395, 252941087, 215626895, 247431631, 243304118, 244693577,
                            257553384, 255644300, 264497208, 243136134, 242508112, 248202962, 241929704, 249167888, 250913268, 248256025, 240586125, 249165734,
                            240262948, 247787697, 257812786, 255641634, 247452473, 239683039, 251945283, 262871644, 241130818, 258281214, 259748968, 259749597,
                            253978652, 260333855, 246836247, 261077120, 250913093, 250262585, 254294942, 251423065, 260506519, 259749494, 243435814, 249163205,
                            250912917, 241929615, 210527613, 258513482, 253112374, 249166547, 250752298, 246584920, 243303321, 249520650, 263040253, 242631100,
                            246169896, 263469069, 245909352, 245475082, 263965702, 246577984, 244008957, 245502504, 266564482, 241245329, 245475069, 245236848,
                            249477038, 246578157, 264366326, 245475022, 245778841, 246331432, 246078808, 245778855, 245778902, 246076037, 244381418, 244009224,
                            246446321, 245087437, 265953473, 251372186, 264868430, 245087232, 244605944, 246577912, 239687612, 264868627, 245475039, 242631026,
                            250530911, 246166228, 247645575, 244447327, 261882558
    );

    PROCEDURE REGISTER_FMCAP
    (
        INUPRODUCT              IN      FM_POSSIBLE_NTL.PRODUCT_ID%TYPE,
        INUGEOGRALOCATION       IN      FM_POSSIBLE_NTL.GEOGRAP_LOCATION_ID%TYPE,
        INUADDRESSID            IN      FM_POSSIBLE_NTL.ADDRESS_ID%TYPE,
        INUPRODUCTTYPE          IN      FM_POSSIBLE_NTL.PRODUCT_TYPE_ID%TYPE,
        ISBCOMMENT              IN      FM_POSSIBLE_NTL.COMMENT_%TYPE,
        INUDISCOVERYTYPE        IN      FM_POSSIBLE_NTL.DISCOVERY_TYPE_ID%TYPE,
        INUVALUE                IN      FM_POSSIBLE_NTL.VALUE_%TYPE,
        ISBINFORMER             IN      FM_POSSIBLE_NTL.INFORMER_SUBS_ID%TYPE,
        ISBSTATUS               IN      FM_POSSIBLE_NTL.STATUS%TYPE,
        INUACTIVITYID           IN      GE_ITEMS.ITEMS_ID%TYPE,
        INUPERSONID             IN      FM_POSSIBLE_NTL.PERSON_ID%TYPE,
        INUORDERID_1            IN      OR_ORDER.ORDER_ID%TYPE,
        ONUID                   OUT     FM_POSSIBLE_NTL.POSSIBLE_NTL_ID%TYPE,
        ONUORDERID              OUT     OR_ORDER.ORDER_ID%TYPE,
        ONUPACKAGEID            OUT     MO_PACKAGES.PACKAGE_ID%TYPE
    )
    IS
        RCPOSSIBLENTL       DAFM_POSSIBLE_NTL.STYFM_POSSIBLE_NTL;
        
        NUPRODUCTTYPE       FM_POSSIBLE_NTL.PRODUCT_TYPE_ID%TYPE;
        NUADDRESS           FM_POSSIBLE_NTL.ADDRESS_ID%TYPE;
        NUGEOGRAPHLOCATION  FM_POSSIBLE_NTL.GEOGRAP_LOCATION_ID%TYPE;
        
        CSBNTL_ENTITYNAME   CONSTANT    GE_ENTITY.NAME_%TYPE        := 'FM_POSSIBLE_NTL';
        CSBNTL_SEQNAME      CONSTANT    VARCHAR2(2000)              := 'SEQ_FM_POSSIBLE_NTL_123873';
        CNURECORDEXISTS     CONSTANT    GE_MESSAGE.MESSAGE_ID%TYPE  := 900255;

    BEGIN
    
        NUPRODUCTTYPE       := INUPRODUCTTYPE;
        NUADDRESS           := INUADDRESSID;
        NUGEOGRAPHLOCATION  := INUGEOGRALOCATION;

        IF INUPRODUCT IS NOT NULL THEN

            ONUID := FM_BCREGISTER.FNUPENDNTLBYPROD(INUPRODUCT);
            NUPRODUCTTYPE   := DAPR_PRODUCT.FNUGETPRODUCT_TYPE_ID(INUPRODUCT);
            NUADDRESS       := DAPR_PRODUCT.FNUGETADDRESS_ID(INUPRODUCT);

        END IF;
        
        IF NUADDRESS IS NOT NULL AND NUADDRESS <> -1 AND NUPRODUCTTYPE IS NOT NULL THEN
            ONUID := FM_BCREGISTER.FNUPENDNTLBYADDR(NUADDRESS, NUPRODUCTTYPE);
        END IF;
        
        IF NUADDRESS IS NOT NULL AND NUADDRESS <> -1 THEN
            NUGEOGRAPHLOCATION := DAAB_ADDRESS.FNUGETGEOGRAP_LOCATION_ID(NUADDRESS);
        END IF;

        IF NUGEOGRAPHLOCATION IS NOT NULL
            AND NUPRODUCTTYPE IS NOT NULL
            AND (NUADDRESS IS NULL OR INUADDRESSID = -1) THEN
            ONUID := FM_BCREGISTER.FNUPENDNTLBYGEOLOC(NUGEOGRAPHLOCATION, NUPRODUCTTYPE);
            IF ONUID IS NOT NULL THEN
                NULL;
            END IF;
        END IF;

        RCPOSSIBLENTL.POSSIBLE_NTL_ID       :=  GE_BOSEQUENCE.FNUGETNEXTVALSEQUENCE(CSBNTL_ENTITYNAME, CSBNTL_SEQNAME);
        RCPOSSIBLENTL.STATUS                :=  ISBSTATUS;
        RCPOSSIBLENTL.PRODUCT_ID            :=  INUPRODUCT;
        RCPOSSIBLENTL.PRODUCT_TYPE_ID       :=	NUPRODUCTTYPE;
        RCPOSSIBLENTL.GEOGRAP_LOCATION_ID   :=	NUGEOGRAPHLOCATION;
        RCPOSSIBLENTL.ADDRESS_ID            :=	NUADDRESS;
        RCPOSSIBLENTL.REGISTER_DATE         :=	UT_DATE.FDTSYSDATE;
        RCPOSSIBLENTL.DISCOVERY_TYPE_ID     :=	INUDISCOVERYTYPE;
        RCPOSSIBLENTL.INFORMER_SUBS_ID      :=	ISBINFORMER;
        RCPOSSIBLENTL.COMMENT_              :=  ISBCOMMENT;
        RCPOSSIBLENTL.VALUE_                :=	INUVALUE;
        RCPOSSIBLENTL.PERSON_ID             :=  INUPERSONID;

        RCPOSSIBLENTL.ORDER_ID  := INUORDERID_1;

        DAFM_POSSIBLE_NTL.INSRECORD(RCPOSSIBLENTL);
        
        ONUID := RCPOSSIBLENTL.POSSIBLE_NTL_ID;
        
        commit;

    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE(' Error al crear el proyecto para la orden ['||INUORDERID_1||'] Error = '||sqlerrm);
    END REGISTER_FMCAP;


BEGIN
    DBMS_OUTPUT.PUT_LINE('------------- INICIO OSF-775 -------------');
    
    FOR reg IN cuOrdenesRegistradas
    LOOP
        BEGIN
          REGISTER_FMCAP
          (
              INUPRODUCT              => reg.PRODUCT_ID,
              INUGEOGRALOCATION       => reg.GEOGRAP_LOCATION_ID,
              INUADDRESSID            => reg.ADDRESS_ID,
              INUPRODUCTTYPE          => reg.PRODUCT_TYPE_ID,
              ISBCOMMENT              => reg.COMMENT_,
              INUDISCOVERYTYPE        => reg.DISCOVERY_TYPE_ID,
              INUVALUE                => reg.VALUE_,
              ISBINFORMER             => reg.INFORMER_SUBS_ID,
              ISBSTATUS               => reg.STATUS,
              INUACTIVITYID           => reg.ITEMS_ID,
              INUPERSONID             => reg.PERSON_ID,
              INUORDERID_1            => reg.ot_pad,
              ONUID                   => NUID,
              ONUORDERID              => NUORDERID,
              ONUPACKAGEID            => NUPACKAGEID
          );

          DBMS_OUTPUT.PUT_LINE('Se crea el Proyecto FMCAP ['||NUID||']'
                              ||' - Orden Laboratorio ['||reg.ORDER_ID||']'
                              ||' - Orden Padre ['||reg.ot_pad||']'
                              ||' - Producto ['||reg.PRODUCT_ID||']'
                              ||' - Contrato ['||reg.contrato||']'
                            );
          COMMIT;
        EXCEPTION
            WHEN OTHERS THEN
              rollback;
              DBMS_OUTPUT.PUT_LINE('Error REGISTER_FMCAP: '||sqlerrm);
        END;
        
    end loop;
    DBMS_OUTPUT.PUT_LINE('------------- FIN OSF-775 -------------');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error General OSF-775: '||sqlerrm);
END;
/

select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/