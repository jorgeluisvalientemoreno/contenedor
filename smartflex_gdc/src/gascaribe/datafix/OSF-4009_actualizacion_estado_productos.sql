SET SERVEROUTPUT ON;
COLUMN dt NEW_VALUE vdt
COLUMN db NEW_VALUE vdb
SELECT to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db FROM dual;
SET SERVEROUTPUT ON SIZE UNLIMITED 
SELECT to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio FROM dual;

prompt "-----------------"
prompt "Aplicando Entrega OSF-4009"
prompt "-----------------"

DECLARE
    nuerror     NUMBER;
    sberror     VARCHAR2(2000);
    
    CURSOR      cuservsusc IS
        SELECT A.* 
        FROM   OPEN.servsusc A
        WHERE  sesunuse IN (SELECT  product_id
                            FROM    /*+ PR_BORetireServChrgPrd.cuGetServChargesProds */
                            OPEN.pr_product P
                            WHERE   NOT EXISTS (SELECT
                                                'X'
                                                FROM   OPEN.mo_motive M, OPEN.mo_packages pack, OPEN.ps_motive_status ms
                                                WHERE  P.product_id = M.product_id
                                                AND    M.package_id = pack.package_id
                                                AND    pack.motive_status_id = ms.motive_status_id
                                                AND    ms.is_final_status   = 'N')
                            AND     P.product_type_id = 6121 -- Tipo de producto "Cobro de servicios"
                            AND     OPEN.pkdeferredmgr.fnugetdeferredbalservice(P.product_id) <= 0
                            AND     OPEN.pkbccuencobr.fnugetoutstandbal(P.product_id) <= 0
                            AND     OPEN.pkbccuencobr.fnuclaimvaluebyprod(P.product_id) <= 0                           
                            AND p.product_id in (
                                52587226, 51966959, 50923313, 51887216, 50996463, 52277634, 52277648, 52277689, 52280202, 52282489,
                                51738478, 52209109, 52861319, 51161933, 51911913, 52306046, 52312140, 52322928, 52322968, 52324361,
                                51151466, 50975234, 51415936, 51886646, 52653971, 52329512, 52338572, 52350589, 52350756, 52350782,
                                50887813, 50898202, 50899152, 50904378, 50904892, 52360967, 52360979, 52360987, 52360991, 52373147,
                                50907198, 50908335, 50908425, 50909220, 50911475, 52376826, 52389133, 52389138, 52392693, 52403768,
                                50912901, 50920863, 50920922, 50922034, 50922062, 52409041, 52421103, 52427151, 52427162, 52428537,
                                50923488, 50923767, 50923913, 50925289, 50927247, 52434375, 52437297, 52445468, 52446026, 52446129,
                                50930467, 50930566, 50935921, 50936039, 50936865, 52446393, 52446793, 52472865, 52474590, 52485697,
                                50937841, 50941602, 50943896, 50944683, 50946325, 52488773, 52490641, 52492294, 52493483, 52499321,
                                50948972, 50973138, 50977995, 50979514, 50998066, 52501971, 52505265, 52510717, 52524976, 52526261,
                                51006149, 51007356, 51011307, 51014951, 51028116, 52526676, 52544377, 52545115, 52551494, 52552001,
                                51040557, 51058338, 51086036, 51086485, 51097070, 52553325, 52553330, 52556835, 52558764, 52559036,
                                51097396, 51097409, 51097429, 51102356, 51103497, 52559286, 52559357, 52560287, 52563287, 52566973,
                                51104684, 51107294, 51113243, 51116748, 51118225, 52568475, 52568493, 52568510, 52577590, 52577781,
                                51132442, 51147422, 51147927, 51148344, 51148737, 52578363, 52588683, 52588890, 52589409, 52589410,
                                51151401, 51151447, 51151657, 51151719, 51161650, 52589560, 52592693, 52592705, 52593892, 52594062,
                                51169659, 51176341, 51176374, 51176686, 51181201, 52594097, 52594109, 52601179, 52601228, 52604663,
                                51181870, 51182724, 51182966, 51226979, 51228704, 52614391, 52621803, 52632080, 52642435, 52649314,
                                51231468, 51241243, 51241268, 51271024, 51272325, 52659771, 52664599, 52670901, 52679207, 52679852,
                                51272729, 51272772, 51273861, 51274437, 51274966, 52679875, 52682775, 52692542, 52692739, 52694997,
                                51277720, 51277748, 51278493, 51279139, 51279177, 52695010, 52696145, 52698805, 52703585, 52704752,
                                51279424, 51279490, 51280718, 51281892, 51283481, 52706556, 52706565, 52716168, 52727749, 52744573,
                                51283896, 51315616, 51315762, 51343687, 51343768, 52744583, 52744707, 52752057, 52752061, 52757018,
                                51345486, 51345502, 51345669, 51345966, 51347712, 52758928, 52758934, 52758942, 52759226, 52762843,
                                51348756, 51349515, 51349698, 51351756, 51356361, 52774427, 52781995, 52787560, 52802363, 52808660,
                                51356443, 51400836, 51401383, 51407708, 51407767, 52810480, 52817998, 52818343, 52820354, 52821771,
                                51407780, 51408242, 51408260, 51408264, 51408284, 52826024, 52826122, 52828104, 52828112, 52839066,
                                51408720, 51408760, 51408952, 51409044, 51409148, 52839078, 52840668, 52841536, 52842820, 52842892,
                                51416306, 51422941, 51425072, 51426347, 51427875, 52856027, 52856380, 52856482, 52856485, 52856585,
                                51435109, 51436505, 51437281, 51440361, 51440531, 52859923, 52860058, 52860068, 52860080, 52864343,
                                51442448, 51444914, 51454490, 51456964, 51458086, 52865272, 52865277, 52865287, 52869343, 52870496,
                                51461172, 51461801, 51469845, 51486859, 51490098, 52875150, 52875167, 52877630, 52877695, 52879260,
                                51495998, 51514065, 51514109, 51518081, 51518153, 52884758, 52889763, 52893501, 52894575, 52897479,
                                51526255, 51531806, 51542426, 51544480, 51547743, 52897529, 52900782, 52901743, 52901997, 52902014,
                                51558917, 51559022, 51559156, 51563344, 51575844, 52902037, 52902044, 52902073, 52903998, 52904028,
                                51581855, 51593851, 51601549, 51604844, 51607910, 52904068, 52910840, 52910882, 52910899, 52911772,
                                51608264, 51614387, 51615766, 51624577, 51630187, 52912402, 52916579, 52917679, 52917740, 52924126,
                                51641176, 51664283, 51683023, 51683471, 51714130, 52924615, 52924673, 52937304, 52943580, 52944515,
                                51730975, 51751322, 51751341, 51786926, 51828833, 52945325, 52946210, 52946221, 52946222, 52946223,
                                51839604, 51881987, 51909577, 51923379, 51931314, 52948796, 52949537, 52958351, 52958529, 52960266,
                                51935017, 51936254, 51977816, 51980161, 51988303, 52960532, 52961253, 52961265, 52961287, 52961307,
                                51991081, 51991085, 52024564, 52025989, 52028311, 52961314, 52961679, 52961682, 52962543, 52965791,
                                52031814, 52033616, 52040024, 52056313, 52059726, 52968586, 52971021, 52971056, 52971077, 52971245,
                                52068911, 52069103, 52072202, 52075359, 52080352, 52971248, 52971250, 52971255, 52973320, 52977939,
                                52091714, 52098786, 52104402, 52104414, 52104421, 52977958, 52980326, 52982324, 52983458, 52984219,
                                52104430, 52112770, 52130297, 52133323, 52139974, 52986537, 52986550, 52986559, 52986571, 52986606,
                                52141558, 52141571, 52154372, 52163077, 52168037, 52986637, 52993984, 52993990, 52993994, 52994005,
                                52193643, 52193655, 52208801, 52208802, 52210157, 52994009, 52998726, 52998910, 52998914, 52998931,
                                52212088, 52213579, 52227029, 52228044, 52228074, 52998942, 52998953, 52998955, 52999553, 
                                52241380, 52256914, 52264100, 52264109, 52276028)
                                )                   
        AND sesuesfn <> 'C'                    
        AND nvl(sesusafa,0) = 0
        AND sesuesco <> 92;

    rcservsusc      servsusc%rowtype;
    TYPE tytbservsusc  IS TABLE OF servsusc%rowtype INDEX BY BINARY_INTEGER;
    tbservsusc tytbservsusc;
BEGIN
    
    if pktblconfesco.fblexist(/*min sig:*/inucoecserv=>6121/*number*/,inucoeccodi=>92/*number*/) then
        dbms_output.put_line('Registro (6121, 92) existe en confesco, no se crea');
    else
        dbms_output.put_line('Registro No existe (6121, 92), se crea');        
        insert 
        into confesco (COECSERV, COECCODI, COECFUFA, COECFACT, COECDICO, COECGECA, COECREDA, COECTECS, COECREGE, COECREGL, COECRVAD, COECIDRV)
        values(6121, 92, NULL, 'N',	0, 'N',	'N', '--', NULL, NULL, NULL, NULL);
        
        COMMIT;
    end if;
    
    
    OPEN    cuservsusc;
    FETCH   cuservsusc BULK COLLECT INTO tbservsusc;
    CLOSE   cuservsusc;
    
    dbms_output.put_line('Cantidad de productos: '||tbservsusc.COUNT);
    IF tbservsusc.COUNT <= 0 THEN    
        RETURN;    
    END IF;
    
    FOR I IN tbservsusc.FIRST .. tbservsusc.LAST LOOP
        
        rcservsusc :=  tbservsusc(I);
        
        --actualiza servsusc
        update open.servsusc
        set sesuesco = 92,
            sesufere = sysdate
        where sesunuse = rcservsusc.sesunuse;
        
        --actualiza pr_product 
        update open.pr_product 
        set product_status_id = 16,
            retire_date = sysdate
        where product_id = rcservsusc.sesunuse;
        --pkg_producto.practualizasoloestadocorte(rcservsusc.sesunuse, 16);
               
        dbms_output.put_line('Producto: '||rcservsusc.sesunuse||' actualizado.');
            
    END LOOP;

    COMMIT;
EXCEPTION
    WHEN ex.controlled_error THEN
        RAISE ex.controlled_error;
    WHEN OTHERS THEN
        ERRORS.seterror;
        RAISE ex.controlled_error;
END;
/

prompt "-----------------------"
prompt "-----FINALIZA-----"
prompt "-----------------------"
prompt "-----Fin Aplica Entrega OSF-4009-----"
prompt "-----------------------"
SELECT to_char(sysdate, 'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin FROM dual;
prompt Fin Proceso!!
SET SERVEROUTPUT OFF
QUIT
/