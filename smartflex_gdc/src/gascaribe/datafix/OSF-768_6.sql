column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

DECLARE

    CURSOR cuDiferidos IS
		SELECT 	*
		FROM 	open.diferido
		WHERE 	difecodi in (99218350,99231340,99232574,99119079,99129274,99130442,98972482,98972550,99179430,99170644,99230839,99233295,99129223,99252085,99062242,99238995,99156915,99104713,99225487,99218071,98792830,98840410,99118241,99252476,99232361,99118851,99239753,99231107,99214131,98850485,99231199,99245139,99232912,99233169,99229783,99229262,99245072,98924066,99228471,99228973,99118991,99226757,98981304,99241328,98840436,99252867,99252914,99259847,99232462,98997392,98845253,99118940,99206749,99075658,99234005,99228251,99243216,99232522,99094905,99129478,99234194,99242557,99128336,99158512,99239002,99239017,99239458,99229903,99075865,99234871,99130517,99232874,99233341,99252889,99186732,99158409,99232327,98898045,99213268,99221703,99228051,98978005,99221687,99230509,99237125,98793914,98852726,98977934,99246309,98850506,98998023,98998072,99225975,99230442,99244645,99225881,98954379,99237713,99128204,99066227,99228336,99228389,99228481,99229584,98792498,99156928,99094766,99218441,99234702,99235189,99222780,99144250,99175445,99179540,99179642,99179783,99211486,99212848,98788961,98786658,98820433,98820632,99221941,99238781,99075803,99227018,99228131,99228283,99233603,99241570,99241590,99241630,99255988,99225990,99225491,99226973,99227324,98840484,99046051,99075924,99114662,99187647,98793056,98793062,99230265,99234434,99223499,99213721,98965981,99241672,99233450,99241198,99218563,98964685,98964895,99223859,99075863,99228319,99228637,99238979,99239052,99222452,99247539,99179054,98897857,99239109,99229314,99229537,99228814,99227615,99234652,99113213,99180060,99228589,99228725,99234733,99168766,
							99179924,99179380,99179390,99225304,99226602,99150176,99225165,99241306,99225379,99225604,99225902,99228830,99238897,99238904,99239064,99247566,99187613,99176851,99232714,99229344,99251242,99263259,99227898,99179352,98949398,99226917,99180011,99226872,99227157,99223662,99223278,99248570,99209334,99086984,99239585,99227211,99227297,98772419,99226566,99227914,99228408,99227935,99227519,99228099,99235399,99236364,99237133,99251688,99251908,99242231,98790651,99210850,99241438,99089473,99226765,99227183,99087479,99225235,99249009,99175045,99180517,99247463,99065871,99266493,99264265,99222101,99228464,99252393,99252464,99252499,99252671,99226549,99242480,99226728,98798844,99180914,99233691,99233872,99238951,98987725,99247553,99251984,99241532,99102591,99218301,99249150,99249160,99249252,99249359,99237780,99013349,99252836,99226490,99227754,99227951,99242442,99242519,99225893,99241522,99226710,99252126,99252136,99252240,99225607,99221378,99242471,99248175,99222396,99223015,99241378,99101982,99236625,99236926,99092483,99248061,99223232,99226750,99241661,99232277,99252318,99224872,99250334,99223800,99147192,99229704,99227219,99251929,99104274,99234496,99234582,99234588,99249879,99249993,98910294,99251249,99222936,99223042,99252354,99252372,98791995,99242508,99250878,99251061,99213758,99245510,99250091,99227913,99252061,99252407,99223542,99225131,99227258,99227413,99248944,99232424,99252099,99252111,99249323,99244839,99246673,99174165,99252428,99252730,99173493,99234491,99240145,99252535,99252560,99252159,99252508,99251847,99252217,99231180,99252873,99258398,99245151,99250458,
							99250899,99252603,99252615,98811669,98806977,98787661,98792777,98794682,98818973,98819052,98783850,98801941,98810757,98794206,98771884,98782645,98793995,98772347,98793643,98808733,98781664,98789560,98819067,98819136,98806075,98808829,98794183,98777472,98777538,98772986,98800885,98808947,98809007,98800919,98806460,98808942,98773017,98800800,98807747,98783968,98777664,98794056,98781531,98809045,98809063,98812279,98772001,98809096,98776804,98778200,98792703,98788861,98783452,98794092,98794100,98810466,98810543,98812427,98812500,98812523,98790711,98783698,98784244,98792700,98783894,98788919,98809296,98772504,98772901,98773012,98807556,98792816,98793986,98784627,98789186,98784190,98799232,98783439,98812653,98812739,98797270,98810191,98772337,98793072,98773307,98788205,98799177,98801502,98788480,98792304,98805382,98818359,98792426,98782375,98773022,98773250,98798229,98772262,98792688,98789435,98799361,98801783,98811082,98794030,98812713,98772348,98794763,98772780,98776426,98789722,98792296,98799410,98802247,98810256,98798327,98773349,98799644,98799851,98807229,98807576,98790203,98797794,98788829,98791913,98818828,98784315,98799665,98784928,98783556,98792043,98782503,98799601,98797883,98772771,98772855,98782451,98781800,98812717,98773838,98782048,98791969,98791977,98799818,98805303,98807273,98799451,98799500,98781889,98800934,98783937,98783960,98792486,98811348,98783660,98817834,98817835,98797959,98798173,98805731,98805337,98792556,98783067,98799605,98819430,98819500,98819118,98805829,98783982,98810683,98797603,98917208,98895486,98918324,98918359,98918476,98918514,98893073,
							98916066,98916807,98841757,98921144,98918645,98895165,98917254,98917287,98874275,98874130,98845353,98897903,98910686,98920944,98845295,98845246,98873779,98873832,98845383,98892240,98874010,98910493,98910520,98896337,98910758,98871789,98874326,98845335,98873947,98916504,98891444,98845348,98898094,98910731,98845269,98921875,98897839,98897846,98915986,98839132,98898493,98897906,98897929,98896164,98916611,98894458,98872702,98874230,98910912,98872831,98882551,98897977,98897986,98832949,98893880,98908280,98910970,98872959,98909820,98873785,98897346,98874838,98872947,98895022,98892384,98873190,98873793,98874023,98889643,98898095,98897989,98904415,98911110,98880530,98880574,98871690,98890476,98891297,98891327,98916839,98917143,98907083,98881673,98904505,98906607,98881832,98881968,98885778,98897901,98874038,98882524,98907534,98882566,98910303,98907680,98840453,98906636,98916249,98872917,98894182,98908516,98911480,98898432,98885329,98891669,98890743,98889827,98909528,98916296,98903587,98907618,98917539,98782039,98886262,98882124,98894081,98894113,98919300,98889207,98895537,98890472,98890948,98914163,98772801,98890266,98891621,98891221,98897438,98905775,98889654,98892257,98908708,98909438,98921021,98921229,98881738,98891202,98914173,98914274,98827052,98892187,98897002,98892170,98897854,98898488,98911622,98891316,98891486,98914524,98892822,98908831,98889649,98890848,98914396,98917958,98921322,98891523,98909431,98892355,98913057,98891560,98904231,98917998,98898250,98903268,98921542,98919369,98891361,98905458,98892468,98776089,98892358,98893350,98916746,98892043,98910150,98891342,
							98891318,98921669,98885216,98916354,98916709,98904546,98909158,98911485,98889805,98910783,98891957,98897183,98916343,98920667,98919159,98885709,98890668,98921451,99037669,99061178,99062694,98954336,99040527,99040864,99030669,99032607,99021878,98791721,99044416,99049350,98971081,99021903,98831745,98895207,98972497,99044794,99061674,99061698,98789910,99031828,98845369,99071470,99037570,98794004,98944861,98845320,98845339,98845345,98845381,99045065,98812624,98978139,98845360,99045593,98978043,98978207,98997450,99009156,99059742,99045042,99062741,99049618,99060176,99060544,98845281,99032770,99029835,99031162,99041194,99041247,98777534,98923692,98965749,99016490,99031919,99031688,99049160,98988903,99041574,99042064,98840949,99029468,99030430,98953716,98972269,99045194,99049552,99059410,99032615,99029654,99029773,99038279)
		AND 	exists (select 'x' from open.suscripc where difesusc = susccodi and suscnupr = 0);
		
	TYPE tytbDiferidos IS TABLE OF cuDiferidos%ROWTYPE INDEX BY BINARY_INTEGER;
	tbDiferidos tytbDiferidos;
	
	nuErrorCode 	NUMBER;
    sbErrorMessage 	VARCHAR2(4000);
	nuIndex 		BINARY_INTEGER;
	
	nuPorcentaje 	NUMBER := 0;
	nuInteresPorc	NUMBER := 0;
	nuDifemeca		diferido.difemeca%TYPE;
	nuDifespre		diferido.difespre%TYPE;
	nuDifesape		diferido.difesape%TYPE;
	nuDifenucu		diferido.difenucu%TYPE;
	nuDifecupa		diferido.difecupa%TYPE;
	nuDifefagr		diferido.difefagr%TYPE;
	nuDifesusc		diferido.difesusc%TYPE;
	nuDifecodi		diferido.difecodi%TYPE;
	nuQuotaValue  	diferido.difevacu%TYPE;
	nuDifevatd 		diferido.difevatd%TYPE;
	nuDifenuse		diferido.difenuse%TYPE;
	nuDifeinte		diferido.difeinte%TYPE;
	nuDifevacu		diferido.difevacu%TYPE;
	nuNominalPerc 	NUMBER;
	nuRoundFactor 	NUMBER;
	inuIdCompany  	NUMBER := 99;
	
	nuReporte		NUMBER;
	nuConsecutivo	NUMBER := 1;
BEGIN
	
	OPEN cuDiferidos;
	FETCH cuDiferidos BULK COLLECT INTO tbDiferidos;
	CLOSE cuDiferidos;
	
	nuIndex := tbDiferidos.FIRST;
	
	nuReporte := SQ_REPORTES.NEXTVAL;
	
	INSERT INTO REPORTES(REPONUME, REPOAPLI, REPOFECH, REPOUSER, REPODESC) VALUES (nuReporte,'OSF-768',SYSDATE,'OPEN','Datafix DIFERIDOS OSF-768');
	
	LOOP
		EXIT WHEN nuIndex IS NULL;

		BEGIN
		
			nuDifemeca := tbDiferidos(nuIndex).difemeca;
			nuDifespre := tbDiferidos(nuIndex).difespre;
			nuDifesape := tbDiferidos(nuIndex).difesape;
			nuDifenucu := tbDiferidos(nuIndex).difenucu;
			nuDifecupa := tbDiferidos(nuIndex).difecupa;
			nuDifefagr := tbDiferidos(nuIndex).difefagr;
			nuDifesusc := tbDiferidos(nuIndex).difesusc;
			nuDifecodi := tbDiferidos(nuIndex).difecodi;
			nuDifevatd := tbDiferidos(nuIndex).difevatd;
			nuDifenuse := tbDiferidos(nuIndex).difenuse;
			nuDifeinte := tbDiferidos(nuIndex).difeinte;
			nuDifevacu := tbDiferidos(nuIndex).difevacu;
			
			--Calcula el interes nominal
			pkDeferredMgr.ValInterestSpread(nuDifemeca, -- Metodo de Calculo
												nuInteresPorc, -- Porcentaje de Interes (Efectivo Anual)
												nuDifespre, -- Spread
												nuNominalPerc -- Interes Nominal (Salida)
												);

			-- Obtiene el valor de la cuota
			pkDeferredMgr.CalculatePayment(nuDifevatd, -- Saldo a Diferir (difesape)
											   nuDifenucu, --(nuDifenucu - nuDifecupa), -- Numero de Cuotas  diferido
											   nuNominalPerc, -- Interes Nominal
											   nuDifemeca, -- Metodo de Calculo
											   nuDifefagr, --nuDifespre,              -- Spread
											   nuInteresPorc + nuDifespre, -- Interes Efectivo mas Spread
											   nuQuotaValue -- Valor de la Cuota (Salida)
											   );

			--  Obtiene el factor de redondeo para la suscripcion
			FA_BOPoliticaRedondeo.ObtFactorRedondeo(nuDifesusc, nuRoundFactor, inuIdCompany);

			--  Aplica politica de redondeo al valor de la cuota
			nuQuotaValue := round(nuQuotaValue, nuRoundFactor);

			--Actualizar el valor de las cuotas en el diferido y asigna porcentaje 0 al diferido
			UPDATE	diferido
			SET 	difeinte = nuPorcentaje, difevacu = nuQuotaValue
			WHERE 	difecodi = nuDifecodi;
			
			nuIndex := tbDiferidos.NEXT(nuIndex);
			
			INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2)
			VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue);
			
			nuConsecutivo := nuConsecutivo + 1;
			
			COMMIT;
			
		EXCEPTION
			WHEN OTHERS THEN
				Errors.setError;
				Errors.getError(nuErrorCode, sbErrorMessage);
				ROLLBACK;
				INSERT INTO REPOINCO(REINREPO, REINCODI, REINLON1, REINLON2, REINLON3, REINLON4, REINDES3, REINDES4, REINVAL1, REINVAL2, REINOBSE)
				VALUES (nuReporte, nuConsecutivo, nuDifecodi, nuDifesusc, nuDifenuse, nuDifecupa, nuDifeinte, nuPorcentaje, nuDifevacu, nuQuotaValue, SUBSTR(sbErrorMessage, 0, 2000));
				nuConsecutivo := nuConsecutivo + 1;
				COMMIT;
		END;
	END LOOP;

	COMMIT;

EXCEPTION
    WHEN ex.CONTROLLED_ERROR  THEN
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR CONTROLLED ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
    WHEN OTHERS THEN
        Errors.setError;
        Errors.getError(nuErrorCode, sbErrorMessage);
        dbms_output.put_line('ERROR OTHERS ');
        dbms_output.put_line('error onuErrorCode: '||nuErrorCode);
        dbms_output.put_line('error osbErrorMess: '||sbErrorMessage);
END;
/
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/