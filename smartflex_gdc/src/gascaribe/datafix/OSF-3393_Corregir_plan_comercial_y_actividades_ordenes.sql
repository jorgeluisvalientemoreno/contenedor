column dt new_value vdt
column db new_value vdb
select to_char(sysdate,'yyyymmdd_hh24miss') dt, sys_context('userenv','db_name') db from dual;
set serveroutput on size unlimited
execute dbms_application_info.set_action('APLICANDO DATAFIX');
select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_inicio from dual;

begin
  /*
    Datafix para corregir el plan comercial y actividad de las ordenes solicitadas.
    Esto solo se aplica cuando no se puede anular la venta para hacer una nueva
    Caso OSF-3393
  */

  Declare

  Cursor CuOr_order_activity is
      select * from open.or_order_activity a
            where a.package_id in (219049265,219048207,219048082,219048293,219048365,219049222,219049226,219049245,219049255,219048081,219048102,219048225,219048219,219048306,219048757,219048984,219049017,219049069,
      219049082,219049092,219049123,219049117,219049232,219048966,219049161,219049189,219048766,219048800,219048974,219048436,219048462,219048467,219048491,219048498,219048518,219048522,219048547,219048526,
      219048622,219048617,219048647,219048654,219049272,219049285,219049393,219049319,219049358,219049371,219049382,219049400,219048855,219048872,219048880,219048326,219049138,219049170,219049386,219049417,
      219049562,219049578,219048131,219048503,219048532,219048591,219048778,219048867,219048908,219049076,219049207,219049261,219048665,219048681,219048686,219048701,219048747,219048088,219048402,219048905,
      219049131,219048312,219048335,219048342,219048368,219048129,219048539,219048942,219049250,219049278,219049444,219049588,219049289,219049306,219049335,219049431,219049482,219049498,219049517,219049567,
      219049604,219049620,219048299,219048574,219048607,219048633,219048696,219048724,219049295,219049315,219049330,219049349,219049364,219049625,219049698,219049733,219048753,219048762,219048782,219048813,
      219048842,219048862,219048851,219048429,219048348,219048458,219048087,219048553,219048919,219048939,219048951,219049051,219049055,219049066,219049011,219049738,219049743,219049353,219049375,219049412,
      219049453,219049502,219048482,219048602,219048826,219049535,219049507,219049629,219049636,219049646,219049668,219049683,219049711,219049728,219048121,219048388,219048487,219048587,219048658,219048381,
      219049755,219048096,219048080,219048090,219048901,219048930,219048957,219048963,219048971,219048998,219048821,219048837,219049214,219049438,219049458,219049468,219049473,219049758,219049767,219048406,
      219048641,219048706,219048891,219049072,219049108,219048104,219048091,219048079,219048264,219048143,219048255,219048992,219049021,219049030,219049095,219049101,219049219,219048092,219048320,219048269,
      219048359,219048414,219048445,219048140,219048084,219048095,219049111,219049116,219049146,219049150,219049169,219048144,219049477,219049487,219049522,219048287,219048376,219048426,219048629,219049004,
      219048566,219048673,219049185,219049192,219049201,219049526,219049532,219049544,219049550,219049556,219049583,219048098,219048103,219048330,219048253,219048393,219048450,219048720,219048730,219048741,
      219048773,219048789,219048612,219048913,219049046,219048478,219049592,219049600,219049609,219049640,219049651,219049661,219049674,219049688,219049694,219048099,219048203,219051671,219051611,219051790,
      219052248,219052170,219052306,219052653,219052464,219052760,219052745,219052624,219052799,219052068,219051960,219052593,219051939,219052087,219052318,219052512,219051910,219052091,219051670,219051875,
      219052002,219052502,219052662,219051734,219051975,219051643,219051776,219052129,219052239,219052814,219052404,219052104,219052645,219052788,219052121,219052635,219052863,219051665,219052039,219052226,
      219052348,219052751,219052867,219052124,219052114,219052233,219052517,219051925,219052072,219052667,219051818,219051652,219052387,219052727,219052755,219052048,219052160,219052281,219052470,219052723,
      219051676,219051861,219051980,219052731,219051830,219051968,219052598,219052739,219051661,219051992,219052266,219051655,219052042,219051824,219052195,219052604,219052059,219052254,219052394,219051617,
      219052372,219051945,219052296,219052836,219051656,219051983,219052136,219052535,219051613,219052331,219052554,219052872,219051638,219051849,219052109,219052418,219052678,219052212,219052423,219052261,
      219051622,219052166,219052245,219052311,219052451,219052572,219052765,219052885,219051767,219052180,219052342,219052714,219052563,219051998,219052337,219052540,219052657,219051649,219051745,219051899,
      219052063,219052438,219052010,219052140,219052291,219052576,219051787,219052581,219051814,219051731,219052379,219052400,219052640,219052782,219051755,219051890,219052026,219052548,219052672,219052879,
      219051987,219052150,219052484,219052769,219052192,219052448,219052443,219051954,219052184,219052301,219052498,219051761,219052270,219052434,219052507,219052630,219052691,219052827,219052841,219051781,
      219051922,219052154,219052708,219051905,219052032,219052354,219052361,219052493,219052569,219052619,219051881,219051614,219051809,219051929,219052175,219052327,219052457,219052488,219052682,219052851,
      219051836,219052080,219051637,219051885,219052021,219052218,219052366,219052615,219052610,219052846,219051634,219051802,219051949,219051896,219052075,219052201,219052428,219052775,219051871,219052189,
      219051855,219051865,219052096,219052521,219052687,219051797,219052532,219052695,219052821,219051740,219052411,219052793,219048886,219049034,219049040,219049181,219049344,219049408,219049491,219049512,
      219049703,219049715,219049724,219049750,219048281,219048355,219048807,219049762,219048417,219048583,219048596,219048690,219048710,219048736,219049421,219049437,219049657,219048235,219048250,219048512,
      219048561,219048945,219049238,219049301,219049311,219052052,219052528,219052588,219052705,219052802,219052807,219052831,219052860,219051646,219051612,219051664,219051615,219051610,219051749,219051771,
      219051839,219051844,219051963,219052017,219052146,219052221,219052242,219052275,219052287,219052475);
      
      --
      vsbsolici varchar2(15) := NULL;
      vsbproduc varchar2(15) := NULL;
      vsporden  varchar2(15) := NULL;
      vsptipotr varchar2(15) := NULL;

  Begin
    
      FOR Reg in CuOr_order_activity LOOP

        -- Inicializamos variables
        vsbsolici := reg.package_id;
        vsbproduc := reg.product_id;
        vsporden  := reg.order_id;
        vsptipotr := reg.task_type_id;
              
        -- Actualizamos plan Comercial
        -- Actualizmaos plan comercial en PR_PRODUCT
        update open.pr_product p
          set p.commercial_plan_id = 48
        where p.subscription_id = reg.product_id;
        
        -- Actualizamos plan comercial en MO_MOTIVE
        update open.mo_motive m
          set m.commercial_plan_id = 48
        where m.package_id in reg.package_id;
        --
        --
        -- Actualizamos Actividad para el CxC, TITR 12150
        update open.or_order_Activity a
          set a.action_id = 4295271
        where a.package_id = reg.package_id
          and a.order_id = reg.order_id
          and a.task_type_id = 12150;
          
        -- Actualizamos Actividad en OR_ORDER_ITEMS, TITR 12150
        update open.or_order_items i
          set i.items_id = 4295271
        where i.order_id = reg.order_id 
          and reg.task_type_id = 12150;
        --
        --
        -- Actualizamos Actividad para el CP, TITR 12162
        update open.or_order_Activity a
          set a.action_id = 4294344
        where a.package_id = reg.package_id
          and a.order_id = reg.order_id
          and a.task_type_id = 12162;
        -- Actualizamos Actividad en OR_ORDER_ITEMS, TITR 12162
        update open.or_order_items i
          set i.items_id = 4294344
        where i.order_id = reg.order_id 
          and reg.task_type_id = 12162;
        --
        Commit; 
        --
        
      END LOOP;
      --
      DBMS_OUTPUT.PUT_LINE('Proceso termina Ok.');
      --
    Exception
      When others then
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Error solicitud : ' || vsbsolici || '  Producto : ' || vsbproduc ||'  Orden : ' || vsporden || ' TiTr ' || vsptipotr || '   ' || SQLERRM);

  End;
end;
/

select to_char(sysdate,'yyyy-mm-dd hh:mi:ss p.m.') fecha_fin from dual;
set serveroutput off
quit
/