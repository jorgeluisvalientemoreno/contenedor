CREATE OR REPLACE PACKAGE BODY GE_BONOTIFICATIONMAIL IS
   CNUERR_NULL_VALUE CONSTANT NUMBER( 3 ) := 471;
   CNUERR_NULL_HORT CONSTANT NUMBER( 4 ) := 1980;
   CNUERR_NUMB_PARA CONSTANT NUMBER( 3 ) := 472;
   CNUERR_ADDR_MAIL CONSTANT NUMBER( 3 ) := 475;
   CSBVERSION CONSTANT VARCHAR2( 20 ) := 'SAO151220';
   FUNCTION FSBVERSION
    RETURN VARCHAR2
    IS
    BEGIN
      RETURN CSBVERSION;
   END;
   PROCEDURE VALDATASENDMAIL( IOTYSELECT IN OUT NOCOPY GE_BOINSTANCE.TYTBINSTANCE, INUSTATEMENT IN GE_STATEMENT.STATEMENT_ID%TYPE, INUNOTIFICATION IN GE_NOTIFICATION.NOTIFICATION_ID%TYPE )
    IS
      NUINDICEREC PLS_INTEGER;
      CNUSEVEN CONSTANT NUMBER( 1 ) := 7;
      BLRETURN BOOLEAN;
      SBMAILERROR VARCHAR2( 1000 );
    BEGIN
      UT_TRACE.TRACE( 'GE_BONotificationMail.ValDataSendMail', 6 );
      NUINDICEREC := IOTYSELECT.FIRST;
      IF IOTYSELECT.COUNT != CNUSEVEN THEN
         ERRORS.SETERROR( CNUERR_NUMB_PARA, INUSTATEMENT || '|' || INUNOTIFICATION );
         RAISE EX.CONTROLLED_ERROR;
      END IF;
      FOR NUBIND IN 1..IOTYSELECT.COUNT
       LOOP
         IF IOTYSELECT( NUBIND ).VALUE_ IS NULL AND NUBIND != 3 THEN
            ERRORS.SETERROR( CNUERR_NULL_VALUE, IOTYSELECT( NUBIND ).NAME_ATTRIBUTE || '|' || INUSTATEMENT || '|' || INUNOTIFICATION );
            RAISE EX.CONTROLLED_ERROR;
         END IF;
      END LOOP;
      FOR NUBIND IN 1..2
       LOOP
         IF NOT UT_MAIL.FBLVALIDATEMAIL( IOTYSELECT( NUBIND ).VALUE_ ) THEN
            ERRORS.SETERROR( CNUERR_ADDR_MAIL, IOTYSELECT( NUBIND ).VALUE_ || '|' || IOTYSELECT( NUBIND ).NAME_ATTRIBUTE || '|' || INUSTATEMENT || '|' || INUNOTIFICATION );
            RAISE EX.CONTROLLED_ERROR;
         END IF;
      END LOOP;
      UT_MAIL.VALIDATEMAIL_CC( IOTYSELECT( 3 ).VALUE_, BLRETURN, SBMAILERROR );
      IF NOT BLRETURN THEN
         ERRORS.SETERROR( CNUERR_ADDR_MAIL, SBMAILERROR || '|' || IOTYSELECT( 3 ).NAME_ATTRIBUTE || '|' || INUSTATEMENT || '|' || INUNOTIFICATION );
         RAISE EX.CONTROLLED_ERROR;
      END IF;
      UT_TRACE.TRACE( 'GE_BONotificationMail.ValDataSendMail fin', 6 );
    EXCEPTION
      WHEN EX.CONTROLLED_ERROR THEN
         RAISE;
      WHEN OTHERS THEN
         ERRORS.SETERROR;
         RAISE EX.CONTROLLED_ERROR;
   END;
   PROCEDURE SENDMAIL( IRCNOTIFICATION_LOG IN DAGE_NOTIFICATION_LOG.STYGE_NOTIFICATION_LOG, IOTYSELECT IN OUT NOCOPY GE_BOINSTANCE.TYTBINSTANCE, INUSTATEMENT IN GE_STATEMENT.STATEMENT_ID%TYPE, INUNOTIFICATION IN GE_NOTIFICATION.NOTIFICATION_ID%TYPE )
    IS
      SBFILENAME VARCHAR2( 250 ) := 'NOTIFI_' || TO_CHAR( SYSDATE, 'DD_MM_YYYY_HH24_MI_SS' );
      TBCC UT_STRING.TYTB_STRING;
      TBBC UT_STRING.TYTB_STRING;
    BEGIN
      UT_TRACE.TRACE( 'GE_BONotificationMail.SendMail INICIO', 6 );
      VALDATASENDMAIL( IOTYSELECT, INUSTATEMENT, INUNOTIFICATION );
      IOTYSELECT( 3 ).VALUE_ := REPLACE( IOTYSELECT( 3 ).VALUE_, GE_BOCONSTANTS.CSBSEMICOLON, GE_BOCONSTANTS.CSBCOLON );
      UT_STRING.EXTSTRING( IOTYSELECT( 3 ).VALUE_, GE_BOCONSTANTS.CSBCOLON, TBCC );
      IF IRCNOTIFICATION_LOG.OUTPUT = GE_BONOTIFICATION.CSBTYPE_TEXT THEN
         UT_TRACE.TRACE( 'TYPE_TEXT', 7 );
         UT_MAILPOST.SENDMAILCLOBATTACHSMTP( ISBFROM=>IOTYSELECT( 1 ).VALUE_, ISBFROMDISPLAY=>IOTYSELECT( 1 ).VALUE_, ISBTO=>IOTYSELECT( 2 ).VALUE_, ISBTODISPLAY=>IOTYSELECT( 2 ).VALUE_, ITBCC=>TBCC, ITBCCDISPLAY=>TBCC, ITBBCC=>TBBC, ISBSUBJECT=>IOTYSELECT( 4 ).VALUE_, ISBMSG=>IOTYSELECT( 6 ).VALUE_, ISBCONTENTTYPE=>IOTYSELECT( 5 ).VALUE_, ISBFILENAME=>SBFILENAME, ISBFILEEXT=>IOTYSELECT( 7 ).VALUE_, ICLFILE=>IRCNOTIFICATION_LOG.OUTPUT_TEXT );
       ELSIF IRCNOTIFICATION_LOG.OUTPUT = GE_BONOTIFICATION.CSBTYPE_CLOB THEN
         UT_TRACE.TRACE( 'TYPE_CLOB', 7 );
         UT_MAILPOST.SENDMAILCLOBATTACHSMTP( ISBFROM=>IOTYSELECT( 1 ).VALUE_, ISBFROMDISPLAY=>IOTYSELECT( 1 ).VALUE_, ISBTO=>IOTYSELECT( 2 ).VALUE_, ISBTODISPLAY=>IOTYSELECT( 2 ).VALUE_, ITBCC=>TBCC, ITBCCDISPLAY=>TBCC, ITBBCC=>TBBC, ISBSUBJECT=>IOTYSELECT( 4 ).VALUE_, ISBMSG=>IOTYSELECT( 6 ).VALUE_, ISBCONTENTTYPE=>IOTYSELECT( 5 ).VALUE_, ISBFILENAME=>SBFILENAME, ISBFILEEXT=>IOTYSELECT( 7 ).VALUE_, ICLFILE=>IRCNOTIFICATION_LOG.OUTPUT_CLOB );
       ELSIF IRCNOTIFICATION_LOG.OUTPUT = GE_BONOTIFICATION.CSBTYPE_BLOB THEN
         UT_TRACE.TRACE( 'TYPE_BLOB', 7 );
         UT_MAILPOST.SENDMAILBLOBATTACHSMTP( ISBFROM=>IOTYSELECT( 1 ).VALUE_, ISBFROMDISPLAY=>IOTYSELECT( 1 ).VALUE_, ISBTO=>IOTYSELECT( 2 ).VALUE_, ISBTODISPLAY=>IOTYSELECT( 2 ).VALUE_, ITBCC=>TBCC, ITBCCDISPLAY=>TBCC, ITBBCC=>TBBC, ISBSUBJECT=>IOTYSELECT( 4 ).VALUE_, ISBMSG=>IOTYSELECT( 6 ).VALUE_, ISBCONTENTTYPE=>IOTYSELECT( 5 ).VALUE_, ISBFILENAME=>SBFILENAME, ISBFILEEXT=>IOTYSELECT( 7 ).VALUE_, IBLFILE=>IRCNOTIFICATION_LOG.OUTPUT_BLOB );
      END IF;
      UT_TRACE.TRACE( 'GE_BONotificationMail.SendMail fin', 6 );
    EXCEPTION
      WHEN EX.CONTROLLED_ERROR THEN
         RAISE EX.CONTROLLED_ERROR;
      WHEN OTHERS THEN
         ERRORS.SETERROR;
         RAISE EX.CONTROLLED_ERROR;
   END SENDMAIL;
   PROCEDURE SENDMAILADMNOTIF( ISBTOMAIL IN VARCHAR2, ISBCC_MAIL IN VARCHAR2, ISBSUBJECTMAIL IN VARCHAR2, ISBCONTENTTYPEMAIL IN VARCHAR2, ISBMESSAGEMAIL IN VARCHAR2, ISBFORMATFILEATTACH IN VARCHAR2 := NULL, ISBNAMEFILEATTACH IN VARCHAR2 := NULL, ISBDATAATTACHMENT IN VARCHAR2 := NULL )
    IS
      SBREMITENTE VARCHAR2( 2000 );
      TBCC UT_STRING.TYTB_STRING;
      TBBC UT_STRING.TYTB_STRING;
    BEGIN
      UT_TRACE.TRACE( 'GE_BONotificationMail.SendMailAdmNotif INICIO', 6 );
      SBREMITENTE := GE_BOPARAMETER.FSBGET( 'EMAIL_NOTIF_PROC_ADM' );
      UT_STRING.EXTSTRING( ISBCC_MAIL, GE_BOCONSTANTS.CSBSEMICOLON, TBCC );
      UT_MAILPOST.SENDMAILCLOBATTACHSMTP( ISBFROM=>SBREMITENTE, ISBFROMDISPLAY=>SBREMITENTE, ISBTO=>ISBTOMAIL, ISBTODISPLAY=>ISBTOMAIL, ITBCC=>TBCC, ITBCCDISPLAY=>TBCC, ITBBCC=>TBBC, ISBSUBJECT=>ISBSUBJECTMAIL, ISBMSG=>ISBMESSAGEMAIL, ISBCONTENTTYPE=>ISBCONTENTTYPEMAIL, ISBFILENAME=>ISBNAMEFILEATTACH, ISBFILEEXT=>ISBFORMATFILEATTACH, ICLFILE=>ISBDATAATTACHMENT );
      UT_TRACE.TRACE( 'GE_BONotificationMail.SendMailAdmNotif fin', 6 );
    EXCEPTION
      WHEN EX.CONTROLLED_ERROR THEN
         RAISE EX.CONTROLLED_ERROR;
      WHEN OTHERS THEN
         ERRORS.SETERROR;
         RAISE EX.CONTROLLED_ERROR;
   END SENDMAILADMNOTIF;
END GE_BONOTIFICATIONMAIL;
/


