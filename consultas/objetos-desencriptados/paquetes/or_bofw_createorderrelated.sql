PACKAGE BODY OR_BOFW_CREATEORDERRELATED
IS
















    
    
    
    
    CSBVERSION  CONSTANT VARCHAR2(20)  := 'SAO202132';
    
    CNUERR_CREATE_ORDER CONSTANT GE_ERROR_LOG.ERROR_LOG_ID%TYPE := 1964 ;
	
    
    

    
    
    
    FUNCTION FSBVERSION  RETURN VARCHAR2 IS
    BEGIN
        RETURN CSBVERSION;
    END;
    
    
    















    PROCEDURE CREATEORDERRELATE
    IS

        SBCOMMENT_          GE_BOINSTANCECONTROL.STYSBVALUE;    
        NUORDERACTIVITYID   OR_ORDER_ACTIVITY.ORDER_ACTIVITY_ID%TYPE;

        NUORDERID           OR_ORDER.ORDER_ID%TYPE;
        RCORDER             DAOR_ORDER.STYOR_ORDER;
        NUNEWORDERID        OR_ORDER.ORDER_ID%TYPE;
        NUITEMSID           OR_ORDER_ITEMS.ITEMS_ID%TYPE;
        NUOPERATINGUNIT     OR_OPERATING_UNIT.OPERATING_UNIT_ID%TYPE;
        NURELATEDTYPE       NUMBER;
        
        RCRELATEDORDER      DAOR_RELATED_ORDER.STYOR_RELATED_ORDER;

        TBACTIVITIES     OR_BCORDERACTIVITIES.TYTBORDERACTIVITIES;
        NUINDEXACT       NUMBER;
        RCITEM           DAGE_ITEMS.STYGE_ITEMS;

    BEGIN

        
        NURELATEDTYPE           := TO_NUMBER(GE_BOINSTANCECONTROL.FSBGETFIELDVALUE ('OR_ORDER_ACTIVITY', 'OPERATING_UNIT_ID'));

        NUORDERACTIVITYID       := TO_NUMBER(GE_BOINSTANCECONTROL.FSBGETFIELDVALUE ('OR_ORDER_ACTIVITY', 'ACTIVITY_ID'));
        NUOPERATINGUNIT         := TO_NUMBER(GE_BOINSTANCECONTROL.FSBGETFIELDVALUE ('OR_OPERATING_UNIT', 'NAME'));
        NUITEMSID               := TO_NUMBER(GE_BOINSTANCECONTROL.FSBGETFIELDVALUE ('GE_ITEMS', 'ITEMS_ID'));
        SBCOMMENT_              := GE_BOINSTANCECONTROL.FSBGETFIELDVALUE ('OR_ORDER_ACTIVITY', 'COMMENT_');

       
        GE_BOINSTANCECONTROL.GETATTRIBUTENEWVALUE(GE_BOINSTANCECONSTANTS.CSBWORK_INSTANCE,NULL,'OR_ORDER', 'ORDER_ID', NUORDERID);

        
        
        OR_BCORDERACTIVITIES.GETACTIVITIESBYORDER(NUORDERID,TBACTIVITIES);

        NUINDEXACT := TBACTIVITIES.FIRST;

        
        LOOP
            EXIT WHEN NUINDEXACT IS NULL;

            IF TBACTIVITIES(NUINDEXACT).NUPROCESSID = OR_BOCONSTANTS.CNUPROCESS_DAMAGES THEN
                
                RCITEM := DAGE_ITEMS.FRCGETRECORD(TBACTIVITIES(NUINDEXACT).NUACTIVITYID);

                IF RCITEM.USE_ IN (OR_BOCONSTANTS.CSBDIAGNOSTICUSE,OR_BOCONSTANTS.CSBCLIENT_MAINTENA_USE) THEN
                    GE_BOERRORS.SETERRORCODE(CNUERR_CREATE_ORDER);
                END IF;
            END IF;

            NUINDEXACT := TBACTIVITIES.NEXT(NUINDEXACT);

        END LOOP;


        
        RCORDER := DAOR_ORDER.FRCGETRECORD(NUORDERID);
        IF NOT OR_BOPROCESSORDER.FBLISORDERALTERABLEBYRELATED(RCORDER) THEN
            GE_BOERRORS.SETERRORCODE(OR_BOCONSTANTS.CNUERR_122462);
        END IF;

        
        OR_BCORDERPROCESS.LOCKORDER(NUORDERID);
        
        
        OR_BOCREATEACTSUPPORT.CREATEACTIVITY
        (
            NUORDERACTIVITYID,
            NUITEMSID,
            NUOPERATINGUNIT,
            SBCOMMENT_,
            NUNEWORDERID
        );

        
        RCRELATEDORDER.ORDER_ID := NUORDERID;
        RCRELATEDORDER.RELATED_ORDER_ID := NUNEWORDERID;
        
        
        IF (NURELATEDTYPE = 1 ) THEN
            
            RCRELATEDORDER.RELA_ORDER_TYPE_ID := OR_BOSUPPORTORDER.FNUGETSUPPORTORDERTYPE;
        ELSE
            
            RCRELATEDORDER.RELA_ORDER_TYPE_ID := OR_BOFWORDERRELATED.FNUGETRELATEDORDERTYPE;
        END IF;

        DAOR_RELATED_ORDER.INSRECORD(RCRELATEDORDER);
        COMMIT;

    EXCEPTION
        WHEN EX.CONTROLLED_ERROR THEN
            ROLLBACK;
            RAISE;

        WHEN OTHERS THEN
            ROLLBACK;
            ERRORS.SETERROR;
            RAISE EX.CONTROLLED_ERROR;
            
    END CREATEORDERRELATE;

END OR_BOFW_CREATEORDERRELATED;