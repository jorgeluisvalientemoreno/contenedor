WITH BASE AS(SELECT DISTINCT  O.ORDER_ID, 
       O.TASK_TYPE_ID, 
       O.EXECUTION_FINAL_DATE,
       O.LEGALIZATION_dATE,
       A.PRODUCT_ID,
       g.cod_group_warranty_id GRUPO,
       A.PACKAGE_ID,
       (SELECT SUM(OI.VALUE) FROM OPEN.OR_ORDER_ITEMS OI WHERE OI.ORDER_ID=O.ORDER_ID) VALORORDENGARANTIA
FROM OPEN.OR_ORDER O,
     OPEN.OR_ORDER_aCTIVITY A,
     OPEN.GE_CAUSAL C,
     OPEN.LDC_GRUPTITRGARA G
     
WHERE A.ORDER_ID=O.ORDER_ID
	 AND O.TASK_TYPE_ID IN (10088,10613,10622,10077,10624,11093,11032,11031,10954,11026,10953,10916,10610,10093,11028,10951,10933,10625,10623,10606,10094,11094,10954,10924,10612,10925,11034,10614,10952,10608,10926,10894,10607,10955,10895,10534,10609,10611,11045,12474)
   AND O.CAUSAL_ID=C.CAUSAL_ID
   AND C.CLASS_CAUSAL_ID=1
   AND A.PRODUCT_ID=51790267
   AND O.LEGALIZATION_dATE>='01/01/2020'
   AND O.LEGALIZATION_dATE<'01/01/2021'
   AND G.TASK_TYPE_ID=o.task_type_id)
   
 SELECT DISTINCT B.*,
        OT.ORDER_ID,
        OT.TASK_TYPE_ID,
        OPEN.DAOR_TASK_TYPE.FSBGETDESCRIPTION(OT.TASK_TYPE_ID, NULL),
        OT.LEGALIZATION_DATE,
        W.FINAL_WARRANTY_DATE,
        (SELECT SUM(OI.VALUE) FROM OPEN.OR_ORDER_ITEMS OI WHERE OI.ORDER_ID=OT.ORDER_ID) VALORORDEN_ORIGEN
 FROM BASE B,
 OPEN.GE_ITEM_WARRANTY W,
 OPEN.OR_ORDER OT,
 OPEN.OR_ORDER_aCTIVITY OAT,
 OPEN.LDC_GRUPTITRGARA G
 WHERE B.PRODUCT_ID=W.PRODUCT_ID
 AND B.EXECUTION_FINAL_DATE<=W.FINAL_WARRANTY_DATE
 AND G.TASK_TYPE_ID=OT.TASK_TYPE_ID
 AND OT.ORDER_ID=W.ORDER_ID
 AND OAT.ORDER_ID=OT.ORDER_ID
 AND G.COD_GROUP_WARRANTY_ID=B.GRUPO
 AND B.PACKAGE_ID!=OAT.PACKAGE_ID
