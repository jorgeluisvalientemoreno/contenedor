WITH  PERIODO AS  ( SELECT C.PEFACODI PERIFACT, C.PEFACICL CICLO1
                  FROM PROCEJEC P , PERIFACT C
                  WHERE P.PREJCOPE= C.PEFACODI
                  AND C.PEFAANO= 2023
                  AND C.PEFAMES IN (2)
                  AND P.PREJPROG = 'FGCC'
                  AND P.PREJESPR = 'T'),
CONTRATOS AS (SELECT  S.SESUSUSC CONTRATO ,S.SESUNUSE PRODUCTO, S.SESUSERV ||' -' || INITCAP (SE.SERVDESC) TIPO_SERV, S.SESUESCO  ||' -'|| INITCAP (substrc(E.ESCODESC,1,31)) ESTADO_CORT, S.SESUESFN ESTADO_FIN, S.SESUCICL CICLO
             FROM SERVSUSC S , ESTACORT E , SERVICIO SE
             WHERE SE.SERVCODI = S.SESUSERV
             AND E.ESCOCODI= SESUESCO
             AND (SELECT COUNT (DISTINCT(S1.SESUSERV ))
                    FROM SERVSUSC S1
                    WHERE S.SESUSUSC  = S1.SESUSUSC
                    AND S1.SESUSERV  <> 3
                    AND S1.SESUESCO = ( SELECT F.COECCODI
                                       FROM CONFESCO F
                                       WHERE F.COECCODI =  S1.SESUESCO
                                       AND  F.COECSERV = S1.SESUSERV AND F.COECFACT= 'S' ))>= 3
             AND S.SESUESFN <>'C'
             AND S.SESUESCO NOT IN (92,94)
             AND SESUCICL NOT IN (2401,2402)),
INFOFINAL AS ( SELECT  CONTRATO "Contrato" , PRODUCTO "Producto",  TIPO_SERV "Tipo producto", ESTADO_CORT "Estado corte", ESTADO_FIN "Estado financiero",  CICLO "Ciclo" ,(SELECT PERIFACT FROM PERIODO WHERE CICLO1=CICLO)"Periodo_fact"  FROM CONTRATOS WHERE (SELECT PERIFACT FROM PERIODO WHERE CICLO1=CICLO) IS NOT NULL )
SELECT * FROM INFOFINAL
ORDER BY  "Contrato"