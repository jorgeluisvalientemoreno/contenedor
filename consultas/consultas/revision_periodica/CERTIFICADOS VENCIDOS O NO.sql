WITH TABLA AS(
SELECT C.ROWID
FROM OPEN.PR_CERTIFICATE C
WHERE C.REVIEW_DATE>='01/09/2018'),
TABLA2 AS
(SELECT C.PRODUCT_ID, C.CERTIFICATE_ID CERT_ACTU, C.REVIEW_DATE, C.ORDER_ACT_CERTIF_ID ACT_CERT_ACTU, (SELECT MAX(C2.CERTIFICATE_ID) FROM OPEN.PR_CERTIFICATE C2 WHERE C2.PRODUCT_ID=C.PRODUCT_ID AND C2.CERTIFICATE_ID<C.CERTIFICATE_ID) CERT_ANT
FROM TABLA 
INNER JOIN OPEN.PR_CERTIFICATE C ON C.ROWID=TABLA.ROWID
WHERE C.CERTIFICATE_ID=(SELECT MAX(C2.CERTIFICATE_ID) FROM OPEN.PR_CERTIFICATE C2 WHERE C2.PRODUCT_ID=C.PRODUCT_ID))
SELECT LO.GEOGRAP_LOCATION_ID,
       LO.DESCRIPTION,
       SESUSUSC,
       TABLA2.PRODUCT_ID, 
       SESUFEIN,
       TABLA2.CERT_ACTU, TABLA2.REVIEW_DATE,
       TABLA2.CERT_ANT, 
       TABLA2.ACT_CERT_ACTU,
       (SELECT T.ITEMS_ID||'-'||T.DESCRIPTION FROM OPEN.OR_ORDER_ACTIVITY A, OPEN.GE_ITEMS T WHERE A.ORDER_ACTIVITY_ID=TABLA2.ACT_CERT_ACTU AND A.ACTIVITY_ID=T.ITEMS_ID) TITR_CERT_ACTU,
       C.REVIEW_DATE, 
       fdtFechaMaxRevi(C.REVIEW_DATE),
       C.ORDER_ACT_CERTIF_ID ACT_CERT_ANTE,
       (SELECT T.ITEMS_ID||'-'||T.DESCRIPTION FROM OPEN.OR_ORDER_ACTIVITY A, OPEN.GE_ITEMS T WHERE A.ORDER_ACTIVITY_ID=C.ORDER_ACT_CERTIF_ID AND A.ACTIVITY_ID=T.ITEMS_ID) TITR_CERT_ANTE       
FROM TABLA2
LEFT JOIN OPEN.PR_CERTIFICATE C ON C.CERTIFICATE_ID=TABLA2.CERT_ANT
INNER JOIN OPEN.PR_PRODUCT P ON P.PRODUCT_ID=TABLA2.PRODUCT_ID
INNER JOIN OPEN.SERVSUSC S ON S.SESUNUSE=P.PRODUCT_ID
INNER JOIN OPEN.AB_ADDRESS DI ON DI.ADDRESS_ID=P.ADDRESS_ID
INNER JOIN OPEN.GE_GEOGRA_LOCATION LO ON LO.GEOGRAP_LOCATION_ID=DI.GEOGRAP_LOCATION_ID
WHERE (SELECT A.ACTIVITY_ID OPEN.OR_ORDER_ACTIVITY A WHERE A.ORDER_ACTIVITY_ID=TABLA2.ACT_CERT_ACTU ) NOT IN (100006318,4000063, 4000064, 4294537, 4294588, 4295271)



