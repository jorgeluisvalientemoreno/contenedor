WITH GRUPOS AS (
SELECT 'SERVICIOS VARIOS' GRUPO, TASK_TYPE_ID, DESCRIPTION, CONCEPT
FROM OPEN.OR_TASK_TYPE 
WHERE TASK_TYPE_ID IN (10951,10954,10953,10952,10955,12138,12143,12148,12147,12135)
UNION
SELECT 'REVISION PERIODICA' GRUPO, TASK_TYPE_ID, DESCRIPTION, CONCEPT
FROM OPEN.OR_TASK_TYPE 
WHERE TASK_TYPE_ID IN (10933,10925,10926,10916,10924,10716,10720,10722,10721,10714)
UNION
SELECT 'MANTENIMIENTO' GRUPO, TASK_TYPE_ID, DESCRIPTION, CONCEPT
FROM OPEN.OR_TASK_TYPE 
WHERE TASK_TYPE_ID IN (10074,10094,10088,10093,10077,12190,10075,12189,12188,12187)),
TIPOS AS(
SELECT 'CXC' TIPO, TASK_TYPE_ID
FROM OPEN.OR_TASK_TYPE
WHERE TASK_TYPE_ID IN (10951,10954,10953,12138,12143,12148,10933,10925,10926,10716,10720,10722,10074,10094,10088,12190,10075,12189)
UNION
SELECT 'INTERNA' TIPO, TASK_TYPE_ID
FROM OPEN.OR_TASK_TYPE
WHERE TASK_TYPE_ID IN (10952,10955,12147,12135,10916,10924,10721,10714,10093,10077,12188,12187)
),
BASE AS(
SELECT O.ORDER_ID, O.LEGALIZATION_DATE, O.TASK_TYPE_ID, CONCEPT, G.GRUPO, G.DESCRIPTION,
       T.TIPO, CHARGE_STATUS,O.OPERATING_UNIT_ID
FROM OPEN.OR_ORDER O
INNER JOIN OPEN.GRUPOS G ON G.TASK_TYPE_ID=O.TASK_TYPE_ID
INNER JOIN OPEN.TIPOS T ON T.TASK_TYPE_ID=O.TASK_TYPE_ID
INNER JOIN OPEN.GE_CAUSAL C ON C.CAUSAL_ID=O.CAUSAL_ID AND C.CLASS_CAUSAL_ID=1
WHERE O.ORDER_STATUS_ID=8
  AND O.LEGALIZATION_dATE>='01/01/2018'
  AND O.LEGALIZATION_DATE<'01/11/2018')
SELECT LO.GEO_LOCA_FATHER_ID DEPA,
       (SELECT DE.DESCRIPTION FROM OPEN.GE_GEOGRA_LOCATION DE WHERE DE.GEOGRAP_LOCATION_ID=LO.GEO_LOCA_FATHER_ID) DESC_DEPA,
       TO_CHAR(LEGALIZATION_DATE,'MM/YYYY') MES_LEGALZIACION,
       A.PRODUCT_ID,
       A.PACKAGE_ID,
       BASE.ORDER_ID,
       GRUPO,
       TIPO,
       CONCEPT,
       CHARGE_STATUS,
       U.OPERATING_UNIT_ID,
       U.NAME,
       COUNT(DISTINCT BASE.ORDER_ID)
FROM BASE
INNER JOIN OPEN.OR_ORDER_ACTIVITY A ON A.ORDER_ID=BASE.ORDER_ID
INNER JOIN OPEN.AB_ADDRESS DI ON A.ADDRESS_ID=DI.ADDRESS_ID
INNER JOIN OPEN.GE_GEOGRA_LOCATION LO ON LO.GEOGRAP_LOCATION_ID=DI.GEOGRAP_LOCATION_ID
INNER JOIN OPEN.OR_OPERATING_UNIT U ON U.OPERATING_UNIT_ID=BASE.OPERATING_UNIT_ID
GROUP BY LO.GEO_LOCA_FATHER_ID,
       TO_CHAR(LEGALIZATION_DATE,'MM/YYYY'),
       A.PRODUCT_ID,
      A.PACKAGE_ID,
       GRUPO,
       TIPO,
       CONCEPT,
       CHARGE_STATUS,
       U.OPERATING_UNIT_ID,
       U.NAME,
       BASE.ORDER_ID
