-- Detalle ventas BRILLA
SELECT DISTINCT 
       (SELECT S.SERVCODI||' - '||S.SERVDESC FROM OPEN.SERVICIO S WHERE S.SERVCODI = M.PRODUCT_TYPE_ID) COD_FNB,
       D.GEOGRAP_LOCATION_ID ID_DPTO,
       D.DESCRIPTION DEPARTAMENTO,
       L.GEOGRAP_LOCATION_ID ID_LOCA,
       L.DESCRIPTION LOCALIDAD,
       B.NEIGHBORTHOOD_ID ID_BARRIO,
       CASE WHEN B.NEIGHBORTHOOD_ID IS NULL THEN '-' ELSE open.Dage_geogra_location.Fsbgetdescription(B.NEIGHBORTHOOD_ID) END BARRIO,
/*       SR.SUSCCICL CICLO,
       NVL((SELECT K.SUCADESC FROM OPEN.PR_PRODUCT PRO, OPEN.SUBCATEG K 
                              WHERE PRO.PRODUCT_ID = M.PRODUCT_ID 
                              AND K.SUCACATE = PRO.CATEGORY_ID 
                              AND K.SUCACODI = PRO.SUBCATEGORY_ID),
           (SELECT DISTINCT K.SUCADESC FROM OPEN.SERVSUSC VR, OPEN.SUBCATEG K
                                       WHERE VR.SESUSUSC = SR.SUSCCODI
                                       AND VR.SESUCATE = K.SUCACATE
                                       AND VR.SESUSUCA = K.SUCACODI
                                       AND K.SUCACATE = 1
                                       AND VR.SESUSERV = 7014)) ESTRATO,*/
       NVL(V.DIGITAL_PROM_NOTE_CONS, V.MANUAL_PROM_NOTE_CONS) COD_ATENCION,
       P.PACKAGE_ID N_SOLICITUD, 
       P.PACKAGE_TYPE_ID TIPO_S,
       T.DESCRIPTION TPO_SOLIC,
       P.MOTIVE_STATUS_ID||' - '||E.DESCRIPTION ESTADO_SOLICITUD,
       P.RECEPTION_TYPE_ID COD_CANAL,
       R.DESCRIPTION CANAL,
       P.SALE_CHANNEL_ID SUC_CANAL,
       C.NAME_ SUCURSAL_VENTA,
       G.SUBSCRIBER_ID SUSCRIPTOR,
       G.SUBSCRIBER_NAME||' '||G.SUBS_LAST_NAME NOMBRE_SUSC, 
       B.ADDRESS_PARSED DIRECCION,
       G.IDENT_TYPE_ID||' - '||TI.DESCRIPTION TPO_DOC_ID,
       G.IDENTIFICATION IDENTIFICACION,
       (SELECT FD.DEBTORNAME||' '||FD.LAST_NAME FROM OPEN.LD_PROMISSORY FD WHERE FD.PACKAGE_ID = P.PACKAGE_ID AND FD.PROMISSORY_TYPE = 'D') DEUDOR,
       (SELECT TFD.IDENT_TYPE_ID||' - '||TFD.DESCRIPTION FROM OPEN.LD_PROMISSORY FD, 
                                                              OPEN.GE_IDENTIFICA_TYPE TFD 
                                                         WHERE FD.PACKAGE_ID = P.PACKAGE_ID 
                                                         AND FD.PROMISSORY_TYPE = 'D'
                                                         AND TFD.IDENT_TYPE_ID = FD.IDENT_TYPE_ID) TPO_DOC_DEUDOR,
       (SELECT FD.IDENTIFICATION FROM OPEN.LD_PROMISSORY FD WHERE FD.PACKAGE_ID = P.PACKAGE_ID AND FD.PROMISSORY_TYPE = 'D') IDENT_DEUDOR,
       (SELECT FD.DEBTORNAME||' '||FD.LAST_NAME FROM OPEN.LD_PROMISSORY FD WHERE FD.PACKAGE_ID = P.PACKAGE_ID AND FD.PROMISSORY_TYPE = 'C') CODEUDOR,
       (SELECT TFD.IDENT_TYPE_ID||' - '||TFD.DESCRIPTION FROM OPEN.LD_PROMISSORY FD, 
                                                              OPEN.GE_IDENTIFICA_TYPE TFD 
                                                         WHERE FD.PACKAGE_ID = P.PACKAGE_ID 
                                                         AND FD.PROMISSORY_TYPE = 'C'
                                                         AND TFD.IDENT_TYPE_ID = FD.IDENT_TYPE_ID) TPO_DOC_CODEUDOR,
       (SELECT FD.IDENTIFICATION FROM OPEN.LD_PROMISSORY FD WHERE FD.PACKAGE_ID = P.PACKAGE_ID AND FD.PROMISSORY_TYPE = 'C') IDENT_CODEUDOR,
       (SELECT FD.EMAIL FROM OPEN.LD_PROMISSORY FD WHERE FD.PACKAGE_ID = P.PACKAGE_ID AND FD.PROMISSORY_TYPE = 'D') EMAIL_DEUDOR,
       (SELECT FD.PROPERTYPHONE_ID FROM OPEN.LD_PROMISSORY FD WHERE FD.PACKAGE_ID = P.PACKAGE_ID AND FD.PROMISSORY_TYPE = 'D') TEL_DEUDOR,
       P.REQUEST_DATE FECHA_REG,
       V.SALE_DATE FECHA_REAL,
       O.LEGALIZATION_DATE FECHA_ENTREGA,
       DF.CREDIT_FEES CUOTAS,
       (SELECT O.TASK_TYPE_ID||' - '||TT.DESCRIPTION FROM OPEN.OR_TASK_TYPE TT WHERE TT.TASK_TYPE_ID = O.TASK_TYPE_ID) TIPO_TRAB,
       DF.ARTICLE_ID ITEM,
       I.DESCRIPTION  DESC_ITEM,
       (SELECT FM.SUBLINE_ID||' - '||FM.DESCRIPTION FROM OPEN.LD_SUBLINE FM WHERE FM.SUBLINE_ID = I.SUBLINE_ID) FAMILIA, --SUBLINEA
       (SELECT LI.LINE_ID||' - '||LI.DESCRIPTION FROM OPEN.LD_SUBLINE FM, OPEN.LD_LINE LI 
                                                 WHERE FM.SUBLINE_ID = I.SUBLINE_ID
                                                 AND LI.LINE_ID = FM.LINE_ID) LINEA,
       (SELECT CP.CONCCODI||' - '||CP.CONCDESC FROM OPEN.CONCEPTO CP WHERE CP.CONCCODI = I.CONCEPT_ID) CONCEPTO,
       O.ORDER_ID ORDEN_TRAB,
       (SELECT ET.ORDER_STATUS_ID||' - '||ET.DESCRIPTION FROM OPEN.OR_ORDER_STATUS ET WHERE ET.ORDER_STATUS_ID = O.ORDER_STATUS_ID) ESTADO_OT,
       TO_NUMBER(TO_CHAR(O.LEGALIZATION_DATE,'MM')) MES,
       DF.SUPPLIER_ID COD_PROVEEDOR,
       (SELECT CTT.NOMBRE_CONTRATISTA FROM OPEN.GE_CONTRATISTA CTT WHERE CTT.ID_CONTRATISTA = DF.SUPPLIER_ID) NOMBRE_PROVEEDOR,
       U.OPERATING_UNIT_ID SUC_CONTRATISTA_PROV,
       U.NAME SUCURSAL_CONTRATISTA_PROV ,
       P.SUBSCRIPTION_PEND_ID CONTRATO,
       (SELECT (SELECT DA3.ID_ACTA FROM OPEN.GE_DETALLE_ACTA DA3 WHERE DA3.ID_ORDEN = O3.ORDER_ID AND ROWNUM = 1) 
                           FROM OPEN.OR_ORDER_ACTIVITY OA3, OPEN.OR_ORDER O3
                           WHERE OA3.PACKAGE_ID = P.PACKAGE_ID
                           AND O3.ORDER_ID = OA3.ORDER_ID
                           AND O3.TASK_TYPE_ID = 10144
                           AND OA3.TASK_TYPE_ID = 10144
                           AND ROWNUM = 1)ACTA_PAGO_PROV,
       (SELECT (SELECT DA4.ID_ACTA FROM OPEN.GE_DETALLE_ACTA DA4 WHERE DA4.ID_ORDEN = O4.ORDER_ID AND ROWNUM = 1) 
                           FROM OPEN.OR_ORDER_ACTIVITY OA4, OPEN.OR_ORDER O4
                           WHERE OA4.PACKAGE_ID = P.PACKAGE_ID
                           AND O4.ORDER_ID = OA4.ORDER_ID
                           AND O4.TASK_TYPE_ID = 10137
                           AND OA4.TASK_TYPE_ID = 10137
                           AND ROWNUM = 1) ACTA_COBRO_PROV,
       (NVL(DF.VALUE,0) * NVL(DF.AMOUNT,0)) VALOR_SIN_IVA,
       (NVL(DF.VALUE,0) * NVL(DF.AMOUNT,0)) + NVL(DF.IVA,0) VALOR_VENTA,
       O.LEGALIZATION_DATE FECHA_LEG,
       V.PAYMENT CUOTA_INICIAL,
       DECODE(V.PAYMENT,0,NULL,TRUNC((SELECT MIN(O1.CREATED_DATE) FROM OPEN.OR_ORDER_ACTIVITY OA1, OPEN.OR_ORDER O1 
                                    WHERE OA1.PACKAGE_ID = P.PACKAGE_ID AND OA1.ACTIVITY_ID = 4000822
                                    AND O1.ORDER_ID = OA1.ORDER_ID AND O1.TASK_TYPE_ID = 12590)) - TRUNC(P.REQUEST_DATE) + 1) DIAS_APLIC_PGO,                    
       CTV.ID_CONTRATISTA COD_CONTRATISTA_VEND,
       CTV.NOMBRE_CONTRATISTA NOMBRE_CONTRATISTA_VEND,
       UV.OPERATING_UNIT_ID SUC_CONTRATISTA_VEND,
       UV.NAME SUCURSAL_CONTRATISTA_VEND,
       P.PERSON_ID ID_ASESOR_VTA,
       (SELECT GP.NAME_ FROM OPEN.GE_PERSON GP WHERE GP.PERSON_ID = P.PERSON_ID) NOM_ASESOR_VTA,
       (SELECT (SELECT DA2.ID_ACTA FROM OPEN.GE_DETALLE_ACTA DA2 WHERE DA2.ID_ORDEN = O2.ORDER_ID AND ROWNUM = 1) 
                           FROM OPEN.OR_ORDER_ACTIVITY OA2, OPEN.OR_ORDER O2
                           WHERE OA2.PACKAGE_ID = P.PACKAGE_ID
                           AND O2.ORDER_ID = OA2.ORDER_ID
                           AND O2.TASK_TYPE_ID = 10136
                           AND OA2.TASK_TYPE_ID = 10136
                           AND ROWNUM = 1) ACTA_PAGO_CONTRATISTA_VEND,
       (SELECT CS1.CAUSAL_ID||' - '||CS1.DESCRIPTION FROM OPEN.GE_CAUSAL CS1 WHERE CS1.CAUSAL_ID = O.CAUSAL_ID AND CS1.CAUSAL_TYPE_ID = 7) CAUSA_NO_ENTREGA,
       (SELECT DISTINCT CA6.CAUSAL_ID||' - '||CA6.DESCRIPTION
        FROM OPEN.MO_PACKAGES_ASSO SA6, 
             OPEN.MO_PACKAGES SS6, 
             OPEN.PS_PACKAGE_TYPE PT6, 
             OPEN.LD_RETURN_ITEM RI6, 
             OPEN.LD_RETURN_ITEM_DETAIL RD6,
             OPEN.OR_ORDER_ACTIVITY OA6, 
             OPEN.OR_ORDER O6, 
             OPEN.GE_CAUSAL CA6
        WHERE SA6.PACKAGE_ID_ASSO = P.PACKAGE_ID
        AND SS6.PACKAGE_ID = SA6.PACKAGE_ID
        AND SS6.PACKAGE_TYPE_ID = 100244
        AND PT6.PACKAGE_TYPE_ID = SS6.PACKAGE_TYPE_ID
        AND RI6.PACKAGE_ID = SS6.PACKAGE_ID
        AND RD6.RETURN_ITEM_ID = RI6.RETURN_ITEM_ID
        AND RD6.ARTICLE_ID = DF.ARTICLE_ID
        AND OA6.PACKAGE_ID = SS6.PACKAGE_ID
        AND O6.ORDER_ID = OA6.ORDER_ID
        AND CA6.CAUSAL_ID = O6.CAUSAL_ID
        AND SS6.REQUEST_DATE = (SELECT MAX(SS7.REQUEST_DATE) FROM OPEN.MO_PACKAGES SS7, 
                                                                  OPEN.MO_PACKAGES_ASSO SA7 
                                                             WHERE SS7.PACKAGE_ID = SA7.PACKAGE_ID
                                                             AND SA7.PACKAGE_ID_ASSO = SA6.PACKAGE_ID_ASSO) 
        AND ROWNUM = 1) CAUSA_ANULACION,
       DECODE(DF.STATE,'EP',DECODE(O.TASK_TYPE_ID,10143,'REGISTRADO',DECODE(O.ORDER_STATUS_ID,5,'EN_PROCESO_A/D','ENTREGADO')),'RE',DECODE(O.ORDER_STATUS_ID,8,DECODE(O.TASK_TYPE_ID,10143,'REGISTRADO','ENTREGADO'),'REGISTRADO'),'AN','ANULADO','PA','APROBACION') ESTADO_ENTREGA,
       (SELECT OD.ORDER_ID FROM OPEN.OR_ORDER_ACTIVITY OAD, OPEN.OR_ORDER OD 
                           WHERE OAD.PACKAGE_ID = P.PACKAGE_ID
                           AND OAD.ORDER_ID = OD.ORDER_ID
                           AND OD.TASK_TYPE_ID = 10130) OT_DOCUMENTACION,
       (SELECT ETD.ORDER_STATUS_ID||' - '||ETD.DESCRIPTION FROM OPEN.OR_ORDER_ACTIVITY OAD1, OPEN.OR_ORDER OD1, OPEN.OR_ORDER_STATUS ETD
                                                           WHERE OAD1.PACKAGE_ID = P.PACKAGE_ID
                                                           AND OAD1.ORDER_ID = OD1.ORDER_ID
                                                           AND OD1.TASK_TYPE_ID = 10130
                                                           AND ETD.ORDER_STATUS_ID = OD1.ORDER_STATUS_ID) ESTADO_OT_DOC,
       (SELECT DISTINCT SS.PACKAGE_TYPE_ID||' - '||PT.DESCRIPTION
        FROM OPEN.MO_PACKAGES_ASSO SA, OPEN.MO_PACKAGES SS, OPEN.PS_PACKAGE_TYPE PT, OPEN.LD_RETURN_ITEM RI, OPEN.LD_RETURN_ITEM_DETAIL RD
        WHERE SA.PACKAGE_ID_ASSO = P.PACKAGE_ID
        AND SS.PACKAGE_ID = SA.PACKAGE_ID
        AND SS.PACKAGE_TYPE_ID IN (100243,100244)
        AND PT.PACKAGE_TYPE_ID = SS.PACKAGE_TYPE_ID
        AND RI.PACKAGE_ID = SS.PACKAGE_ID
        AND RD.RETURN_ITEM_ID = RI.RETURN_ITEM_ID
        AND RD.ARTICLE_ID = DF.ARTICLE_ID
        AND SS.REQUEST_DATE = (SELECT MAX(SSB.REQUEST_DATE) FROM OPEN.MO_PACKAGES SSB,
                                                                 OPEN.MO_PACKAGES_ASSO SAB
                                                           WHERE SAB.PACKAGE_ID_ASSO = SA.PACKAGE_ID_ASSO
                                                             AND SSB.PACKAGE_ID = SAB.PACKAGE_ID)) INDICADOR_ANUL_DEVOL,
       (SELECT M.BRAND_ID||' - '||M.DESCRIPTION FROM OPEN.LD_BRAND M WHERE M.BRAND_ID = I.BRAND_ID) MARCA,
       NVL((SELECT C.CATECODI||' - '||C.CATEDESC FROM OPEN.PR_PRODUCT PRO, OPEN.CATEGORI C 
                                                 WHERE PRO.PRODUCT_ID = M.PRODUCT_ID 
                                                 AND C.CATECODI = PRO.CATEGORY_ID),
           (SELECT C.CATECODI||' - '||C.CATEDESC FROM OPEN.SERVSUSC VR, OPEN.CATEGORI C
                                                 WHERE VR.SESUSUSC = SR.SUSCCODI
                                                 AND VR.SESUCATE = C.CATECODI
                                                 AND ROWNUM = 1)) CATEGORIA,
       NVL(V.TRASFER_QUOTA,'N') FLAG_TC,
       (SELECT MAX(MDF.ITEM_WORK_ORDER_ID) FROM OPEN.OR_ORDER_ACTIVITY MOA, OPEN.OR_ORDER MO, OPEN.LD_ITEM_WORK_ORDER MDF 
                                           WHERE MOA.PACKAGE_ID = P.PACKAGE_ID AND MOA.ACTIVITY_ID = OA.ACTIVITY_ID
                                           AND MO.ORDER_ID = MOA.ORDER_ID AND MO.TASK_TYPE_ID = O.TASK_TYPE_ID
                                           AND MDF.ORDER_ACTIVITY_ID = MOA.ORDER_ACTIVITY_ID) MAX_ITEM,
       V.VALUE_TOTAL,
       NVL(M.PRODUCT_ID,(SELECT PSS.SESUNUSE FROM OPEN.SERVSUSC PSS 
                                             WHERE PSS.SESUSUSC = SR.SUSCCODI 
                                             AND PSS.SESUSERV = 7055
                                             AND ROWNUM = 1)) COD_PRODUCTO,
       (SELECT ODF.LEGALIZATION_DATE FROM OPEN.OR_ORDER_ACTIVITY OADF, OPEN.OR_ORDER ODF 
                                     WHERE OADF.PACKAGE_ID = P.PACKAGE_ID
                                     AND OADF.ORDER_ID = ODF.ORDER_ID
                                     AND ODF.TASK_TYPE_ID = 10130) FECHA_DOCUMEN,
       DF.ITEM_WORK_ORDER_ID
FROM OPEN.MO_PACKAGES P LEFT JOIN OPEN.OR_ORDER_ACTIVITY OA ON OA.PACKAGE_ID = P.PACKAGE_ID AND OA.ACTIVITY_ID IN (4000822,4294427)
                        LEFT JOIN OPEN.OR_ORDER O ON O.ORDER_ID = OA.ORDER_ID AND O.TASK_TYPE_ID IN (12590,10143)
                        LEFT JOIN OPEN.SUSCRIPC SR ON SR.SUSCCODI = P.SUBSCRIPTION_PEND_ID
                        LEFT JOIN OPEN.OR_OPERATING_UNIT U ON U.OPERATING_UNIT_ID = O.OPERATING_UNIT_ID
                        LEFT JOIN OPEN.GE_CONTRATISTA CT ON CT.ID_CONTRATISTA = U.CONTRACTOR_ID
                        LEFT JOIN OPEN.OR_OPERATING_UNIT UV ON UV.OPERATING_UNIT_ID = P.POS_OPER_UNIT_ID
                        LEFT JOIN OPEN.GE_CONTRATISTA CTV ON CTV.ID_CONTRATISTA = UV.CONTRACTOR_ID
                        LEFT JOIN OPEN.LD_ITEM_WORK_ORDER DF ON DF.ORDER_ACTIVITY_ID = OA.ORDER_ACTIVITY_ID
                        LEFT JOIN OPEN.LD_ARTICLE I ON I.ARTICLE_ID = DF.ARTICLE_ID,
     OPEN.LD_NON_BA_FI_REQU V, 
     OPEN.MO_MOTIVE M,
     OPEN.AB_ADDRESS B,
     OPEN.GE_GEOGRA_LOCATION L,
     OPEN.GE_GEOGRA_LOCATION D,
     OPEN.GE_SUBSCRIBER G,
     OPEN.PS_PACKAGE_TYPE T,
     OPEN.PS_MOTIVE_STATUS E,
     OPEN.GE_RECEPTION_TYPE R,
     OPEN.GE_ORGANIZAT_AREA C,
     OPEN.GE_IDENTIFICA_TYPE TI
WHERE V.NON_BA_FI_REQU_ID = P.PACKAGE_ID
AND M.PACKAGE_ID = P.PACKAGE_ID
AND B.ADDRESS_ID = P.ADDRESS_ID
AND L.GEOGRAP_LOCATION_ID = B.GEOGRAP_LOCATION_ID
AND D.GEOGRAP_LOCATION_ID = L.GEO_LOCA_FATHER_ID
AND G.SUBSCRIBER_ID = P.SUBSCRIBER_ID
AND T.PACKAGE_TYPE_ID = P.PACKAGE_TYPE_ID
AND E.MOTIVE_STATUS_ID = P.MOTIVE_STATUS_ID
AND R.RECEPTION_TYPE_ID = P.RECEPTION_TYPE_ID
AND C.ORGANIZAT_AREA_ID = P.SALE_CHANNEL_ID
AND TI.IDENT_TYPE_ID = G.IDENT_TYPE_ID
AND ((O.TASK_TYPE_ID = 12590) OR (O.TASK_TYPE_ID = 10143 AND NOT EXISTS(SELECT OA3.ORDER_ID FROM OPEN.OR_ORDER_ACTIVITY OA3 WHERE OA3.PACKAGE_ID = P.PACKAGE_ID AND OA3.TASK_TYPE_ID = 12590)))
AND P.REQUEST_DATE >=  TO_DATE(TO_CHAR(&Fechaini,'dd/mm/yyyy') || '00:00:00','dd/mm/yyyy hh24:mi:ss')
AND P.REQUEST_DATE <=  TO_DATE(TO_CHAR(&Fechafin,'dd/mm/yyyy') || '23:59:59','dd/mm/yyyy hh24:mi:ss')
AND NVL(D.GEOGRAP_LOCATION_ID,0) = DECODE({&Departamento}, -1, NVL(D.GEOGRAP_LOCATION_ID,0), {&Departamento})
AND NVL(L.GEOGRAP_LOCATION_ID,0) = DECODE({&Localidad}, -1, NVL(L.GEOGRAP_LOCATION_ID,0), {&Localidad})
AND NVL(B.NEIGHBORTHOOD_ID,0) = DECODE({&Barrio}, -1, NVL(B.NEIGHBORTHOOD_ID,0), {&Barrio})
AND NVL(P.MOTIVE_STATUS_ID,0) = DECODE({&Estado}, -1, NVL(P.MOTIVE_STATUS_ID,0), {&Estado})
AND P.RECEPTION_TYPE_ID = DECODE({&Canal}, -1, P.RECEPTION_TYPE_ID, {&Canal})
AND NVL(DF.SUPPLIER_ID,0) = DECODE({&Proveedor}, -1, NVL(DF.SUPPLIER_ID,0), {&Proveedor})
AND NVL(U.OPERATING_UNIT_ID,0) = DECODE({&UnidProveedor}, -1, NVL(U.OPERATING_UNIT_ID,0), {&UnidProveedor})
AND NVL(CTV.ID_CONTRATISTA,0) = DECODE(&Vendedor, -1, NVL(CTV.ID_CONTRATISTA,0), {&Vendedor})
AND NVL(UV.OPERATING_UNIT_ID,0) = DECODE({&UnidVendedor}, -1, NVL(UV.OPERATING_UNIT_ID,0), {&UnidVendedor})
ORDER BY N_SOLICITUD, ITEM_WORK_ORDER_ID
