-- Internas OSF Legalizadas
select Tipo, product_id, order_id, SESUCATE, CARGCONC, CONCDESC,--0 Reportada, SUM(VALOR) Contabilizar, 
       feg_lega, trunc(fec_conec) fec_conec, SUM(total) TOTAL, 
       CASE WHEN fec_conec < '01-05-2018' THEN
           SUM(total)
         ELSE
           0
           END REPORTADA,
       CASE WHEN fec_conec >= '01-05-2018' OR fec_conec is null THEN
           SUM(total)
         ELSE
           0
           END CONTABILIZAR,
       CASE WHEN nvl(costo, 0) = 0 then
           (select sum(it.value) from open.or_order_items it, open.ge_items git
             where it.order_id = xx.order_id and it.items_id = git.items_id and git.item_classif_id not in (3,8,21))
         ELSE
            sum(costo)
           END t_costo,
       CEBE, LOCA, DESCRIPCION
FROM  (
select 'Int_Osf' Tipo, product_id, order_id, SESUCATE, CARGCONC, CONCDESC, SUM(VALOR) TOTAL, 0 Reportada, SUM(VALOR) Contabilizar, CEBE,
       LOCA, DESCRIPCION
       ,(select sum(gd.valor_total) from open.ge_detalle_acta gd 
         where gd.id_orden = order_id
           and gd.id_items  in (select gi.items_id from open.ge_items gi where gi.items_id = gd.id_items and gi.item_classif_id != 23)) Costo
       ,Feg_Lega
       ,(SELECT h.hcecfech FROM open.hicaesco h WHERE h.hcecnuse = product_id AND hcececan = 96 AND hcececac = 1 AND hcecserv = 7014) fec_conec
  FROM (
select (select l.celocebe
          from open.GE_GEOGRA_LOCATION t, open.ldci_centbenelocal l
         where geograp_location_id = (select GEOGRAP_LOCATION_ID from OPEN.AB_ADDRESS
                                       where address_id = susciddi)
          and t.geo_loca_father_id = l.celodpto
          and t.geograp_location_id = celoloca) CEBE,
       (select GEOGRAP_LOCATION_ID from OPEN.AB_ADDRESS where address_id = susciddi) LOCA,
       (select g.description from open.ge_geogra_location g
         where g.geograp_location_id =  (select GEOGRAP_LOCATION_ID from OPEN.AB_ADDRESS where address_id = susciddi)) DESCRIPCION,
       product_id, order_id, package_type_id, sesucate, sesusuca, cargconc, concdesc, Vr_Unitario Valor, Feg_Lega
  from open.servsusc, open.suscripc,
       (select cargconc, o.concdesc, product_id, m.package_type_id, u.order_id,
               (cargvalo/cargunid) Vr_Unitario, Feg_Lega
          from open.cargos c, open.concepto o, open.mo_packages m,
               (SELECT DISTINCT to_char(mo_packages.package_id) package_id, OR_order_activity.product_id, or_order.order_id, 
                                trunc(OR_order.legalization_date) Feg_Lega
                  FROM open.OR_related_order, open.OR_order_activity, open.or_order, open.mo_packages
                 WHERE OR_related_order.rela_order_type_id in (4, 13) -- Tipo de Orden, de Apoyo o Relacionada
                   AND OR_related_order.related_order_id = or_order.order_id
                   AND or_order.order_id = OR_order_activity.order_id
                   AND OR_order_activity.Status = 'F'
                   AND OR_order_activity.package_id = mo_packages.package_id
                   AND mo_packages.package_type_id in (323)
                   AND or_order.task_type_id in (10622, 10624)
                   --AND OR_order.order_id = OR_related_order.related_order_id
                   --AND OR_order.legalization_date >= '&Fecha_Inicial'         -- FECHA INICIAL
                   --AND OR_order.legalization_date <= '&Fecha_Final 23:59:59'  -- FECHA FINAL
                   AND OR_order.CAUSAL_ID IN (select c.causal_id from open.ge_causal c where c.class_causal_id = 1)
/*                   AND OR_order_activity.product_id not in (SELECT distinct hcecnuse
                                                              FROM open.hicaesco h
                                                             WHERE h.hcecnuse = OR_order_activity.product_id
                                                               AND hcececan = 96
                                                               AND hcececac = 1
                                                               AND hcecserv = 7014
                                                               AND hcecfech < '&Fecha_Inicial')*/
                   AND OR_order_activity.product_id in (51581841,
                                                        51581839,
                                                        51541427,
                                                        51541330,
                                                        51520409,
                                                        51463468,
                                                        51463461,
                                                        51463433,
                                                        51463421,
                                                        51437217,
                                                        51437204,
                                                        51437200,
                                                        51437195,
                                                        51437171,
                                                        51437143,
                                                        51437137,
                                                        51437084,
                                                        51441500,
                                                        51441480,
                                                        51456629,
                                                        51395186,
                                                        51395181,
                                                        51395170,
                                                        51395162,
                                                        51395157,
                                                        51395151,
                                                        51337333,
                                                        51337318,
                                                        51337288,
                                                        51337269,
                                                        51337263,
                                                        51337260,
                                                        51320413,
                                                        51320394,
                                                        51257286,
                                                        51257272,
                                                        51257261,
                                                        51257191,
                                                        51257180,
                                                        51257157,
                                                        51257117,
                                                        51257106,
                                                        51257088,
                                                        51257085,
                                                        51581821,
                                                        51541317,
                                                        51463466,
                                                        51463419,
                                                        51463413,
                                                        51463407,
                                                        51437258,
                                                        51437254,
                                                        51437226,
                                                        51437175,
                                                        51437163,
                                                        51437139,
                                                        51450891,
                                                        51437105,
                                                        51437098,
                                                        51437097,
                                                        51437093,
                                                        51437086,
                                                        51441496,
                                                        51456635,
                                                        51404890,
                                                        51337341,
                                                        51337336,
                                                        51337326,
                                                        51337316,
                                                        51337306,
                                                        51337304,
                                                        51337290,
                                                        51337284,
                                                        51337275,
                                                        51337274,
                                                        51337270,
                                                        51320436,
                                                        51320432,
                                                        51320421,
                                                        51320418,
                                                        51320404,
                                                        51257268,
                                                        51257266,
                                                        51257254,
                                                        51257251,
                                                        51257160,
                                                        51257158,
                                                        51257151,
                                                        51257110,
                                                        51257098,
                                                        51257096,
                                                        51257083,
                                                        51581831,
                                                        51581829,
                                                        51581825,
                                                        51541323,
                                                        51463477,
                                                        51463467,
                                                        51463435,
                                                        51463398,
                                                        51437259,
                                                        51437240,
                                                        51437230,
                                                        51437209,
                                                        51437207,
                                                        51437190,
                                                        51437153,
                                                        51437089,
                                                        51456641,
                                                        51395177,
                                                        51337332,
                                                        51337303,
                                                        51337301,
                                                        51337273,
                                                        51320437,
                                                        51320429,
                                                        51320424,
                                                        51320406,
                                                        51257279,
                                                        51257276,
                                                        51257264,
                                                        51257252,
                                                        51257247,
                                                        51257184,
                                                        51257183,
                                                        51257181,
                                                        51257178,
                                                        51257162,
                                                        51257153,
                                                        51257115,
                                                        51257114,
                                                        51257099,
                                                        51257049,
                                                        51581823,
                                                        51581813,
                                                        51541450,
                                                        51541428,
                                                        51541419,
                                                        51541326,
                                                        51463476,
                                                        51463475,
                                                        51463472,
                                                        51463453,
                                                        51463424,
                                                        51463412,
                                                        51463405,
                                                        51437250,
                                                        51437228,
                                                        51451017,
                                                        51437224,
                                                        51437201,
                                                        51437185,
                                                        51437158,
                                                        51437142,
                                                        51450892,
                                                        51441489,
                                                        51441486,
                                                        51441483,
                                                        51456654,
                                                        51456626,
                                                        51456616,
                                                        51395185,
                                                        51395155,
                                                        51337327,
                                                        51337322,
                                                        51337313,
                                                        51337302,
                                                        51337293,
                                                        51337286,
                                                        51337285,
                                                        51337283,
                                                        51337265,
                                                        51320428,
                                                        51320422,
                                                        51320397,
                                                        51257270,
                                                        51257259,
                                                        51257248,
                                                        51257246,
                                                        51257176,
                                                        51257167,
                                                        51257097,
                                                        51257089,
                                                        51257051,
                                                        51581838,
                                                        51581832,
                                                        51541437,
                                                        51541436,
                                                        51463478,
                                                        51463471,
                                                        51463451,
                                                        51463448,
                                                        51463440,
                                                        51463438,
                                                        51463428,
                                                        51463414,
                                                        51463409,
                                                        51463402,
                                                        51437257,
                                                        51451013,
                                                        51437221,
                                                        51437208,
                                                        51437173,
                                                        51437166,
                                                        51437155,
                                                        51437133,
                                                        51437131,
                                                        51437103,
                                                        51437099,
                                                        51437092,
                                                        51437087,
                                                        51441503,
                                                        51441490,
                                                        51441485,
                                                        51456656,
                                                        51456639,
                                                        51456611,
                                                        51404893,
                                                        51395150,
                                                        51337309,
                                                        51337267,
                                                        51337264,
                                                        51320446,
                                                        51320445,
                                                        51320410,
                                                        51320393,
                                                        51257287,
                                                        51257284,
                                                        51257263,
                                                        51257172,
                                                        51257171,
                                                        51257118,
                                                        51257103,
                                                        51257093,
                                                        51257080,
                                                        51257053,
                                                        51541442,
                                                        51541440,
                                                        51541439,
                                                        51541431,
                                                        51541429,
                                                        51541425,
                                                        51541331,
                                                        51541316,
                                                        51463460,
                                                        51463439,
                                                        51463408,
                                                        51463403,
                                                        51437246,
                                                        51451012,
                                                        51437225,
                                                        51437210,
                                                        51437202,
                                                        51437186,
                                                        51437162,
                                                        51437120,
                                                        51437119,
                                                        51437104,
                                                        51437100,
                                                        51441505,
                                                        51441479,
                                                        51456652,
                                                        51456631,
                                                        51456630,
                                                        51456615,
                                                        51395176,
                                                        51395174,
                                                        51395156,
                                                        51395152,
                                                        51395149,
                                                        51337342,
                                                        51337320,
                                                        51337297,
                                                        51337272,
                                                        51320443,
                                                        51320400,
                                                        51262703,
                                                        51257255,
                                                        51257250,
                                                        51257159,
                                                        51257102,
                                                        51581844,
                                                        51581826,
                                                        51581824,
                                                        51541435,
                                                        51541319,
                                                        51574088,
                                                        51463458,
                                                        51463434,
                                                        51463418,
                                                        51437249,
                                                        51437247,
                                                        51437245,
                                                        51437220,
                                                        51437213,
                                                        51437188,
                                                        51437181,
                                                        51437180,
                                                        51437172,
                                                        51437151,
                                                        51437112,
                                                        51437106,
                                                        51437088,
                                                        51441487,
                                                        51456636,
                                                        51456619,
                                                        51395184,
                                                        51395165,
                                                        51395164,
                                                        51395161,
                                                        51337330,
                                                        51337321,
                                                        51337299,
                                                        51337294,
                                                        51337289,
                                                        51320447,
                                                        51320423,
                                                        51320415,
                                                        51257262,
                                                        51257253,
                                                        51257179,
                                                        51257166,
                                                        51257161,
                                                        51257152,
                                                        51257105,
                                                        51257095,
                                                        51581820,
                                                        51581818,
                                                        51541447,
                                                        51541443,
                                                        51541426,
                                                        51541328,
                                                        51463482,
                                                        51463452,
                                                        51463425,
                                                        51463417,
                                                        51463415,
                                                        51463397,
                                                        51437216,
                                                        51437205,
                                                        51437194,
                                                        51437149,
                                                        51437144,
                                                        51437141,
                                                        51437138,
                                                        51437136,
                                                        51437118,
                                                        51437113,
                                                        51437109,
                                                        51441504,
                                                        51395183,
                                                        51395182,
                                                        51395180,
                                                        51337340,
                                                        51337328,
                                                        51337281,
                                                        51337280,
                                                        51320439,
                                                        51320407,
                                                        51320403,
                                                        51320401,
                                                        51320392,
                                                        51320391,
                                                        51257285,
                                                        51581842,
                                                        51581828,
                                                        51581811,
                                                        51541445,
                                                        51541441,
                                                        51541438,
                                                        51541432,
                                                        51541329,
                                                        51463470,
                                                        51463465,
                                                        51463459,
                                                        51463444,
                                                        51463442,
                                                        51463423,
                                                        51437244,
                                                        51437239,
                                                        51437232,
                                                        51437218,
                                                        51437206,
                                                        51437199,
                                                        51437192,
                                                        51437161,
                                                        51441482,
                                                        51441481,
                                                        51456655,
                                                        51456647,
                                                        51456645,
                                                        51456624,
                                                        51456610,
                                                        51404892,
                                                        51395178,
                                                        51395173,
                                                        51395166,
                                                        51395154,
                                                        51337298,
                                                        51337292,
                                                        51337291,
                                                        51337276,
                                                        51417069,
                                                        51320450,
                                                        51320442,
                                                        51320438,
                                                        51320434,
                                                        51320420,
                                                        51257280,
                                                        51257269,
                                                        51257249,
                                                        51257169,
                                                        51257165,
                                                        51257101,
                                                        51257082,
                                                        51581843,
                                                        51581840,
                                                        51541449,
                                                        51541448,
                                                        51541418,
                                                        51520408,
                                                        51463455,
                                                        51463443,
                                                        51463430,
                                                        51463422,
                                                        51463416,
                                                        51463404,
                                                        51437255,
                                                        51437252,
                                                        51437251,
                                                        51437233,
                                                        51437231,
                                                        51451014,
                                                        51437219,
                                                        51437196,
                                                        51437193,
                                                        51437189,
                                                        51437183,
                                                        51437179,
                                                        51437167,
                                                        51437164,
                                                        51437157,
                                                        51437134,
                                                        51437124,
                                                        51437122,
                                                        51437108,
                                                        51441497,
                                                        51456651,
                                                        51456643,
                                                        51456640,
                                                        51456638,
                                                        51456637,
                                                        51456628,
                                                        51456625,
                                                        51456623,
                                                        51456618,
                                                        51456613,
                                                        51337310,
                                                        51337308,
                                                        51337278,
                                                        51337271,
                                                        51337268,
                                                        51337261,
                                                        51320440,
                                                        51320426,
                                                        51320412,
                                                        51257283,
                                                        51257190,
                                                        51257188,
                                                        51257168,
                                                        51257156,
                                                        51257107,
                                                        51257084,
                                                        51581819,
                                                        51581815,
                                                        51581814,
                                                        51581812,
                                                        51541423,
                                                        51541417,
                                                        51541324,
                                                        51512275,
                                                        51463481,
                                                        51463446,
                                                        51463445,
                                                        51463429,
                                                        51463426,
                                                        51437229,
                                                        51437227,
                                                        51437223,
                                                        51437170,
                                                        51437160,
                                                        51437159,
                                                        51437156,
                                                        51437154,
                                                        51437148,
                                                        51437146,
                                                        51437132,
                                                        51437128,
                                                        51437116,
                                                        51437110,
                                                        51441506,
                                                        51441498,
                                                        51441484,
                                                        51456644,
                                                        51456642,
                                                        51456633,
                                                        51456627,
                                                        51404891,
                                                        51404889,
                                                        51395187,
                                                        51395179,
                                                        51393990,
                                                        51337337,
                                                        51337319,
                                                        51337262,
                                                        51320427,
                                                        51320425,
                                                        51320419,
                                                        51320416,
                                                        51320408,
                                                        51257271,
                                                        51257267,
                                                        51257163,
                                                        51257081,
                                                        51581836,
                                                        51581835,
                                                        51581833,
                                                        51541421,
                                                        51541327,
                                                        51541322,
                                                        51541321,
                                                        51463474,
                                                        51463464,
                                                        51463456,
                                                        51463450,
                                                        51463447,
                                                        51463427,
                                                        51463406,
                                                        51437242,
                                                        51451015,
                                                        51437222,
                                                        51437197,
                                                        51437187,
                                                        51437168,
                                                        51437165,
                                                        51437145,
                                                        51437121,
                                                        51437114,
                                                        51437111,
                                                        51437107,
                                                        51437102,
                                                        51437095,
                                                        51437094,
                                                        51437091,
                                                        51437090,
                                                        51441502,
                                                        51441478,
                                                        51456648,
                                                        51456632,
                                                        51456622,
                                                        51456614,
                                                        51395175,
                                                        51395160,
                                                        51395159,
                                                        51395158,
                                                        51337307,
                                                        51320451,
                                                        51320435,
                                                        51320414,
                                                        51320411,
                                                        51320402,
                                                        51257278,
                                                        51257265,
                                                        51257260,
                                                        51257258,
                                                        51257186,
                                                        51257185,
                                                        51257177,
                                                        51257155,
                                                        51257116,
                                                        51257100,
                                                        51581837,
                                                        51581830,
                                                        51541446,
                                                        51463473,
                                                        51463457,
                                                        51463454,
                                                        51463431,
                                                        51463411,
                                                        51463410,
                                                        51463401,
                                                        51463400,
                                                        51437256,
                                                        51437203,
                                                        51437191,
                                                        51437178,
                                                        51437130,
                                                        51437125,
                                                        51441508,
                                                        51441499,
                                                        51441492,
                                                        51456657,
                                                        51456617,
                                                        51456612,
                                                        51405349,
                                                        51395172,
                                                        51395167,
                                                        51337331,
                                                        51337315,
                                                        51337287,
                                                        51337277,
                                                        51337266,
                                                        51320430,
                                                        51320399,
                                                        51320398,
                                                        51320396,
                                                        51257256,
                                                        51257189,
                                                        51257164,
                                                        51257113,
                                                        51257108,
                                                        51257052,
                                                        51257050,
                                                        51257046,
                                                        51581834,
                                                        51581816,
                                                        51541444,
                                                        51541422,
                                                        51463479,
                                                        51463449,
                                                        51463437,
                                                        51463436,
                                                        51463432,
                                                        51463395,
                                                        51437253,
                                                        51437248,
                                                        51437215,
                                                        51437214,
                                                        51437198,
                                                        51437169,
                                                        51437140,
                                                        51437126,
                                                        51437123,
                                                        51437117,
                                                        51437096,
                                                        51437085,
                                                        51441495,
                                                        51441494,
                                                        51441493,
                                                        51456646,
                                                        51456621,
                                                        51395168,
                                                        51395153,
                                                        51337343,
                                                        51337338,
                                                        51337334,
                                                        51337329,
                                                        51337317,
                                                        51337314,
                                                        51337311,
                                                        51337279,
                                                        51320448,
                                                        51320444,
                                                        51320431,
                                                        51257282,
                                                        51257275,
                                                        51257273,
                                                        51257119,
                                                        51257112,
                                                        51257111,
                                                        51257092,
                                                        51257091,
                                                        51257090,
                                                        51257047,
                                                        51581827,
                                                        51581822,
                                                        51581809,
                                                        51541430,
                                                        51541420,
                                                        51463462,
                                                        51463441,
                                                        51463420,
                                                        51463396,
                                                        51437236,
                                                        51437234,
                                                        51437177,
                                                        51437152,
                                                        51441501,
                                                        51441491,
                                                        51441488,
                                                        51456649,
                                                        51395169,
                                                        51337339,
                                                        51337324,
                                                        51337323,
                                                        51337312,
                                                        51337300,
                                                        51337296,
                                                        51337282,
                                                        51320417,
                                                        51257281,
                                                        51257277,
                                                        51257245,
                                                        51257182,
                                                        51257175,
                                                        51257173,
                                                        51257154,
                                                        51257087,
                                                        51257086,
                                                        51581817,
                                                        51581810,
                                                        51541424,
                                                        51541325,
                                                        51541320,
                                                        51541318,
                                                        51463480,
                                                        51463469,
                                                        51463463,
                                                        51463399,
                                                        51437243,
                                                        51437241,
                                                        51437238,
                                                        51437237,
                                                        51437235,
                                                        51437212,
                                                        51437211,
                                                        51437184,
                                                        51437182,
                                                        51437176,
                                                        51437174,
                                                        51437150,
                                                        51437147,
                                                        51437135,
                                                        51437129,
                                                        51437127,
                                                        51437115,
                                                        51450889,
                                                        51437101,
                                                        51441509,
                                                        51441507,
                                                        51456653,
                                                        51456650,
                                                        51456634,
                                                        51456620,
                                                        51395188,
                                                        51395171,
                                                        51395163,
                                                        51337344,
                                                        51337325,
                                                        51337305,
                                                        51337259,
                                                        51381915,
                                                        51320449,
                                                        51320441,
                                                        51320433,
                                                        51320409,
                                                        51320405,
                                                        51320395,
                                                        51257274,
                                                        51257257,
                                                        51257187,
                                                        51257174,
                                                        51257170,
                                                        51257109,
                                                        51257104,
                                                        51257094,
                                                        51257048)
               ) u
         where cargconc in (30, 291)
           and cargconc = o.conccodi
           and cargdoso = 'PP-'||u.package_id
           and u.package_id = m.package_id)
  where sesunuse = product_id
    and sesususc = susccodi
 )
GROUP BY CEBE, LOCA, DESCRIPCION, product_id, SESUCATE, SESUSUCA, CARGCONC, package_type_id, CONCDESC, order_id, Feg_Lega
) XX GROUP BY Tipo, product_id, order_id, SESUCATE, CARGCONC, CONCDESC, fec_conec, feg_lega, CEBE, LOCA, DESCRIPCION, costo
