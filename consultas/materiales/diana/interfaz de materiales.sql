SELECT OT.ORDER_ID NUMERO_ORDEN, 
      (SELECT CUCTCODI||'-'||CUCTDESC FROM OPEN.LDCI_CUENTACONTABLE WHERE CUCTCODI=OPEN.LDCI_PKINTERFAZACTAS.FVAGETCUGACOCLASI(O.ORDER_ID)) CUENTA,
       DECODE(SIGN(SUM(OT.VALUE)), 1, 'D', 'C') SIGNOS,
       ABS(SUM(DECODE(O.CHARGE_STATUS,
                      3,
                      (OT.VALUE),
                      ((OT.VALUE ))))) VALOR,
       ABS(SUM(DECODE(O.CHARGE_STATUS,
                      3,
                      (0),
                      (((OT.VALUE * 0.16)))))) IVA,
      (SELECT GEO_LOCA_FATHER_ID
         FROM OPEN.GE_GEOGRA_LOCATION
        WHERE GEOGRAP_LOCATION_ID = AD.GEOGRAP_LOCATION_ID) DEPTO,
      (SELECT L.GEOGRAP_LOCATION_ID||'-'||L.DESCRIPTION FROM OPEN.GE_GEOGRA_LOCATION L WHERE L.GEOGRAP_LOCATION_ID=AD.GEOGRAP_LOCATION_ID)  LOCALIDAD,
       TT.TASK_TYPE_ID||'-'||TT.DESCRIPTION TIPOTRABAJO,
       (SELECT CL.TASK_CLASS_ID||'-'||CL.DESCRIPTION FROM  OPEN.GE_TASK_CLASS  CL WHERE TASK_CLASS_ID=TT.TASK_TYPE_CLASSIF) CLASIFICADOR_TIPOTRABAJO,
       GI.ITEM_CLASSIF_ID ,
       OT.ITEMS_ID ITEM,
      (SELECT DESCRIPTION FROM OPEN.GE_ITEMS WHERE ITEMS_ID = OT.ITEMS_ID) DESCRITEM,
       (SELECT CLCOCODI||'-'||CLCODESC FROM OPEN.IC_CLASCONT
         WHERE CLCOCODI=OPEN.LDCI_PKINTERFAZACTAS.FVAGETCLASIFI(TT.TASK_TYPE_ID)) CLASIFICADOR_CONTABLE,
       O.CHARGE_STATUS ESTADO,
       OU.OPERATING_UNIT_ID,
       OU.NAME,
       NVL(OPEN.LDCI_PKINTERFAZSAP.FVAGETCEBENOCAT(AD.GEOGRAP_LOCATION_ID),0) CENTRO_BENE,
      (SELECT CODIGO_ACTIVO||SUBNUMERO||'-'||TEXTO_BREVE FROM OPEN.LDCI_ACTIUBGTTRA,OPEN.LDCI_ACTIVOENCURSO
        WHERE ACBGDPTO = (SELECT GEO_LOCA_FATHER_ID FROM OPEN.GE_GEOGRA_LOCATION WHERE GEOGRAP_LOCATION_ID = AD.GEOGRAP_LOCATION_ID)
          AND ACBGLOCA = AD.GEOGRAP_LOCATION_ID
          AND ACBGTITR = TT.TASK_TYPE_ID
		  AND ACBGACTI = CODIGO_ACTIVO
		  AND ACBGSUBN = SUBNUMERO
		  AND ROWNUM = 1 )COD_ACTIVO,
      (SELECT CECOCODI||'-'||CECODESC  FROM OPEN.LDCI_CECOUBIGETRA, OPEN.LDCI_CENTROCOSTO
        WHERE CCBGDPTO = (SELECT GEO_LOCA_FATHER_ID FROM OPEN.GE_GEOGRA_LOCATION WHERE GEOGRAP_LOCATION_ID = AD.GEOGRAP_LOCATION_ID)
          AND CCBGLOCA = AD.GEOGRAP_LOCATION_ID
          AND CCBGTITR = TT.TASK_TYPE_ID
          AND CCBGCECO=CECOCODI) CECO,
       CASE
          WHEN ','||',245,413,414,314,'||',' LIKE '%,' ||OPEN.LDCI_PKINTERFAZACTAS.FVAGETCLASIFI(TT.TASK_TYPE_ID)|| ',%' THEN
            (SELECT CODI_ORDEINTERNA||'-'||DESC_ORDEINTERNA FROM OPEN.LDCI_ACTIUBGTTRA, OPEN.LDCI_ORDENINTERNA
              WHERE ACBGDPTO = (SELECT GEO_LOCA_FATHER_ID FROM OPEN.GE_GEOGRA_LOCATION WHERE GEOGRAP_LOCATION_ID = AD.GEOGRAP_LOCATION_ID)
                AND ACBGLOCA = AD.GEOGRAP_LOCATION_ID
                AND ACBGTITR = TT.TASK_TYPE_ID
                AND ACBGORIN = CODI_ORDEINTERNA
                AND ROWNUM = 1 )           
          ELSE
            (SELECT CODI_ORDEINTERNA||'-'||DESC_ORDEINTERNA FROM OPEN.LDCI_CECOUBIGETRA, OPEN.LDCI_ORDENINTERNA
              WHERE CCBGDPTO = (SELECT GEO_LOCA_FATHER_ID FROM OPEN.GE_GEOGRA_LOCATION WHERE GEOGRAP_LOCATION_ID = AD.GEOGRAP_LOCATION_ID)
                AND CCBGLOCA = AD.GEOGRAP_LOCATION_ID
                AND CCBGTITR = TT.TASK_TYPE_ID
                AND CCBGORIN = CODI_ORDEINTERNA)
          END ORD_INTERNA,
          ORAC.PRODUCT_ID,
          (SELECT CATECODI||'-'||CATEDESC
          FROM OPEN.CATEGORI, OPEN.PR_PRODUCT
          WHERE CATECODI=CATEGORY_ID
           AND PRODUCT_ID=ORAC.PRODUCT_ID) CATEGORIA
  FROM OPEN.OR_ORDER          O,
       OPEN.OR_ORDER_ITEMS    OT,
       OPEN.GE_ITEMS          GI,
       OPEN.OR_ORDER_ACTIVITY ORAC,
       OPEN.AB_ADDRESS        AD,
       OPEN.OR_OPERATING_UNIT OU,
	   OPEN.OR_TASK_TYPE TT
 WHERE TRUNC(O.LEGALIZATION_DATE) BETWEEN (&fechaini) AND (&fechafin)
   AND OT.ORDER_ID = O.ORDER_ID
   AND OT.VALUE <> 0
   AND GI.ITEMS_ID = OT.ITEMS_ID
   AND GI.ITEM_CLASSIF_ID IN
       (SELECT item_classif_id
	      FROM OPEN.ge_item_classif
		 WHERE ',' || (SELECT casevalo FROM OPEN.ldci_carasewe                
						WHERE casecodi = 'MATERIHERRA') || ',' LIKE '%,' || item_classif_id || ',%')
   AND O.ORDER_ID = ORAC.ORDER_ID
   AND ORAC.ADDRESS_ID = AD.ADDRESS_ID
   AND OU.OPERATING_UNIT_ID = O.OPERATING_UNIT_ID
   AND TT.TASK_TYPE_ID=DECODE(OPEN.LDCI_PKINTERFAZACTAS.FNUGETTIPOTRAB(O.ORDER_ID),
                 0,
				 O.TASK_TYPE_ID,
				 OPEN.LDCI_PKINTERFAZACTAS.FNUGETTIPOTRAB(O.ORDER_ID))
 GROUP BY OT.ORDER_ID,
          OPEN.LDCI_PKINTERFAZACTAS.FVAGETCUGACOCLASI(O.ORDER_ID),
          AD.GEOGRAP_LOCATION_ID,
          TT.TASK_TYPE_ID,
          OT.ITEMS_ID,
          GI.ITEM_CLASSIF_ID,
          OPEN.LDCI_PKINTERFAZACTAS.FVAGETCLASIFI(O.TASK_TYPE_ID),
          OT.ITEMS_ID,
          O.CHARGE_STATUS,
          O.ORDER_ID,
          OU.OPERATING_UNIT_ID,
          OU.NAME,
          ORAC.PRODUCT_ID,
          TT.DESCRIPTION,
          TT.TASK_TYPE_CLASSIF
          ORDER BY OT.ORDER_ID