SELECT O.TASK_TYPE_ID,(select T.WAREHOUSE_TYPE from OPEN.LDC_TT_TB T where T.TASK_TYPE_ID=O.TASK_TYPE_ID),  SUM(OI.VALUE)
FROM OPEN.OR_ORDER O, OPEN.OR_ORDER_ITEMS OI, OPEN.GE_ITEMS I
WHERE O.ORDER_ID=OI.ORDER_ID
 AND I.ITEMS_ID=OI.ITEMS_ID
 AND I.ITEM_CLASSIF_ID IN (3,8,21)
 AND O.LEGALIZATION_DATE>='01/DEC/2015'
 AND O.LEGALIZATION_DATE<'01/JAN/2016'
 GROUP BY O.TASK_TYPE_ID;

SELECT *--M.ITEM_MOVEME_CAUS_ID,C.DESCRIPTION, M.MOVEMENT_TYPE,D.DOCUMENT_TYPE_ID, SUM(AMOUNT),SUM(TOTAL_VALUE)
FROM OPEN.OR_UNI_ITEM_BALA_MOV M, OPEN.GE_ITEMS_DOCUMENTO D , OPEN.OR_ITEM_MOVEME_CAUS C
WHERE M.MOVE_DATE>='01/DEC/2015'
  AND M.MOVE_DATE<'01/JAN/2016'
  AND M.MOVEMENT_TYPE IN ('D','I')
  AND M.ID_ITEMS_DOCUMENTO=D.ID_ITEMS_DOCUMENTO(+)
  AND M.ITEM_MOVEME_CAUS_ID=C.ITEM_MOVEME_CAUS_ID
  AND M.ITEM_MOVEME_CAUS_ID=16
  AND M.ID_ITEMS_DOCUMENTO=138661;
  --GROUP BY M.ITEM_MOVEME_CAUS_ID,C.DESCRIPTION, M.MOVEMENT_TYPE,D.DOCUMENT_TYPE_ID;
  
  SELECT  --M.ITEM_MOVEME_CAUS_ID,C.DESCRIPTION, M.MOVEMENT_TYPE,D.DOCUMENT_TYPE_ID, SUM(AMOUNT),SUM(TOTAL_VALUE)
        TO_CHAR(M2.MOVE_DATE,'MM/YYYY') MES_TRASLADO, M2.ITEM_MOVEME_CAUS_ID CAUSAL_TRASLADO, SUM(M2.AMOUNT) CANT_TRASLADO,SUM(M2.TOTAL_VALUE) VALOR_TRASLADO,
        TO_CHAR(M.MOVE_DATE,'MM/YYYY') MES_ACEPT, M.ITEM_MOVEME_CAUS_ID CAUSAL_ACEPT, SUM(M.AMOUNT) CANT_ACEPT,SUM(M.TOTAL_VALUE) VALOR_ACEPT
FROM OPEN.OR_UNI_ITEM_BALA_MOV M, OPEN.OR_ITEM_MOVEME_CAUS C, OPEN.GE_ITEMS_DOC_REL R,OPEN.OR_UNI_ITEM_BALA_MOV M2 
WHERE /*M.MOVE_DATE>='01/DEC/2015'
  AND M.MOVE_DATE<'01/JAN/2016'
  AND */M.MOVEMENT_TYPE IN ('D','I')
  AND M.ITEM_MOVEME_CAUS_ID=C.ITEM_MOVEME_CAUS_ID
  AND M.ITEM_MOVEME_CAUS_ID=16
  AND M.ID_ITEMS_DOCUMENTO=R.ID_ITEMS_DOC_ORIGEN
  AND M2.ID_ITEMS_DOCUMENTO=R.ID_ITEMS_DOC_DESTINO
/*  AND M2.MOVE_DATE>='01/FEB/2015'
  AND M2.MOVE_DATE<='01/MAR/2015'*/
  AND M2.MOVEMENT_TYPE='D'
  AND M2.ITEMS_ID=M.ITEMS_ID
--  AND M.ID_ITEMS_DOCUMENTO IN (/*52919,*/ 52937, 52958)
  AND NVL(M2.ID_ITEMS_SERIADO,0)=NVL(M.ID_ITEMS_SERIADO,0)
  GROUP BY
  TO_CHAR(M2.MOVE_DATE,'MM/YYYY'), M2.ITEM_MOVEME_CAUS_ID,
  TO_CHAR(M.MOVE_DATE,'MM/YYYY') , M.ITEM_MOVEME_CAUS_ID
  UNION  
 select  /*+ leading(or_uni_item_bala_mov)
           index(or_uni_item_bala_mov IDX_OR_UNI_ITEM_BALA_MOV01)
           index(ge_items_seriado PK_GE_ITEMS_SERIADO)
           index(ge_items PK_GE_ITEMS)
           index(ge_items_documento PK_GE_ITEMS_DOCUMENTO)*/
         TO_CHAR(M2.MOVE_DATE,'MM/YYYY') MES_TRASLADO, M2.ITEM_MOVEME_CAUS_ID CAUSAL_TRASLADO, SUM(M2.AMOUNT) CANT_TRASLADO,SUM(M2.TOTAL_VALUE) VALOR_TRASLADO,
        NULL MES_ACEPT, NULL CAUSAL_ACEPT, 0 CANT_ACEPT,0 VALOR_ACEPT
  from  OPEN.OR_UNI_ITEM_BALA_MOV M2,
        OPEN.OR_OPE_UNI_ITEM_BALA,
        OPEN.GE_ITEMS_SERIADO,
        OPEN.GE_ITEMS,
        OPEN.GE_ITEMS_DOCUMENTO
 where  M2.ITEMS_ID = GE_ITEMS.ITEMS_ID
   and  M2.ITEMS_ID = OR_OPE_UNI_ITEM_BALA.ITEMS_ID
   and  M2.OPERATING_UNIT_ID = OR_OPE_UNI_ITEM_BALA.OPERATING_UNIT_ID
   and  M2.MOVEMENT_TYPE = 'N' --or_boitemsmove.csbNeutralMoveType
   and  M2.ID_ITEMS_DOCUMENTO = GE_ITEMS_DOCUMENTO.ID_ITEMS_DOCUMENTO
   and  M2.SUPPORT_DOCUMENT = ' '
   and  M2.ID_ITEMS_SERIADO = GE_ITEMS_SERIADO.ID_ITEMS_SERIADO (+)
   GROUP BY
  TO_CHAR(M2.MOVE_DATE,'MM/YYYY'), M2.ITEM_MOVEME_CAUS_ID;
  
  
SELECT *
FROM OPEN.GE_ITEMS_DOC_REL
where id_items_doc_destino=30139;

SELECT id_items_doc_destino,count(DISTINCT id_items_doc_origen)
FROM OPEN.GE_ITEMS_DOC_REL, OPEN.OR_UNI_ITEM_BALA_MOV M
where id_items_doc_destino!=id_items_doc_origen
  AND M.ID_ITEMS_DOCUMENTO=id_items_doc_destino
  AND M.ID_ITEMS_SERIADO IS NULL
  AND EXISTS(SELECT P.ITEMS_ID, COUNT(*) FROM OPEN.OR_UNI_ITEM_BALA_MOV P WHERE P.ID_ITEMS_DOCUMENTO=id_items_doc_origen GROUP BY P.ITEMS_ID)
having count(DISTINCT id_items_doc_origen)>1
group by id_items_doc_destino;

select *
from open.or_uni_item_bala_mov
where id_items_documento in (85361, 85359, 85360);

select *
from open.or_uni_item_bala_mov
where id_items_seriado in (1998223 , 1998231)



SELECT FECHA,
       SUM(CANT_D),
       SUM(VALOR_D),
       SUM(CANT_I),
       SUM(VALOR_I)
FROM (
SELECT --MO.ITEM_MOVEME_CAUS_ID,
       --MO.ID_ITEMS_DOCUMENTO ,
       --MO.SUPPORT_DOCUMENT,
       --MO.OPERATING_UNIT_ID,
       --MO.TARGET_OPER_UNIT_ID,
       --ITEMS_ID, 
       --OP.OPER_UNIT_CLASSIF_ID,
       --PR.OPER_UNIT_CLASSIF_ID, 
       TO_CHAR(MOVE_DATE,'MM/YYYY') FECHA,
       SUM(DECODE(MO.MOVEMENT_TYPE,'D',AMOUNT,0)) CANT_D,SUM(DECODE(MO.MOVEMENT_TYPE,'D',MO.TOTAL_VALUE,0)) VALOR_D,
       CASE
         WHEN PR.OPER_UNIT_CLASSIF_ID=11 THEN
           NVL((SELECT SUM(D.DMITCANT ) FROM OPEN.LDCI_INTEMMIT I, OPEN.LDCI_DMITMMIT D WHERE MMITCODI=DMITMMIT AND MMITNUDO=TO_CHAR(MO.ID_ITEMS_DOCUMENTO) AND MMITDSAP IS NOT NULL AND MMITESTA=2 AND MMITNATU='-'),0)
         ELSE
           SUM(DECODE(MO.MOVEMENT_TYPE,'I',AMOUNT,0)) 
        END CANT_I,
      CASE
         WHEN PR.OPER_UNIT_CLASSIF_ID=11 THEN
           NVL((SELECT SUM(D.DMITCANT*DMITCOUN ) FROM OPEN.LDCI_INTEMMIT I, OPEN.LDCI_DMITMMIT D WHERE MMITCODI=DMITMMIT AND MMITNUDO=TO_CHAR(MO.ID_ITEMS_DOCUMENTO) AND MMITDSAP IS NOT NULL AND MMITESTA=2 AND MMITNATU='-'),0)
         ELSE
           SUM(DECODE(MO.MOVEMENT_TYPE,'I',MO.TOTAL_VALUE,0)) 
       END VALOR_I,
       SUM(DECODE(MO.MOVEMENT_TYPE,'N',DECODE(OP.OPER_UNIT_CLASSIF_ID,11,DECODE(MO.SUPPORT_DOCUMENT,' ',AMOUNT,0),0),0)) CANT_N1, 
       SUM(DECODE(MO.MOVEMENT_TYPE,'N',DECODE(OP.OPER_UNIT_CLASSIF_ID,11,DECODE(MO.SUPPORT_DOCUMENT,' ',MO.TOTAL_VALUE,0),0),0)) VALOR_N1,
       SUM(DECODE(MO.MOVEMENT_TYPE,'N',DECODE(OP.OPER_UNIT_CLASSIF_ID,11,0,DECODE(MO.SUPPORT_DOCUMENT,' ', 0, AMOUNT)),0)) CANT_N2,
       SUM(DECODE(MO.MOVEMENT_TYPE,'N',DECODE(OP.OPER_UNIT_CLASSIF_ID,11,0,DECODE(MO.SUPPORT_DOCUMENT,' ', 0, MO.TOTAL_VALUE)),0)) VALOR_N2 
FROM OPEN.OR_UNI_ITEM_BALA_MOV MO, OPEN.OR_OPERATING_UNIT OP, OPEN.OR_OPERATING_UNIT PR
WHERE/* ((EXISTS(SELECT NULL FROM OPEN.GE_ITEMS_DOC_REL RT, OPEN.GE_ITEMS_DOCUMENTO DT  WHERE MO.ID_ITEMS_DOCUMENTO=RT.ID_ITEMS_DOC_ORIGEN AND RT.ID_ITEMS_DOC_ORIGEN=DT.ID_ITEMS_DOCUMENTO AND DT.DOCUMENT_TYPE_ID=105) AND MO.ITEM_MOVEME_CAUS_ID=20) OR
       (EXISTS(SELECT NULL FROM OPEN.GE_ITEMS_DOC_REL RC, OPEN.GE_ITEMS_DOCUMENTO DC  WHERE MO.ID_ITEMS_DOCUMENTO=RC.ID_ITEMS_DOC_ORIGEN AND RC.ID_ITEMS_DOC_DESTINO=DC.ID_ITEMS_DOCUMENTO AND DC.DOCUMENT_TYPE_ID=105) AND MO.ITEM_MOVEME_CAUS_ID IN (16,17)))
   --AND MO.ID_ITEMS_DOCUMENTO IN (41856,47545,53105,53371,55347,55349,60515,64761,68288,68346,68809,69324,69357,71675,71981,72854,73870,73879,73883,73935,74202,74209)
  AND */EXISTS(SELECT NULL FROM OPEN.GE_ITEMS_DOCUMENTO D WHERE D.ID_ITEMS_DOCUMENTO = MO.ID_ITEMS_DOCUMENTO AND D.DOCUMENT_TYPE_ID IN (105,103))
  AND MO.OPERATING_UNIT_ID=OP.OPERATING_UNIT_ID
  --AND (OP.OPER_UNIT_CLASSIF_ID=11 OR PR.OPER_UNIT_CLASSIF_ID=11)
  AND MO.TARGET_OPER_UNIT_ID=PR.OPERATING_UNIT_ID
 --AND MO.ID_ITEMS_DOCUMENTO IN (47545)
 AND MO.MOVEMENT_TYPE IN ('D'/*,'I'*/)
  AND MOVE_DATE>='01/FEB/2015'
      GROUP BY /*MO.ITEM_MOVEME_CAUS_ID--,*/ TO_CHAR(MOVE_DATE,'MM/YYYY'), PR.OPER_UNIT_CLASSIF_ID, MO.ID_ITEMS_DOCUMENTO--, PR.OPER_UNIT_CLASSIF_ID,MO.OPERATING_UNIT_ID,  MO.TARGET_OPER_UNIT_ID, ITEMS_ID--, MO.SUPPORT_DOCUMENT, OP.OPER_UNIT_CLASSIF_ID, PR.OPER_UNIT_CLASSIF_ID
       )
       GROUP BY FECHA
       ORDER BY 1        ;
